<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股K線圖查詢系統</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .header {
            background: white;
            color: #2c3e50;
            padding: 32px 24px;
            border-bottom: 1px solid #e8eaed;
        }

        .header h1 {
            font-size: 1.75em;
            margin-bottom: 6px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .header p {
            font-size: 0.95em;
            color: #5f6368;
        }

        .controls {
            padding: 24px;
            background: #fafbfc;
            border-bottom: 1px solid #e8eaed;
        }

        .control-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .control-group {
            flex: 1;
            min-width: 240px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #3c4043;
            font-size: 0.9em;
        }

        .control-group input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 0.95em;
            transition: all 0.2s;
            background: white;
        }

        .control-group input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }

        .btn {
            padding: 10px 24px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #1557b0;
        }

        .btn:active {
            background: #0d47a1;
        }

        .btn:disabled {
            background: #dadce0;
            color: #5f6368;
            cursor: not-allowed;
        }

        .stock-info {
            padding: 20px 24px;
            background: white;
            border-bottom: 1px solid #e8eaed;
            display: none;
        }

        .stock-info.active {
            display: block;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .info-item {
            padding: 14px;
            background: #fafbfc;
            border: 1px solid #e8eaed;
            border-radius: 6px;
            text-align: center;
        }

        .info-label {
            font-size: 0.8em;
            color: #5f6368;
            margin-bottom: 6px;
            font-weight: 400;
        }

        .info-value {
            font-size: 1.15em;
            font-weight: 600;
            color: #1a1a1a;
        }

        .info-value.positive {
            color: #d93025;
        }

        .info-value.negative {
            color: #0f9d58;
        }

        #chartContainer {
            padding: 24px;
        }

        #candlestickChart {
            width: 100%;
            height: 540px;
        }

        .loading {
            text-align: center;
            padding: 48px;
            color: #5f6368;
            font-size: 0.95em;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% {
                content: '.';
            }
            40% {
                content: '..';
            }
            60%, 100% {
                content: '...';
            }
        }

        .error {
            background: #fce8e6;
            color: #c5221f;
            padding: 16px 20px;
            margin: 24px;
            border-radius: 6px;
            border-left: 3px solid #d93025;
            font-size: 0.9em;
        }

        .quick-stocks {
            display: flex;
            gap: 8px;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        .quick-stock-btn {
            padding: 7px 14px;
            background: white;
            color: #5f6368;
            border: 1px solid #dadce0;
            border-radius: 16px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-stock-btn:hover {
            background: #f1f3f4;
            border-color: #1a73e8;
            color: #1a73e8;
        }

        /* 技術分析面板樣式 */
        .analysis-panel {
            margin: 16px 24px;
            background: white;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            overflow: hidden;
        }

        .analysis-panel.active {
            display: block;
        }

        .analysis-header {
            background: #f8f9fa;
            color: #1a1a1a;
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e8eaed;
        }

        .analysis-header h3 {
            margin: 0;
            font-size: 1.05em;
            font-weight: 600;
        }

        .analysis-toggle {
            cursor: pointer;
            padding: 4px 10px;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 0.85em;
            color: #5f6368;
            transition: all 0.2s;
        }

        .analysis-toggle:hover {
            background: #f1f3f4;
            border-color: #1a73e8;
            color: #1a73e8;
        }

        .analysis-summary {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 16px;
            padding: 18px;
        }

        .recommendation-box {
            background: #fafbfc;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            padding: 18px;
            text-align: center;
        }

        .recommendation-label {
            font-size: 0.85em;
            color: #5f6368;
            margin-bottom: 10px;
            font-weight: 400;
        }

        .recommendation-value {
            font-size: 2em;
            font-weight: 600;
            margin: 12px 0;
        }

        .recommendation-value.buy {
            color: #d93025;
        }

        .recommendation-value.sell {
            color: #0f9d58;
        }

        .recommendation-value.wait {
            color: #5f6368;
        }

        .confidence-bar {
            width: 100%;
            height: 6px;
            background: #e8eaed;
            border-radius: 3px;
            overflow: hidden;
            margin: 12px 0;
        }

        .confidence-fill {
            height: 100%;
            background: #1a73e8;
            transition: width 0.4s ease;
        }

        .confidence-text {
            font-size: 0.8em;
            color: #5f6368;
            margin-top: 6px;
        }

        .signals-summary {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .signal-item {
            background: #fafbfc;
            padding: 12px 14px;
            border-radius: 6px;
            border-left: 3px solid #dadce0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .signal-item.buy {
            border-left-color: #d93025;
            background: #fce8e6;
        }

        .signal-item.sell {
            border-left-color: #0f9d58;
            background: #e6f4ea;
        }

        .signal-type {
            font-weight: 500;
            color: #1a1a1a;
            font-size: 0.9em;
        }

        .signal-description {
            font-size: 0.85em;
            color: #5f6368;
            margin-top: 4px;
        }

        .signal-strength {
            display: flex;
            gap: 3px;
        }

        .signal-strength span {
            width: 6px;
            height: 18px;
            background: #dadce0;
            border-radius: 2px;
        }

        .signal-strength span.active {
            background: #1a73e8;
        }

        .analysis-detail {
            padding: 18px;
            border-top: 1px solid #e8eaed;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .indicator-item {
            background: #fafbfc;
            border: 1px solid #e8eaed;
            padding: 14px;
            border-radius: 6px;
            text-align: center;
        }

        .indicator-label {
            font-size: 0.8em;
            color: #5f6368;
            margin-bottom: 6px;
            font-weight: 400;
        }

        .indicator-value {
            font-size: 1.3em;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .indicator-desc {
            font-size: 0.75em;
            color: #5f6368;
            line-height: 1.5;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e8eaed;
            text-align: left;
        }

        .analysis-text {
            background: #fafbfc;
            border: 1px solid #e8eaed;
            padding: 16px;
            border-radius: 6px;
            line-height: 1.7;
            white-space: pre-wrap;
            color: #3c4043;
            font-size: 0.9em;
        }

        /* 股票分析四大面向 */
        .education-panel {
            margin: 16px 24px;
            background: white;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            overflow: hidden;
        }

        .education-header {
            background: #f8f9fa;
            color: #1a1a1a;
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            border-bottom: 1px solid #e8eaed;
            transition: all 0.2s;
        }

        .education-header:hover {
            background: #f1f3f4;
        }

        .education-header h3 {
            margin: 0;
            font-size: 1.05em;
            font-weight: 600;
        }

        .education-toggle {
            padding: 4px 10px;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 0.85em;
            color: #5f6368;
            transition: all 0.2s;
        }

        .education-content {
            padding: 20px;
            display: none;
        }

        .education-content.active {
            display: block;
        }

        .aspects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 14px;
            margin-bottom: 20px;
        }

        .aspect-card {
            background: #fafbfc;
            border: 1px solid #e8eaed;
            border-radius: 6px;
            padding: 16px;
            transition: all 0.2s;
        }

        .aspect-card:hover {
            border-color: #dadce0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .aspect-card.fundamental {
            border-left: 3px solid #ea8600;
        }

        .aspect-card.technical {
            border-left: 3px solid #1a73e8;
        }

        .aspect-card.chip {
            border-left: 3px solid #9334e6;
        }

        .aspect-card.macro {
            border-left: 3px solid #0f9d58;
        }

        .aspect-header {
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e8eaed;
        }

        .aspect-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .aspect-subtitle {
            font-size: 0.85em;
            color: #5f6368;
        }

        .aspect-content {
            color: #3c4043;
            line-height: 1.7;
        }

        .aspect-items {
            margin: 12px 0;
        }

        .aspect-item {
            padding: 6px 0 6px 18px;
            position: relative;
            font-size: 0.9em;
            color: #3c4043;
        }

        .aspect-item::before {
            content: "•";
            position: absolute;
            left: 5px;
            color: #5f6368;
        }

        .aspect-purpose {
            background: white;
            border: 1px solid #e8eaed;
            padding: 10px 12px;
            border-radius: 4px;
            margin-top: 12px;
            font-weight: 500;
            color: #1a1a1a;
            text-align: center;
            font-size: 0.9em;
        }

        .workflow-section {
            background: #f8f9fa;
            border: 1px solid #e8eaed;
            padding: 20px;
            border-radius: 6px;
            text-align: center;
        }

        .workflow-title {
            font-size: 1.05em;
            font-weight: 600;
            margin-bottom: 14px;
            color: #1a1a1a;
        }

        .workflow-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 0.9em;
        }

        .workflow-step {
            background: white;
            border: 1px solid #dadce0;
            padding: 8px 16px;
            border-radius: 4px;
            font-weight: 500;
            color: #3c4043;
            transition: all 0.2s;
        }

        .workflow-step:hover {
            border-color: #1a73e8;
            color: #1a73e8;
        }

        .workflow-arrow {
            font-size: 1.2em;
            color: #5f6368;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .control-row {
                flex-direction: column;
            }

            .control-group {
                width: 100%;
            }

            #candlestickChart {
                height: 400px;
            }
        }
    </style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>台股K線圖查詢系統</h1>
        <p>即時查詢台灣上市公司歷史K線數據</p>
    </div>

    <div class="controls">
        <div class="control-row">
            <div class="control-group">
                <label for="symbolInput">股票代號或名稱</label>
                <input type="text" id="symbolInput" placeholder="例如：2330 或 台積電" value="2330" list="stockList"
                       autocomplete="off">
                <datalist id="stockList"></datalist>
            </div>
            <button class="btn" id="queryBtn">查詢K線</button>
        </div>

        <div class="quick-stocks">
            <span style="color: #6c757d; font-size: 0.9em; margin-right: 10px;">快速選擇：</span>
            <button class="quick-stock-btn" data-symbol="2330">2330 台積電</button>
            <button class="quick-stock-btn" data-symbol="2317">2317 鴻海</button>
            <button class="quick-stock-btn" data-symbol="2454">2454 聯發科</button>
            <button class="quick-stock-btn" data-symbol="2412">2412 中華電</button>
            <button class="quick-stock-btn" data-symbol="2882">2882 國泰金</button>
            <button class="quick-stock-btn" data-symbol="2891">2891 中信金</button>
        </div>
    </div>

    <div class="stock-info" id="stockInfo">
        <div class="info-grid" id="infoGrid">
            <!-- 動態生成股票資訊 -->
        </div>
    </div>

    <!-- 技術分析面板 -->
    <div class="analysis-panel" id="analysisPanel" style="display: none;">
        <div class="analysis-header">
            <h3>基於今日K線的技術分析</h3>
            <span class="analysis-toggle" onclick="toggleAnalysisDetail()">詳細 ▼</span>
        </div>

        <div class="analysis-summary">
            <div class="recommendation-box" id="recommendationBox">
                <div class="recommendation-label">明日操作建議</div>
                <div class="recommendation-value" id="recommendationValue">-</div>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill"></div>
                </div>
                <div class="confidence-text" id="confidenceText">信心指數: -</div>
            </div>

            <div class="signals-summary" id="signalsSummary">
                <!-- 動態生成訊號摘要 -->
            </div>
        </div>

        <div class="analysis-detail" id="analysisDetail" style="display: none;">
            <div class="indicators-grid" id="indicatorsGrid">
                <!-- 動態生成技術指標 -->
            </div>

            <div class="analysis-text" id="analysisText">
                <!-- 動態生成分析文字 -->
            </div>
        </div>
    </div>

    <!-- 股票分析四大面向教育板块 -->
    <div class="education-panel">
        <div class="education-header" onclick="toggleEducationPanel()">
            <h3>股票分析四大面向</h3>
            <span class="education-toggle" id="educationToggle">展開 ▼</span>
        </div>

        <div class="education-content" id="educationContent">
            <div class="aspects-grid">
                <!-- 基本面 -->
                <div class="aspect-card fundamental">
                    <div class="aspect-header">
                        <div>
                            <div class="aspect-title">基本面</div>
                            <div class="aspect-subtitle">公司好不好</div>
                        </div>
                    </div>
                    <div class="aspect-content">
                        <div class="aspect-items">
                            <div class="aspect-item">營收 / EPS / 利潤</div>
                            <div class="aspect-item">現金流</div>
                            <div class="aspect-item">ROE（股東權益報酬率）</div>
                            <div class="aspect-item">配息 & 殖利率</div>
                            <div class="aspect-item">負債比</div>
                            <div class="aspect-item">產業前景 & 市占</div>
                        </div>
                        <div class="aspect-purpose">
                            判斷：值不值得長期投資
                        </div>
                    </div>
                </div>

                <!-- 技術面 -->
                <div class="aspect-card technical">
                    <div class="aspect-header">
                        <div>
                            <div class="aspect-title">技術面</div>
                            <div class="aspect-subtitle">何時買賣</div>
                        </div>
                    </div>
                    <div class="aspect-content">
                        <div class="aspect-items">
                            <div class="aspect-item">K 線</div>
                            <div class="aspect-item">均線（MA5/10/20/60）</div>
                            <div class="aspect-item">RSI / MACD 等指標</div>
                            <div class="aspect-item">成交量</div>
                            <div class="aspect-item">支撐 / 壓力位</div>
                        </div>
                        <div class="aspect-purpose">
                            判斷：進場 / 出場時機
                        </div>
                    </div>
                </div>

                <!-- 籌碼面 -->
                <div class="aspect-card chip">
                    <div class="aspect-header">
                        <div>
                            <div class="aspect-title">籌碼面</div>
                            <div class="aspect-subtitle">誰在買股票</div>
                        </div>
                    </div>
                    <div class="aspect-content">
                        <div class="aspect-items">
                            <div class="aspect-item">外資 / 投信 / 自營商</div>
                            <div class="aspect-item">大股東持股</div>
                            <div class="aspect-item">融資融券</div>
                            <div class="aspect-item">籌碼集中度</div>
                            <div class="aspect-item">董監持股變化</div>
                        </div>
                        <div class="aspect-purpose">
                            判斷：是否有大戶在布局或撤退
                        </div>
                    </div>
                </div>

                <!-- 總體與事件 -->
                <div class="aspect-card macro">
                    <div class="aspect-header">
                        <div>
                            <div class="aspect-title">總體與事件</div>
                            <div class="aspect-subtitle">外在影響</div>
                        </div>
                    </div>
                    <div class="aspect-content">
                        <div class="aspect-items">
                            <div class="aspect-item">美股 / 景氣循環</div>
                            <div class="aspect-item">利率 / 通膨</div>
                            <div class="aspect-item">匯率</div>
                            <div class="aspect-item">政策</div>
                            <div class="aspect-item">公司重大事件（財報、併購）</div>
                        </div>
                        <div class="aspect-purpose">
                            判斷：趨勢方向與風險
                        </div>
                    </div>
                </div>
            </div>

            <!-- 分析流程 -->
            <div class="workflow-section">
                <div class="workflow-title">常用分析流程</div>
                <div class="workflow-steps">
                    <div class="workflow-step">環境</div>
                    <div class="workflow-arrow">→</div>
                    <div class="workflow-step">產業</div>
                    <div class="workflow-arrow">→</div>
                    <div class="workflow-step">基本面</div>
                    <div class="workflow-arrow">→</div>
                    <div class="workflow-step">籌碼</div>
                    <div class="workflow-arrow">→</div>
                    <div class="workflow-step">技術面</div>
                    <div class="workflow-arrow">→</div>
                    <div class="workflow-step">進出場</div>
                </div>
            </div>
        </div>
    </div>

    <div id="chartContainer">
        <div id="candlestickChart"></div>
    </div>
</div>

<script>
    let chart;
    // 自動偵測 API 基礎 URL
    // 如果從 Spring Boot (port 5001) 提供服務，使用當前 origin
    // 否則使用預設的 localhost:5001
    const API_BASE = window.location.port === '5001'
        ? window.location.origin
        : 'http://localhost:5001';

    // 常用台股列表（代號和中文名稱）
    // 初始化股票列表選項
    async function initStockList() {
        console.log('========== initStockList ==========');
        const datalist = document.getElementById('stockList');
        const input = document.getElementById('symbolInput');

        // 顯示載入中提示
        input.placeholder = "載入股票列表中...";

        try {
            console.log('正在從 API 獲取股票列表...');
            const response = await fetch(`${API_BASE}/api/stock/list`);

            if (!response.ok) {
                throw new Error(`獲取股票列表失敗: ${response.status}`);
            }

            const stocks = await response.json();
            console.log('股票列表獲取成功，共', stocks.length, '筆');

            // 全域變數儲存，供搜尋使用
            window.allStocks = stocks;

            // 清空舊選項
            datalist.innerHTML = '';

            // 建立 Fragment 以提升效能
            const fragment = document.createDocumentFragment();

            stocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = `${stock.symbol} ${stock.name}`;
                option.dataset.symbol = stock.symbol;
                fragment.appendChild(option);
            });

            datalist.appendChild(fragment);
            console.log('datalist 更新完成');

            // 恢復輸入框提示
            input.placeholder = "請輸入股票代號或名稱";

        } catch (error) {
            console.error('初始化股票列表錯誤:', error);
            input.placeholder = "股票列表載入失敗，請手動輸入代號";

            // 發生錯誤時，至少保留熱門股以供使用 (Fallback)
            const fallbackStocks = [
                { symbol: '2330', name: '台積電' },
                { symbol: '2317', name: '鴻海' },
                { symbol: '2454', name: '聯發科' }
            ];
            window.allStocks = fallbackStocks;

            // 建立 Fragment
            const fragment = document.createDocumentFragment();
            fallbackStocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = `${stock.symbol} ${stock.name}`;
                fragment.appendChild(option);
            });
            datalist.appendChild(fragment);
        }
    }

    // 將輸入轉換為股票代號
    function parseSymbolInput(input) {
        // 去除空白
        input = input.trim();
        console.log('========== parseSymbolInput ==========');
        console.log('原始輸入:', input);

        const stocks = window.allStocks || [];

        // 如果是純數字，直接返回
        if (/^\d+$/.test(input)) {
            console.log('✓ 匹配純數字:', input);
            return input;
        }

        // 嘗試從 "代號 名稱" 格式中提取代號
        const match = input.match(/^(\d+)\s/);
        if (match) {
            console.log('✓ 匹配 "代號 名稱" 格式:', match[1]);
            return match[1];
        }

        // 嘗試根據中文名稱查找
        console.log('嘗試在股票列表中查找:', input);
        if (stocks.length > 0) {
            const stock = stocks.find(s => s.name === input || s.name.includes(input));
            if (stock) {
                console.log('✓ 找到匹配:', stock.symbol, stock.name);
                return stock.symbol;
            }
        }

        // 都找不到，返回原輸入
        console.log('✗ 找不到匹配，返回原輸入:', input);
        return input;
    }

    // 初始化圖表
    function initChart() {
        const chartDom = document.getElementById('candlestickChart');
        chart = echarts.init(chartDom);
        chart.showLoading({
            text: '載入中...',
            color: '#667eea',
            textColor: '#000',
            maskColor: 'rgba(255, 255, 255, 0.8)',
            zlevel: 0
        });
    }

    // 查詢K線數據
    async function queryKLine() {
        const input = document.getElementById('symbolInput').value.trim();
        const symbol = parseSymbolInput(input);
        const queryBtn = document.getElementById('queryBtn');

        console.log('解析後的股票代號:', symbol);

        if (!symbol) {
            alert('請輸入股票代號或名稱');
            return;
        }

        queryBtn.disabled = true;
        queryBtn.textContent = '查詢中...';
        chart.showLoading();

        try {
            // 使用優化的 API：顯示 12 個月，基於 18 個月計算均線
            const apiUrl = `${API_BASE}/api/stock/${symbol}/candlestick-with-ma?displayMonths=12&maBaseMonths=18`;
            console.log('API URL:', apiUrl);
            const response = await fetch(apiUrl);

            if (!response.ok) {
                throw new Error(`查詢失敗: ${response.status}`);
            }

            const data = await response.json();

            if (!data || data.length === 0) {
                throw new Error('查無數據');
            }

            // 保存數據供調試使用
            window.latestData = data;
            console.log('已載入', data.length, '筆 K 線數據');
            console.log('前 3 筆數據範例：', data.slice(0, 3));

            renderChart(data, symbol);
            updateStockInfo(data);

            // 查詢技術分析
            fetchTechnicalAnalysis(symbol);

        } catch (error) {
            console.error('Error:', error);
            chart.hideLoading();
            const chartDom = document.getElementById('candlestickChart');
            chartDom.innerHTML = `<div class="error">查詢失敗: ${error.message}</div>`;
        } finally {
            queryBtn.disabled = false;
            queryBtn.textContent = '查詢K線';
        }
    }

    // 查詢技術分析
    async function fetchTechnicalAnalysis(symbol) {
        try {
            const response = await fetch(`${API_BASE}/api/stock/${symbol}/analysis`);

            if (!response.ok) {
                console.warn('技術分析查詢失敗:', response.status);
                document.getElementById('analysisPanel').style.display = 'none';
                return;
            }

            const analysis = await response.json();
            displayTechnicalAnalysis(analysis);

        } catch (error) {
            console.error('技術分析錯誤:', error);
            document.getElementById('analysisPanel').style.display = 'none';
        }
    }

    // 顯示技術分析結果
    function displayTechnicalAnalysis(analysis) {
        const panel = document.getElementById('analysisPanel');
        panel.style.display = 'block';

        // 顯示操作建議
        const recommendationValue = document.getElementById('recommendationValue');
        recommendationValue.textContent = analysis.recommendation;
        recommendationValue.className = 'recommendation-value';

        // 根據建議類型添加樣式（明日操作建議）
        if (analysis.recommendation === '買入') {
            recommendationValue.classList.add('buy');
        } else if (analysis.recommendation === '賣出') {
            recommendationValue.classList.add('sell');
        } else if (analysis.recommendation === '觀望') {
            recommendationValue.classList.add('wait');
        }

        // 顯示信心指數
        const confidenceFill = document.getElementById('confidenceFill');
        const confidenceText = document.getElementById('confidenceText');
        confidenceFill.style.width = `${analysis.confidence}%`;
        confidenceText.textContent = `信心指數: ${analysis.confidence}%`;

        // 顯示訊號摘要
        const signalsSummary = document.getElementById('signalsSummary');
        signalsSummary.innerHTML = '';

        if (analysis.signals && analysis.signals.length > 0) {
            // 只顯示前 5 個最重要的訊號
            analysis.signals.slice(0, 5).forEach(signal => {
                const signalDiv = document.createElement('div');
                signalDiv.className = `signal-item ${signal.direction === '買進' ? 'buy' : 'sell'}`;

                // 強度顯示
                const strengthHtml = Array(5).fill(0).map((_, i) =>
                    `<span class="${i < signal.strength ? 'active' : ''}"></span>`
                ).join('');

                signalDiv.innerHTML = `
                <div>
                    <div class="signal-type">${signal.type}</div>
                    <div class="signal-description">${signal.description}</div>
                </div>
                <div class="signal-strength">${strengthHtml}</div>
            `;
                signalsSummary.appendChild(signalDiv);
            });
        } else {
            signalsSummary.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暫無明顯訊號</div>';
        }

        // 顯示技術指標
        const indicatorsGrid = document.getElementById('indicatorsGrid');
        indicatorsGrid.innerHTML = '';

        const indicators = analysis.indicators;
        const indicatorsList = [
            {
                label: 'RSI(6)',
                value: indicators.rsi6,
                desc: '6日相對強弱指標：>70超買，<30超賣，衡量短期買賣力道'
            },
            {
                label: 'RSI(12)',
                value: indicators.rsi12,
                desc: '12日相對強弱指標：>70超買，<30超賣，衡量中期買賣力道'
            },
            {
                label: 'KD-K',
                value: indicators.kdK,
                desc: 'K值：>80超買，<20超賣，反應靈敏的短期指標'
            },
            {
                label: 'KD-D',
                value: indicators.kdD,
                desc: 'D值：K值的平滑線，K>D黃金交叉（買進），K<D死亡交叉（賣出）'
            },
            {
                label: 'MACD-DIF',
                value: indicators.macdDif,
                desc: 'DIF快線：12日與26日EMA差，反映短期趨勢動能'
            },
            {
                label: 'MACD-DEA',
                value: indicators.macdDea,
                desc: 'DEA慢線：DIF的9日平均，DIF>DEA看多，DIF<DEA看空'
            },
            {
                label: '布林上軌',
                value: indicators.bbandsUpper,
                desc: '上軌：價格觸及表示超買，可能回檔'
            },
            {
                label: '布林中軌',
                value: indicators.bbandsMiddle,
                desc: '中軌：20日移動平均線，中期趨勢參考'
            },
            {
                label: '布林下軌',
                value: indicators.bbandsLower,
                desc: '下軌：價格觸及表示超賣，可能反彈'
            },
            {
                label: 'MA5',
                value: indicators.ma5,
                desc: '5日均線：短期趨勢，價格在上方為多頭'
            },
            {
                label: 'MA10',
                value: indicators.ma10,
                desc: '10日均線：短中期趨勢，與MA5交叉形成訊號'
            },
            {
                label: 'MA20',
                value: indicators.ma20,
                desc: '20日均線：中期趨勢，重要支撐壓力'
            },
            {
                label: 'MA60',
                value: indicators.ma60,
                desc: '60日均線：長期趨勢，季線位置'
            }
        ];

        indicatorsList.forEach(ind => {
            if (ind.value !== null && ind.value !== undefined) {
                const indDiv = document.createElement('div');
                indDiv.className = 'indicator-item';
                indDiv.innerHTML = `
                <div class="indicator-label">${ind.label}</div>
                <div class="indicator-value">${typeof ind.value === 'number' ? ind.value.toFixed(2) : ind.value}</div>
                <div class="indicator-desc">${ind.desc}</div>
            `;
                indicatorsGrid.appendChild(indDiv);
            }
        });

        // 顯示分析文字
        const analysisText = document.getElementById('analysisText');
        analysisText.textContent = analysis.analysis;
    }

    // 切換詳細分析
    function toggleAnalysisDetail() {
        const detail = document.getElementById('analysisDetail');
        const toggle = document.querySelector('.analysis-toggle');

        if (detail.style.display === 'none') {
            detail.style.display = 'block';
            toggle.textContent = '收起 ▲';
        } else {
            detail.style.display = 'none';
            toggle.textContent = '詳細 ▼';
        }
    }

    // 切換教育面板
    function toggleEducationPanel() {
        const content = document.getElementById('educationContent');
        const toggle = document.getElementById('educationToggle');

        if (content.classList.contains('active')) {
            content.classList.remove('active');
            toggle.textContent = '展開 ▼';
        } else {
            content.classList.add('active');
            toggle.textContent = '收起 ▲';
        }
    }

    // 渲染圖表
    function renderChart(data, symbol) {
        chart.hideLoading();

        // 準備數據
        const dates = data.map(item => item.date);
        const ohlc = data.map(item => [item.open, item.close, item.low, item.high]);
        const volumes = data.map(item => item.volume);

        // 調試：檢查影線
        const sampleData = data.slice(0, 5);
        console.log('檢查前 5 筆 K 線數據：');
        sampleData.forEach((item, idx) => {
            const upperShadow = item.high - Math.max(item.open, item.close);
            const lowerShadow = Math.min(item.open, item.close) - item.low;
            console.log(`  ${idx + 1}. ${item.date}:`, {
                開盤: item.open,
                收盤: item.close,
                最高: item.high,
                最低: item.low,
                上影線: upperShadow.toFixed(2),
                下影線: lowerShadow.toFixed(2)
            });
        });

        // 直接從後端獲取的均線數據
        const maConfig = [
            { name: 'MA5', color: '#FF1493' },
            { name: 'MA10', color: '#00CED1' },
            { name: 'MA20', color: '#FFD700' },
            { name: 'MA60', color: '#9370DB' }
        ];

        // 提取均線數據（後端已計算好）
        const maData = {
            'MA5': data.map(item => item.ma5),
            'MA10': data.map(item => item.ma10),
            'MA20': data.map(item => item.ma20),
            'MA60': data.map(item => item.ma60)
        };

        // 檢測稀疏數據區域（用於視覺標記）
        const isSparseData = new Array(data.length).fill(false);
        for (let i = 1; i < data.length; i++) {
            const prevDate = new Date(data[i - 1].date);
            const currDate = new Date(data[i].date);
            const daysDiff = (currDate - prevDate) / (1000 * 60 * 60 * 24);

            if (daysDiff > 5) {
                for (let j = Math.max(0, i - 5); j <= Math.min(data.length - 1, i + 5); j++) {
                    isSparseData[j] = true;
                }
            }
        }

        // 計算顯示範圍：預設顯示全部 12 個月
        const zoomStart = 0;
        const zoomEnd = 100;

        // 找出稀疏數據區域，用於標記
        const sparseAreas = [];
        let areaStart = null;
        for (let i = 0; i < isSparseData.length; i++) {
            if (isSparseData[i] && areaStart === null) {
                areaStart = i;
            } else if (!isSparseData[i] && areaStart !== null) {
                sparseAreas.push([{ xAxis: dates[areaStart] }, { xAxis: dates[i - 1] }]);
                areaStart = null;
            }
        }
        if (areaStart !== null) {
            sparseAreas.push([{ xAxis: dates[areaStart] }, { xAxis: dates[dates.length - 1] }]);
        }

        const option = {
            title: {
                text: `${symbol} K線圖`,
                left: 'center',
                textStyle: {
                    fontSize: 20,
                    fontWeight: 600,
                    color: '#212529'
                }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
                formatter: function (params) {
                    const dataIndex = params[0].dataIndex;
                    const item = data[dataIndex];

                    let maInfo = '';
                    maConfig.forEach(config => {
                        const maValue = maData[config.name][dataIndex];
                        if (maValue !== null && maValue !== undefined) {
                            maInfo += `<span style="color: ${config.color}; font-weight: 600;">${config.name}: ${maValue.toFixed(2)}</span><br/>`;
                        }
                    });

                    return `
                    <div style="padding: 10px;">
                        <strong>${item.date}</strong><br/>
                        開盤: ${item.open.toFixed(2)}<br/>
                        最高: ${item.high.toFixed(2)}<br/>
                        最低: ${item.low.toFixed(2)}<br/>
                        收盤: ${item.close.toFixed(2)}<br/>
                        ${maInfo}
                        成交量: ${item.volume.toLocaleString()} 張<br/>
                        成交額: ${item.turnover.toLocaleString()} 千元<br/>
                        漲跌: <span style="color: ${item.change >= 0 ? '#ef5350' : '#26a69a'}">${item.change >= 0 ? '+' : ''}${item.change.toFixed(2)} (${item.changePercent >= 0 ? '+' : ''}${item.changePercent.toFixed(2)}%)</span>
                    </div>
                `;
                }
            },
            legend: {
                data: ['K線', ...maConfig.map(c => c.name), '成交量'],
                top: 40,
                left: 'center'
            },
            grid: [
                {
                    left: '8%',
                    right: '8%',
                    top: '15%',
                    height: '50%'
                },
                {
                    left: '8%',
                    right: '8%',
                    top: '70%',
                    height: '15%'
                }
            ],
            xAxis: [
                {
                    type: 'category',
                    data: dates,
                    boundaryGap: true,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: {
                        formatter: function (value) {
                            return value.substring(5);
                        }
                    },
                    min: 'dataMin',
                    max: 'dataMax',
                    axisPointer: {
                        show: true
                    }
                },
                {
                    type: 'category',
                    gridIndex: 1,
                    data: dates,
                    boundaryGap: true,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: { show: false },
                    axisTick: { show: false },
                    min: 'dataMin',
                    max: 'dataMax'
                }
            ],
            yAxis: [
                {
                    scale: true,
                    splitArea: {
                        show: true
                    },
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { show: true },
                    axisTick: { show: false },
                    axisLabel: {
                        formatter: '{value}'
                    }
                },
                {
                    scale: true,
                    gridIndex: 1,
                    splitNumber: 2,
                    axisLabel: { show: false },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    splitLine: { show: false }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: [0, 1],
                    start: zoomStart,
                    end: zoomEnd
                },
                {
                    show: true,
                    xAxisIndex: [0, 1],
                    type: 'slider',
                    bottom: '5%',
                    start: zoomStart,
                    end: zoomEnd,
                    handleIcon: 'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                    handleSize: '80%',
                    handleStyle: {
                        color: '#fff',
                        shadowBlur: 3,
                        shadowColor: 'rgba(0, 0, 0, 0.6)',
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    }
                }
            ],
            series: [
                {
                    name: 'K線',
                    type: 'candlestick',
                    data: ohlc,
                    itemStyle: {
                        color: '#ef5350',        // 陽線實體顏色（紅色）
                        color0: '#26a69a',       // 陰線實體顏色（綠色）
                        borderColor: '#ef5350',  // 陽線邊框和影線顏色
                        borderColor0: '#26a69a', // 陰線邊框和影線顏色
                        borderWidth: 1           // 邊框和影線寬度（關鍵！）
                    },
                    emphasis: {
                        itemStyle: {
                            borderColor: '#000',
                            borderWidth: 2
                        }
                    },
                    markArea: sparseAreas.length > 0 ? {
                        silent: true,
                        itemStyle: {
                            color: 'rgba(255, 173, 177, 0.15)'
                        },
                        data: sparseAreas,
                        label: {
                            show: true,
                            position: 'insideTop',
                            formatter: '數據稀疏區域\n(休市期間)',
                            fontSize: 11,
                            color: '#999'
                        }
                    } : undefined
                },
                // 動態添加均線（後端已計算好）
                ...maConfig.map(config => ({
                    name: config.name,
                    type: 'line',
                    data: maData[config.name],
                    smooth: false,
                    lineStyle: {
                        width: 2,
                        color: config.color
                    },
                    showSymbol: false,
                    z: 1
                })),
                {
                    name: '成交量',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: volumes,
                    itemStyle: {
                        color: function (params) {
                            const item = data[params.dataIndex];
                            return item.close >= item.open ? '#ef5350' : '#26a69a';
                        }
                    }
                }
            ]
        };

        chart.setOption(option, true);
    }

    // 更新股票資訊
    function updateStockInfo(data) {
        const stockInfo = document.getElementById('stockInfo');
        const infoGrid = document.getElementById('infoGrid');

        const latestData = data[data.length - 1];
        const firstData = data[0];

        const periodChange = latestData.close - firstData.open;
        const periodChangePercent = (periodChange / firstData.open) * 100;

        infoGrid.innerHTML = `
        <div class="info-item stock-name-item">
            <div class="info-label">股票</div>
            <div class="info-value"><strong>${latestData.name || latestData.symbol}</strong> (${latestData.symbol})</div>
        </div>
        <div class="info-item">
            <div class="info-label">最新日期</div>
            <div class="info-value">${latestData.date}</div>
        </div>
        <div class="info-item">
            <div class="info-label">收盤價</div>
            <div class="info-value">${latestData.close.toFixed(2)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">當日漲跌</div>
            <div class="info-value ${latestData.change >= 0 ? 'positive' : 'negative'}">
                ${latestData.change >= 0 ? '+' : ''}${latestData.change.toFixed(2)} (${latestData.changePercent >= 0 ? '+' : ''}${latestData.changePercent.toFixed(2)}%)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">區間漲跌</div>
            <div class="info-value ${periodChange >= 0 ? 'positive' : 'negative'}">
                ${periodChange >= 0 ? '+' : ''}${periodChange.toFixed(2)} (${periodChangePercent >= 0 ? '+' : ''}${periodChangePercent.toFixed(2)}%)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">最高價</div>
            <div class="info-value">${latestData.high.toFixed(2)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">最低價</div>
            <div class="info-value">${latestData.low.toFixed(2)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">成交量</div>
            <div class="info-value">${latestData.volume.toLocaleString()} 張</div>
        </div>
        <div class="info-item">
            <div class="info-label">成交金額</div>
            <div class="info-value">${(latestData.turnover / 1000).toFixed(0)} 百萬</div>
        </div>
    `;

        stockInfo.classList.add('active');
    }

    // 事件監聽
    document.getElementById('queryBtn').addEventListener('click', queryKLine);

    document.getElementById('symbolInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            queryKLine();
        }
    });

    // 快速選股按鈕
    document.querySelectorAll('.quick-stock-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('symbolInput').value = btn.dataset.symbol;
            queryKLine();
        });
    });

    // 響應式調整
    window.addEventListener('resize', () => {
        if (chart) {
            chart.resize();
        }
    });

    // 初始化並自動查詢
    window.addEventListener('load', () => {
        initStockList();  // 初始化股票列表選項
        initChart();
        queryKLine();
    });
</script>
</body>

</html>