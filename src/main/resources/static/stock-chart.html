<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股K線圖查詢系統</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .controls {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .control-row {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .control-group {
            flex: 1;
            min-width: 200px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
            font-size: 0.95em;
        }

        .control-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            background: #adb5bd;
            cursor: not-allowed;
            box-shadow: none;
        }

        .stock-info {
            padding: 20px 30px;
            background: white;
            border-bottom: 1px solid #e9ecef;
            display: none;
        }

        .stock-info.active {
            display: block;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .info-item {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            text-align: center;
        }

        .info-label {
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 1.3em;
            font-weight: 600;
            color: #212529;
        }

        .info-value.positive {
            color: #dc3545;
        }

        .info-value.negative {
            color: #28a745;
        }

        #chartContainer {
            padding: 30px;
        }

        #candlestickChart {
            width: 100%;
            height: 600px;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #6c757d;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '.';
            }

            40% {
                content: '..';
            }

            60%,
            100% {
                content: '...';
            }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            margin: 30px;
            border-radius: 8px;
            border-left: 4px solid #dc3545;
        }

        .quick-stocks {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .quick-stock-btn {
            padding: 8px 16px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 6px;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-stock-btn:hover {
            background: #667eea;
            color: white;
        }

        /* 技術分析面板樣式 */
        .analysis-panel {
            margin: 20px 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .analysis-panel.active {
            display: block;
        }

        .analysis-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .analysis-header h3 {
            margin: 0;
            font-size: 1.2em;
        }

        .analysis-toggle {
            cursor: pointer;
            padding: 5px 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            font-size: 0.9em;
            transition: background 0.3s;
        }

        .analysis-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .analysis-summary {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            padding: 20px;
        }

        .recommendation-box {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .recommendation-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 10px;
        }

        .recommendation-value {
            font-size: 2.5em;
            font-weight: 700;
            margin: 10px 0;
        }

        .recommendation-value.buy {
            color: #dc3545;
            /* 紅色 - 買入 */
        }

        .recommendation-value.sell {
            color: #28a745;
            /* 綠色 - 賣出 */
        }

        .recommendation-value.wait {
            color: #6c757d;
            /* 灰色 - 觀望 */
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
        }

        .confidence-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .signals-summary {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .signal-item {
            background: #f8f9fa;
            padding: 12px 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .signal-item.buy {
            border-left-color: #dc3545;
            background: #fff5f5;
        }

        .signal-item.sell {
            border-left-color: #28a745;
            background: #f0fff4;
        }

        .signal-type {
            font-weight: 600;
            color: #333;
        }

        .signal-description {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .signal-strength {
            display: flex;
            gap: 3px;
        }

        .signal-strength span {
            width: 8px;
            height: 20px;
            background: #ddd;
            border-radius: 2px;
        }

        .signal-strength span.active {
            background: #667eea;
        }

        .analysis-detail {
            padding: 20px;
            border-top: 1px solid #e9ecef;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .indicator-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .indicator-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .indicator-value {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .indicator-desc {
            font-size: 0.75em;
            color: #666;
            line-height: 1.4;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e0e0e0;
            text-align: left;
        }

        .analysis-text {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            line-height: 1.8;
            white-space: pre-wrap;
            color: #333;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .control-row {
                flex-direction: column;
            }

            .control-group {
                width: 100%;
            }

            #candlestickChart {
                height: 400px;
            }
        }
    </style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>台股K線圖查詢系統</h1>
        <p>即時查詢台灣上市公司歷史K線數據</p>
    </div>

    <div class="controls">
        <div class="control-row">
            <div class="control-group">
                <label for="symbolInput">股票代號或名稱</label>
                <input type="text" id="symbolInput" placeholder="例如：2330 或 台積電" value="2330" list="stockList"
                       autocomplete="off">
                <datalist id="stockList"></datalist>
            </div>
            <button class="btn" id="queryBtn">查詢K線</button>
        </div>

        <div class="quick-stocks">
            <span style="color: #6c757d; font-size: 0.9em; margin-right: 10px;">快速選擇：</span>
            <button class="quick-stock-btn" data-symbol="2330">2330 台積電</button>
            <button class="quick-stock-btn" data-symbol="2317">2317 鴻海</button>
            <button class="quick-stock-btn" data-symbol="2454">2454 聯發科</button>
            <button class="quick-stock-btn" data-symbol="2412">2412 中華電</button>
            <button class="quick-stock-btn" data-symbol="2882">2882 國泰金</button>
            <button class="quick-stock-btn" data-symbol="2891">2891 中信金</button>
        </div>
    </div>

    <div class="stock-info" id="stockInfo">
        <div class="info-grid" id="infoGrid">
            <!-- 動態生成股票資訊 -->
        </div>
    </div>

    <!-- 技術分析面板 -->
    <div class="analysis-panel" id="analysisPanel" style="display: none;">
        <div class="analysis-header">
            <h3>基於今日K線的技術分析</h3>
            <span class="analysis-toggle" onclick="toggleAnalysisDetail()">詳細 ▼</span>
        </div>

        <div class="analysis-summary">
            <div class="recommendation-box" id="recommendationBox">
                <div class="recommendation-label">明日操作建議</div>
                <div class="recommendation-value" id="recommendationValue">-</div>
                <div class="confidence-bar">
                    <div class="confidence-fill" id="confidenceFill"></div>
                </div>
                <div class="confidence-text" id="confidenceText">信心指數: -</div>
            </div>

            <div class="signals-summary" id="signalsSummary">
                <!-- 動態生成訊號摘要 -->
            </div>
        </div>

        <div class="analysis-detail" id="analysisDetail" style="display: none;">
            <div class="indicators-grid" id="indicatorsGrid">
                <!-- 動態生成技術指標 -->
            </div>

            <div class="analysis-text" id="analysisText">
                <!-- 動態生成分析文字 -->
            </div>
        </div>
    </div>

    <div id="chartContainer">
        <div id="candlestickChart"></div>
    </div>
</div>

<script>
    let chart;
    // 自動偵測 API 基礎 URL
    // 如果從 Spring Boot (port 5001) 提供服務，使用當前 origin
    // 否則使用預設的 localhost:5001
    const API_BASE = window.location.port === '5001'
        ? window.location.origin
        : 'http://localhost:5001';

    // 常用台股列表（代號和中文名稱）
    // 初始化股票列表選項
    async function initStockList() {
        console.log('========== initStockList ==========');
        const datalist = document.getElementById('stockList');
        const input = document.getElementById('symbolInput');

        // 顯示載入中提示
        input.placeholder = "載入股票列表中...";

        try {
            console.log('正在從 API 獲取股票列表...');
            const response = await fetch(`${API_BASE}/api/stock/list`);

            if (!response.ok) {
                throw new Error(`獲取股票列表失敗: ${response.status}`);
            }

            const stocks = await response.json();
            console.log('股票列表獲取成功，共', stocks.length, '筆');

            // 全域變數儲存，供搜尋使用
            window.allStocks = stocks;

            // 清空舊選項
            datalist.innerHTML = '';

            // 建立 Fragment 以提升效能
            const fragment = document.createDocumentFragment();

            stocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = `${stock.symbol} ${stock.name}`;
                option.dataset.symbol = stock.symbol;
                fragment.appendChild(option);
            });

            datalist.appendChild(fragment);
            console.log('datalist 更新完成');

            // 恢復輸入框提示
            input.placeholder = "請輸入股票代號或名稱";

        } catch (error) {
            console.error('初始化股票列表錯誤:', error);
            input.placeholder = "股票列表載入失敗，請手動輸入代號";

            // 發生錯誤時，至少保留熱門股以供使用 (Fallback)
            const fallbackStocks = [
                { symbol: '2330', name: '台積電' },
                { symbol: '2317', name: '鴻海' },
                { symbol: '2454', name: '聯發科' }
            ];
            window.allStocks = fallbackStocks;

            // 建立 Fragment
            const fragment = document.createDocumentFragment();
            fallbackStocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = `${stock.symbol} ${stock.name}`;
                fragment.appendChild(option);
            });
            datalist.appendChild(fragment);
        }
    }

    // 將輸入轉換為股票代號
    function parseSymbolInput(input) {
        // 去除空白
        input = input.trim();
        console.log('========== parseSymbolInput ==========');
        console.log('原始輸入:', input);

        const stocks = window.allStocks || [];

        // 如果是純數字，直接返回
        if (/^\d+$/.test(input)) {
            console.log('✓ 匹配純數字:', input);
            return input;
        }

        // 嘗試從 "代號 名稱" 格式中提取代號
        const match = input.match(/^(\d+)\s/);
        if (match) {
            console.log('✓ 匹配 "代號 名稱" 格式:', match[1]);
            return match[1];
        }

        // 嘗試根據中文名稱查找
        console.log('嘗試在股票列表中查找:', input);
        if (stocks.length > 0) {
            const stock = stocks.find(s => s.name === input || s.name.includes(input));
            if (stock) {
                console.log('✓ 找到匹配:', stock.symbol, stock.name);
                return stock.symbol;
            }
        }

        // 都找不到，返回原輸入
        console.log('✗ 找不到匹配，返回原輸入:', input);
        return input;
    }

    // 初始化圖表
    function initChart() {
        const chartDom = document.getElementById('candlestickChart');
        chart = echarts.init(chartDom);
        chart.showLoading({
            text: '載入中...',
            color: '#667eea',
            textColor: '#000',
            maskColor: 'rgba(255, 255, 255, 0.8)',
            zlevel: 0
        });
    }

    // 查詢K線數據
    async function queryKLine() {
        const input = document.getElementById('symbolInput').value.trim();
        const symbol = parseSymbolInput(input);
        const queryBtn = document.getElementById('queryBtn');

        console.log('解析後的股票代號:', symbol);

        if (!symbol) {
            alert('請輸入股票代號或名稱');
            return;
        }

        queryBtn.disabled = true;
        queryBtn.textContent = '查詢中...';
        chart.showLoading();

        try {
            // 使用優化的 API：顯示 12 個月，基於 18 個月計算均線
            const apiUrl = `${API_BASE}/api/stock/${symbol}/candlestick-with-ma?displayMonths=12&maBaseMonths=18`;
            console.log('API URL:', apiUrl);
            const response = await fetch(apiUrl);

            if (!response.ok) {
                throw new Error(`查詢失敗: ${response.status}`);
            }

            const data = await response.json();

            if (!data || data.length === 0) {
                throw new Error('查無數據');
            }

            renderChart(data, symbol);
            updateStockInfo(data);

            // 查詢技術分析
            fetchTechnicalAnalysis(symbol);

        } catch (error) {
            console.error('Error:', error);
            chart.hideLoading();
            const chartDom = document.getElementById('candlestickChart');
            chartDom.innerHTML = `<div class="error">查詢失敗: ${error.message}</div>`;
        } finally {
            queryBtn.disabled = false;
            queryBtn.textContent = '查詢K線';
        }
    }

    // 查詢技術分析
    async function fetchTechnicalAnalysis(symbol) {
        try {
            const response = await fetch(`${API_BASE}/api/stock/${symbol}/analysis`);

            if (!response.ok) {
                console.warn('技術分析查詢失敗:', response.status);
                document.getElementById('analysisPanel').style.display = 'none';
                return;
            }

            const analysis = await response.json();
            displayTechnicalAnalysis(analysis);

        } catch (error) {
            console.error('技術分析錯誤:', error);
            document.getElementById('analysisPanel').style.display = 'none';
        }
    }

    // 顯示技術分析結果
    function displayTechnicalAnalysis(analysis) {
        const panel = document.getElementById('analysisPanel');
        panel.style.display = 'block';

        // 顯示操作建議
        const recommendationValue = document.getElementById('recommendationValue');
        recommendationValue.textContent = analysis.recommendation;
        recommendationValue.className = 'recommendation-value';

        // 根據建議類型添加樣式（明日操作建議）
        if (analysis.recommendation === '買入') {
            recommendationValue.classList.add('buy');
        } else if (analysis.recommendation === '賣出') {
            recommendationValue.classList.add('sell');
        } else if (analysis.recommendation === '觀望') {
            recommendationValue.classList.add('wait');
        }

        // 顯示信心指數
        const confidenceFill = document.getElementById('confidenceFill');
        const confidenceText = document.getElementById('confidenceText');
        confidenceFill.style.width = `${analysis.confidence}%`;
        confidenceText.textContent = `信心指數: ${analysis.confidence}%`;

        // 顯示訊號摘要
        const signalsSummary = document.getElementById('signalsSummary');
        signalsSummary.innerHTML = '';

        if (analysis.signals && analysis.signals.length > 0) {
            // 只顯示前 5 個最重要的訊號
            analysis.signals.slice(0, 5).forEach(signal => {
                const signalDiv = document.createElement('div');
                signalDiv.className = `signal-item ${signal.direction === '買進' ? 'buy' : 'sell'}`;

                // 強度顯示
                const strengthHtml = Array(5).fill(0).map((_, i) =>
                    `<span class="${i < signal.strength ? 'active' : ''}"></span>`
                ).join('');

                signalDiv.innerHTML = `
                <div>
                    <div class="signal-type">${signal.type}</div>
                    <div class="signal-description">${signal.description}</div>
                </div>
                <div class="signal-strength">${strengthHtml}</div>
            `;
                signalsSummary.appendChild(signalDiv);
            });
        } else {
            signalsSummary.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暫無明顯訊號</div>';
        }

        // 顯示技術指標
        const indicatorsGrid = document.getElementById('indicatorsGrid');
        indicatorsGrid.innerHTML = '';

        const indicators = analysis.indicators;
        const indicatorsList = [
            {
                label: 'RSI(6)',
                value: indicators.rsi6,
                desc: '6日相對強弱指標：>70超買，<30超賣，衡量短期買賣力道'
            },
            {
                label: 'RSI(12)',
                value: indicators.rsi12,
                desc: '12日相對強弱指標：>70超買，<30超賣，衡量中期買賣力道'
            },
            {
                label: 'KD-K',
                value: indicators.kdK,
                desc: 'K值：>80超買，<20超賣，反應靈敏的短期指標'
            },
            {
                label: 'KD-D',
                value: indicators.kdD,
                desc: 'D值：K值的平滑線，K>D黃金交叉（買進），K<D死亡交叉（賣出）'
            },
            {
                label: 'MACD-DIF',
                value: indicators.macdDif,
                desc: 'DIF快線：12日與26日EMA差，反映短期趨勢動能'
            },
            {
                label: 'MACD-DEA',
                value: indicators.macdDea,
                desc: 'DEA慢線：DIF的9日平均，DIF>DEA看多，DIF<DEA看空'
            },
            {
                label: '布林上軌',
                value: indicators.bbandsUpper,
                desc: '上軌：價格觸及表示超買，可能回檔'
            },
            {
                label: '布林中軌',
                value: indicators.bbandsMiddle,
                desc: '中軌：20日移動平均線，中期趨勢參考'
            },
            {
                label: '布林下軌',
                value: indicators.bbandsLower,
                desc: '下軌：價格觸及表示超賣，可能反彈'
            },
            {
                label: 'MA5',
                value: indicators.ma5,
                desc: '5日均線：短期趨勢，價格在上方為多頭'
            },
            {
                label: 'MA10',
                value: indicators.ma10,
                desc: '10日均線：短中期趨勢，與MA5交叉形成訊號'
            },
            {
                label: 'MA20',
                value: indicators.ma20,
                desc: '20日均線：中期趨勢，重要支撐壓力'
            },
            {
                label: 'MA60',
                value: indicators.ma60,
                desc: '60日均線：長期趨勢，季線位置'
            }
        ];

        indicatorsList.forEach(ind => {
            if (ind.value !== null && ind.value !== undefined) {
                const indDiv = document.createElement('div');
                indDiv.className = 'indicator-item';
                indDiv.innerHTML = `
                <div class="indicator-label">${ind.label}</div>
                <div class="indicator-value">${typeof ind.value === 'number' ? ind.value.toFixed(2) : ind.value}</div>
                <div class="indicator-desc">${ind.desc}</div>
            `;
                indicatorsGrid.appendChild(indDiv);
            }
        });

        // 顯示分析文字
        const analysisText = document.getElementById('analysisText');
        analysisText.textContent = analysis.analysis;
    }

    // 切換詳細分析
    function toggleAnalysisDetail() {
        const detail = document.getElementById('analysisDetail');
        const toggle = document.querySelector('.analysis-toggle');

        if (detail.style.display === 'none') {
            detail.style.display = 'block';
            toggle.textContent = '收起 ▲';
        } else {
            detail.style.display = 'none';
            toggle.textContent = '詳細 ▼';
        }
    }

    // 渲染圖表
    function renderChart(data, symbol) {
        chart.hideLoading();

        // 準備數據
        const dates = data.map(item => item.date);
        const ohlc = data.map(item => [item.open, item.close, item.low, item.high]);
        const volumes = data.map(item => item.volume);

        // 直接從後端獲取的均線數據
        const maConfig = [
            { name: 'MA5', color: '#FF1493' },
            { name: 'MA10', color: '#00CED1' },
            { name: 'MA20', color: '#FFD700' },
            { name: 'MA60', color: '#9370DB' }
        ];

        // 提取均線數據（後端已計算好）
        const maData = {
            'MA5': data.map(item => item.ma5),
            'MA10': data.map(item => item.ma10),
            'MA20': data.map(item => item.ma20),
            'MA60': data.map(item => item.ma60)
        };

        // 檢測稀疏數據區域（用於視覺標記）
        const isSparseData = new Array(data.length).fill(false);
        for (let i = 1; i < data.length; i++) {
            const prevDate = new Date(data[i - 1].date);
            const currDate = new Date(data[i].date);
            const daysDiff = (currDate - prevDate) / (1000 * 60 * 60 * 24);

            if (daysDiff > 5) {
                for (let j = Math.max(0, i - 5); j <= Math.min(data.length - 1, i + 5); j++) {
                    isSparseData[j] = true;
                }
            }
        }

        // 計算顯示範圍：預設顯示全部 12 個月
        const zoomStart = 0;
        const zoomEnd = 100;

        // 找出稀疏數據區域，用於標記
        const sparseAreas = [];
        let areaStart = null;
        for (let i = 0; i < isSparseData.length; i++) {
            if (isSparseData[i] && areaStart === null) {
                areaStart = i;
            } else if (!isSparseData[i] && areaStart !== null) {
                sparseAreas.push([{ xAxis: dates[areaStart] }, { xAxis: dates[i - 1] }]);
                areaStart = null;
            }
        }
        if (areaStart !== null) {
            sparseAreas.push([{ xAxis: dates[areaStart] }, { xAxis: dates[dates.length - 1] }]);
        }

        const option = {
            title: {
                text: `${symbol} K線圖`,
                left: 'center',
                textStyle: {
                    fontSize: 20,
                    fontWeight: 600,
                    color: '#212529'
                }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
                formatter: function (params) {
                    const dataIndex = params[0].dataIndex;
                    const item = data[dataIndex];

                    let maInfo = '';
                    maConfig.forEach(config => {
                        const maValue = maData[config.name][dataIndex];
                        if (maValue !== null && maValue !== undefined) {
                            maInfo += `<span style="color: ${config.color}; font-weight: 600;">${config.name}: ${maValue.toFixed(2)}</span><br/>`;
                        }
                    });

                    return `
                    <div style="padding: 10px;">
                        <strong>${item.date}</strong><br/>
                        開盤: ${item.open.toFixed(2)}<br/>
                        最高: ${item.high.toFixed(2)}<br/>
                        最低: ${item.low.toFixed(2)}<br/>
                        收盤: ${item.close.toFixed(2)}<br/>
                        ${maInfo}
                        成交量: ${item.volume.toLocaleString()} 張<br/>
                        成交額: ${item.turnover.toLocaleString()} 千元<br/>
                        漲跌: <span style="color: ${item.change >= 0 ? '#ef5350' : '#26a69a'}">${item.change >= 0 ? '+' : ''}${item.change.toFixed(2)} (${item.changePercent >= 0 ? '+' : ''}${item.changePercent.toFixed(2)}%)</span>
                    </div>
                `;
                }
            },
            legend: {
                data: ['K線', ...maConfig.map(c => c.name), '成交量'],
                top: 40,
                left: 'center'
            },
            grid: [
                {
                    left: '8%',
                    right: '8%',
                    top: '15%',
                    height: '50%'
                },
                {
                    left: '8%',
                    right: '8%',
                    top: '70%',
                    height: '15%'
                }
            ],
            xAxis: [
                {
                    type: 'category',
                    data: dates,
                    boundaryGap: true,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: {
                        formatter: function (value) {
                            return value.substring(5);
                        }
                    },
                    min: 'dataMin',
                    max: 'dataMax',
                    axisPointer: {
                        show: true
                    }
                },
                {
                    type: 'category',
                    gridIndex: 1,
                    data: dates,
                    boundaryGap: true,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: { show: false },
                    axisTick: { show: false },
                    min: 'dataMin',
                    max: 'dataMax'
                }
            ],
            yAxis: [
                {
                    scale: true,
                    splitArea: {
                        show: true
                    },
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { show: true },
                    axisTick: { show: false },
                    axisLabel: {
                        formatter: '{value}'
                    }
                },
                {
                    scale: true,
                    gridIndex: 1,
                    splitNumber: 2,
                    axisLabel: { show: false },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    splitLine: { show: false }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: [0, 1],
                    start: zoomStart,
                    end: zoomEnd
                },
                {
                    show: true,
                    xAxisIndex: [0, 1],
                    type: 'slider',
                    bottom: '5%',
                    start: zoomStart,
                    end: zoomEnd,
                    handleIcon: 'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                    handleSize: '80%',
                    handleStyle: {
                        color: '#fff',
                        shadowBlur: 3,
                        shadowColor: 'rgba(0, 0, 0, 0.6)',
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    }
                }
            ],
            series: [
                {
                    name: 'K線',
                    type: 'candlestick',
                    data: ohlc,
                    itemStyle: {
                        color: '#ef5350',
                        color0: '#26a69a',
                        borderColor: '#ef5350',
                        borderColor0: '#26a69a'
                    },
                    emphasis: {
                        itemStyle: {
                            borderColor: '#000',
                            borderWidth: 2
                        }
                    },
                    markArea: sparseAreas.length > 0 ? {
                        silent: true,
                        itemStyle: {
                            color: 'rgba(255, 173, 177, 0.15)'
                        },
                        data: sparseAreas,
                        label: {
                            show: true,
                            position: 'insideTop',
                            formatter: '數據稀疏區域\n(休市期間)',
                            fontSize: 11,
                            color: '#999'
                        }
                    } : undefined
                },
                // 動態添加均線（後端已計算好）
                ...maConfig.map(config => ({
                    name: config.name,
                    type: 'line',
                    data: maData[config.name],
                    smooth: false,
                    lineStyle: {
                        width: 2,
                        color: config.color
                    },
                    showSymbol: false,
                    z: 1
                })),
                {
                    name: '成交量',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: volumes,
                    itemStyle: {
                        color: function (params) {
                            const item = data[params.dataIndex];
                            return item.close >= item.open ? '#ef5350' : '#26a69a';
                        }
                    }
                }
            ]
        };

        chart.setOption(option, true);
    }

    // 更新股票資訊
    function updateStockInfo(data) {
        const stockInfo = document.getElementById('stockInfo');
        const infoGrid = document.getElementById('infoGrid');

        const latestData = data[data.length - 1];
        const firstData = data[0];

        const periodChange = latestData.close - firstData.open;
        const periodChangePercent = (periodChange / firstData.open) * 100;

        infoGrid.innerHTML = `
        <div class="info-item stock-name-item">
            <div class="info-label">股票</div>
            <div class="info-value"><strong>${latestData.name || latestData.symbol}</strong> (${latestData.symbol})</div>
        </div>
        <div class="info-item">
            <div class="info-label">最新日期</div>
            <div class="info-value">${latestData.date}</div>
        </div>
        <div class="info-item">
            <div class="info-label">收盤價</div>
            <div class="info-value">${latestData.close.toFixed(2)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">當日漲跌</div>
            <div class="info-value ${latestData.change >= 0 ? 'positive' : 'negative'}">
                ${latestData.change >= 0 ? '+' : ''}${latestData.change.toFixed(2)} (${latestData.changePercent >= 0 ? '+' : ''}${latestData.changePercent.toFixed(2)}%)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">區間漲跌</div>
            <div class="info-value ${periodChange >= 0 ? 'positive' : 'negative'}">
                ${periodChange >= 0 ? '+' : ''}${periodChange.toFixed(2)} (${periodChangePercent >= 0 ? '+' : ''}${periodChangePercent.toFixed(2)}%)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">最高價</div>
            <div class="info-value">${latestData.high.toFixed(2)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">最低價</div>
            <div class="info-value">${latestData.low.toFixed(2)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">成交量</div>
            <div class="info-value">${latestData.volume.toLocaleString()} 張</div>
        </div>
        <div class="info-item">
            <div class="info-label">成交金額</div>
            <div class="info-value">${(latestData.turnover / 1000).toFixed(0)} 百萬</div>
        </div>
    `;

        stockInfo.classList.add('active');
    }

    // 事件監聽
    document.getElementById('queryBtn').addEventListener('click', queryKLine);

    document.getElementById('symbolInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            queryKLine();
        }
    });

    // 快速選股按鈕
    document.querySelectorAll('.quick-stock-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('symbolInput').value = btn.dataset.symbol;
            queryKLine();
        });
    });

    // 響應式調整
    window.addEventListener('resize', () => {
        if (chart) {
            chart.resize();
        }
    });

    // 初始化並自動查詢
    window.addEventListener('load', () => {
        initStockList();  // 初始化股票列表選項
        initChart();
        queryKLine();
    });
</script>
</body>

</html>