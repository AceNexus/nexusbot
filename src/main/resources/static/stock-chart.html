<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股K線圖查詢系統</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .header {
            background: white;
            color: #2c3e50;
            padding: 20px 24px;
            border-bottom: 1px solid #e8eaed;
        }

        .header h1 {
            font-size: 1.5em;
            margin: 0;
            font-weight: 600;
            color: #1a1a1a;
        }

        .controls {
            padding: 16px 24px;
            background: white;
            border-bottom: 1px solid #e8eaed;
        }

        .control-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .control-group {
            flex: 1;
            min-width: 240px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #3c4043;
            font-size: 0.9em;
        }

        .control-group input {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid #dadce0;
            border-radius: 6px;
            font-size: 0.95em;
            transition: all 0.2s;
            background: white;
        }

        .control-group input:focus {
            outline: none;
            border-color: #1a73e8;
            box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.1);
        }

        .btn {
            padding: 10px 24px;
            background: #1a73e8;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #1557b0;
        }

        .btn:active {
            background: #0d47a1;
        }

        .btn:disabled {
            background: #dadce0;
            color: #5f6368;
            cursor: not-allowed;
        }

        .stock-info {
            padding: 20px 24px;
            background: white;
            border-bottom: 1px solid #e8eaed;
            display: none;
        }

        .stock-info.active {
            display: block;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .info-item {
            padding: 14px;
            background: #fafbfc;
            border: 1px solid #e8eaed;
            border-radius: 6px;
            text-align: center;
        }

        .info-label {
            font-size: 0.8em;
            color: #5f6368;
            margin-bottom: 6px;
            font-weight: 400;
        }

        .info-value {
            font-size: 1.15em;
            font-weight: 600;
            color: #1a1a1a;
        }

        .info-value.positive {
            color: #d93025;
        }

        .info-value.negative {
            color: #0f9d58;
        }

        #chartContainer {
            padding: 24px;
        }

        #candlestickChart {
            width: 100%;
            height: 540px;
        }

        .loading {
            text-align: center;
            padding: 48px;
            color: #5f6368;
            font-size: 0.95em;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% {
                content: '.';
            }
            40% {
                content: '..';
            }
            60%, 100% {
                content: '...';
            }
        }

        .error {
            background: #fce8e6;
            color: #c5221f;
            padding: 16px 20px;
            margin: 24px;
            border-radius: 6px;
            border-left: 3px solid #d93025;
            font-size: 0.9em;
        }

        .quick-stocks {
            display: flex;
            gap: 8px;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        .quick-stock-btn {
            padding: 7px 14px;
            background: white;
            color: #5f6368;
            border: 1px solid #dadce0;
            border-radius: 16px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-stock-btn:hover {
            background: #f1f3f4;
            border-color: #1a73e8;
            color: #1a73e8;
        }

        /* 技術分析面板樣式 */
        .analysis-panel {
            margin: 12px 20px;
            background: white;
            border: 1px solid #e8eaed;
            border-radius: 6px;
            overflow: hidden;
        }

        .analysis-panel.active {
            display: block;
        }

        .analysis-header {
            background: #f8f9fa;
            color: #1a1a1a;
            padding: 14px 18px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e8eaed;
        }

        .analysis-header h3 {
            margin: 0;
            font-size: 1.15em;
            font-weight: 700;
        }

        /* 一頁式設計 - 移除折疊按鈕樣式 */
        /* .analysis-toggle {
            cursor: pointer;
            padding: 4px 10px;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 0.85em;
            color: #5f6368;
            transition: all 0.2s;
        }

        .analysis-toggle:hover {
            background: #f1f3f4;
            border-color: #1a73e8;
            color: #1a73e8;
        } */

        .analysis-summary {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 16px;
            padding: 18px;
        }

        .recommendation-box {
            background: #fafbfc;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            padding: 18px;
            text-align: center;
        }

        .recommendation-label {
            font-size: 0.85em;
            color: #5f6368;
            margin-bottom: 10px;
            font-weight: 400;
        }

        .recommendation-value {
            font-size: 2.4em;
            font-weight: 700;
            margin: 12px 0;
            letter-spacing: 1px;
        }

        .recommendation-value.buy {
            color: #d93025;
        }

        .recommendation-value.sell {
            color: #0f9d58;
        }

        .recommendation-value.wait {
            color: #5f6368;
        }

        .confidence-bar {
            width: 100%;
            height: 6px;
            background: #e8eaed;
            border-radius: 3px;
            overflow: hidden;
            margin: 12px 0;
        }

        .confidence-fill {
            height: 100%;
            background: #1a73e8;
            transition: width 0.4s ease;
        }

        .confidence-text {
            font-size: 0.8em;
            color: #5f6368;
            margin-top: 6px;
        }

        .signals-summary {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .signal-item {
            background: #fafbfc;
            padding: 12px 14px;
            border-radius: 6px;
            border-left: 3px solid #dadce0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .signal-item.buy {
            border-left-color: #d93025;
            background: #fce8e6;
        }

        .signal-item.sell {
            border-left-color: #0f9d58;
            background: #e6f4ea;
        }

        .signal-type {
            font-weight: 500;
            color: #1a1a1a;
            font-size: 0.9em;
        }

        .signal-description {
            font-size: 0.85em;
            color: #5f6368;
            margin-top: 4px;
        }

        .signal-strength {
            display: flex;
            gap: 3px;
        }

        .signal-strength span {
            width: 6px;
            height: 18px;
            background: #dadce0;
            border-radius: 2px;
        }

        .signal-strength span.active {
            background: #1a73e8;
        }

        /* analysis-detail 樣式已移除 */

        /* indicator-item 和 analysis-text 樣式已移除 */

        /* 進出場時機分析樣式 */
        .entry-exit-timing {
            padding: 18px;
            background: white;
            border-top: 1px solid #e8eaed;
        }

        .timing-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #e8eaed;
        }

        .timing-title {
            font-size: 1.25em;
            font-weight: 700;
            color: #1a1a1a;
        }

        .timing-action {
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.95em;
        }

        .timing-action.entry {
            background: #fce8e6;
            color: #d93025;
            border: 2px solid #d93025;
        }

        .timing-action.exit {
            background: #e6f4ea;
            color: #0f9d58;
            border: 2px solid #0f9d58;
        }

        .timing-action.wait {
            background: #f5f5f5;
            color: #5f6368;
            border: 2px solid #dadce0;
        }

        .timing-content {
            margin-bottom: 16px;
        }

        .timing-card {
            background: #fafbfc;
            border: 1px solid #e8eaed;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
        }

        .timing-card:hover {
            border-color: #dadce0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        .timing-card-title {
            font-size: 0.85em;
            color: #5f6368;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .timing-price {
            font-size: 1.6em;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .timing-price.entry-price {
            color: #d93025;
        }

        .timing-price.exit-price {
            color: #0f9d58;
        }

        .timing-price.stop-loss {
            color: #ea8600;
        }

        .timing-price.take-profit {
            color: #1a73e8;
        }

        .timing-subtitle {
            font-size: 0.8em;
            color: #5f6368;
            margin-top: 4px;
        }

        .timing-analysis-detail {
            background: #e8f0fe;
            border: 1px solid #d2e3fc;
            padding: 18px;
            border-radius: 8px;
            margin-top: 16px;
            border-left: 4px solid #1a73e8;
        }

        .timing-analysis-title {
            font-size: 1.05em;
            color: #1967d2;
            margin-bottom: 14px;
            font-weight: 700;
        }

        .timing-analysis-text {
            font-size: 0.9em;
            color: #1a1a1a;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        /* 價格區間樣式 - 新設計 */
        .price-section {
            margin-bottom: 28px;
            background: #fafbfc;
            border-radius: 8px;
            padding: 18px;
            border: 1px solid #e8eaed;
        }

        .price-section-header {
            font-size: 1.15em;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8eaed;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-range-value {
            font-size: 1.1em;
            color: #1a73e8;
            background: #e8f0fe;
            padding: 6px 14px;
            border-radius: 16px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .price-range-container {
            margin-bottom: 12px;
        }

        .price-range-visual {
            margin-bottom: 20px;
            padding: 12px;
            background: white;
            border-radius: 6px;
        }

        .price-range-bar {
            position: relative;
            height: 40px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
        }

        .price-range-bar.entry-bar {
            background: rgba(217, 48, 37, 0.12);
            border: 2px solid #d93025;
        }

        .price-range-bar.exit-bar {
            background: rgba(15, 157, 88, 0.12);
            border: 2px solid #0f9d58;
        }

        .range-label {
            font-size: 0.75em;
            font-weight: 600;
            color: rgba(0, 0, 0, 0.7);
        }

        .range-label.center {
            font-size: 0.85em;
            font-weight: 700;
        }

        .price-cards-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 14px;
        }

        .timing-card.compact {
            padding: 12px;
            min-height: auto;
        }

        .timing-card.featured {
            background: linear-gradient(135deg, #e8f0fe 0%, #ffffff 100%);
            border: 3px solid #1a73e8;
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.25);
            position: relative;
        }

        .timing-card.featured::before {
            content: '推薦';
            position: absolute;
            top: -10px;
            right: 16px;
            background: #1a73e8;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.3);
        }

        .timing-card.featured .timing-card-title {
            color: #1a73e8;
            font-weight: 700;
        }

        .timing-card.featured .timing-price {
            font-weight: 700;
        }

        /* K線型態與趨勢分析樣式 */
        .pattern-analysis {
            background: white;
            border: 1px solid #e8eaed;
            padding: 20px;
            margin: 20px;
            border-radius: 6px;
        }

        .pattern-section {
            margin-bottom: 20px;
        }

        .pattern-section:last-child {
            margin-bottom: 0;
        }

        .pattern-title {
            font-size: 1em;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e8eaed;
        }

        .pattern-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .pattern-tag {
            background: #f8f9fa;
            border: 1px solid #dadce0;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85em;
            color: #3c4043;
        }

        .pattern-tag.bullish {
            background: #e8f5e9;
            border-color: #81c784;
            color: #2e7d32;
        }

        .pattern-tag.bearish {
            background: #ffebee;
            border-color: #e57373;
            color: #c62828;
        }

        .trend-text {
            color: #3c4043;
            line-height: 1.75;
            font-size: 0.95em;
        }

        .volume-text {
            color: #3c4043;
            line-height: 1.75;
            font-size: 0.95em;
        }

        /* 免責聲明樣式 */
        .disclaimer {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-left: 5px solid #ff9800;
            padding: 16px 20px;
            margin: 20px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #856404;
            line-height: 1.6;
        }

        .disclaimer-title {
            font-weight: 700;
            font-size: 1.05em;
            margin-bottom: 8px;
            color: #ff6f00;
        }

        .disclaimer-text {
            margin: 0;
        }

        .disclaimer-text strong {
            color: #d84315;
        }

        /* 資料來源樣式 */
        .data-source {
            background: #f8f9fa;
            border-top: 1px solid #e8eaed;
            padding: 16px 24px;
            text-align: center;
            font-size: 0.85em;
            color: #5f6368;
            margin-top: 20px;
        }

        .data-source a {
            color: #1a73e8;
            text-decoration: none;
            font-weight: 500;
        }

        .data-source a:hover {
            text-decoration: underline;
        }

        /* K線型態與趨勢總結樣式 */
        .pattern-trend-summary {
            padding: 20px 24px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-top: 1px solid #e8eaed;
            border-bottom: 1px solid #e8eaed;
        }

        .summary-header {
            font-size: 1.1em;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 16px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .summary-card {
            background: white;
            border: 2px solid #e8eaed;
            border-radius: 8px;
            padding: 16px;
            transition: all 0.2s;
        }

        .summary-card:hover {
            border-color: #1a73e8;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.15);
            transform: translateY(-2px);
        }

        .summary-card-header {
            font-size: 0.85em;
            color: #5f6368;
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-card-content {
            font-size: 1.3em;
            font-weight: 700;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .summary-card-content.bullish {
            color: #d93025;
        }

        .summary-card-content.bearish {
            color: #0f9d58;
        }

        .summary-card-content.neutral {
            color: #5f6368;
        }

        .trend-arrow {
            font-size: 1.5em;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .pattern-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .pattern-badge {
            background: #f1f3f4;
            border: 1px solid #dadce0;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            color: #3c4043;
            font-weight: 500;
        }

        .pattern-badge.bullish {
            background: #e8f5e9;
            border-color: #81c784;
            color: #2e7d32;
        }

        .pattern-badge.bearish {
            background: #ffebee;
            border-color: #e57373;
            color: #c62828;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .control-row {
                flex-direction: column;
            }

            .control-group {
                width: 100%;
            }

            #candlestickChart {
                height: 400px;
            }
        }
    </style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>台股技術分析</h1>
    </div>

    <div class="controls">
        <div class="control-row">
            <div class="control-group">
                <label for="symbolInput">股票代號或名稱</label>
                <input type="text" id="symbolInput" placeholder="例如：2330 或 台積電" value="2330" list="stockList"
                       autocomplete="off">
                <datalist id="stockList"></datalist>
            </div>
            <button class="btn" id="queryBtn">查詢K線</button>
        </div>

        <div class="quick-stocks">
            <button class="quick-stock-btn" data-symbol="2330">台積電</button>
            <button class="quick-stock-btn" data-symbol="2317">鴻海</button>
            <button class="quick-stock-btn" data-symbol="2454">聯發科</button>
            <button class="quick-stock-btn" data-symbol="2412">中華電</button>
        </div>
    </div>

    <div class="stock-info" id="stockInfo">
        <div class="info-grid" id="infoGrid">
            <!-- 動態生成股票資訊 -->
        </div>
    </div>

    <!-- 技術分析面板 -->
    <div class="analysis-panel" id="analysisPanel" style="display: none;">
        <div class="analysis-summary">
            <div class="signals-summary" id="signalsSummary">
                <!-- 動態生成訊號摘要 -->
            </div>
        </div>

        <!-- K線型態與趨勢總結 -->
        <div class="pattern-trend-summary" id="patternTrendSummary" style="display: none;">
            <div class="summary-header">當前K線型態與趨勢</div>
            <div class="summary-grid">
                <!-- 趨勢卡片 -->
                <div class="summary-card">
                    <div class="summary-card-header">趨勢方向</div>
                    <div class="summary-card-content" id="trendSummary">
                        <span class="trend-arrow" id="trendArrow">-</span>
                        <span id="trendSummaryText">-</span>
                    </div>
                </div>

                <!-- 型態卡片 -->
                <div class="summary-card">
                    <div class="summary-card-header">K線型態</div>
                    <div class="summary-card-content" id="patternSummary">
                        <span id="patternSummaryText">-</span>
                    </div>
                    <div class="pattern-badges" id="patternBadges">
                        <!-- 動態生成型態標籤 -->
                    </div>
                </div>

                <!-- 量價關係卡片 -->
                <div class="summary-card">
                    <div class="summary-card-header">量價配合</div>
                    <div class="summary-card-content" id="volumeSummary">
                        <span id="volumeSummaryText">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 進出場時機分析 -->
        <div class="entry-exit-timing" id="entryExitTiming" style="display: none;">
            <div class="timing-header">
                <h4 class="timing-title">價格建議</h4>
                <span class="timing-action" id="timingAction">-</span>
            </div>

            <div class="timing-content" id="timingContent">
                <!-- 動態生成進出場價位資訊 -->
            </div>

            <div class="timing-analysis-detail" id="timingAnalysisDetail" style="display: none;">
                <div class="timing-analysis-title">分析與建議</div>
                <div class="timing-analysis-text" id="timingAnalysisText">-</div>
            </div>
        </div>
    </div>

    <div id="chartContainer">
        <div id="candlestickChart"></div>
    </div>

    <!-- 資料來源標示 -->
    <div class="data-source" id="dataSource" style="display: none;">
        資料來源：<a href="https://finmind.github.io/" target="_blank" rel="noopener noreferrer">FinMind
        台灣金融資料庫</a>
        ｜技術分析演算法：NexusBot 自主研發
        ｜最後更新時間：<span id="lastUpdateTime">-</span>
    </div>

    <!-- 免責聲明 -->
    <div class="disclaimer" id="disclaimer" style="display: none;">
        <div class="disclaimer-title">
            重要聲明
        </div>
        <div class="disclaimer-text">
            本技術分析結果<strong>僅供參考，不構成投資建議</strong>。股票投資有風險，過往績效不代表未來表現。
            技術指標可能產生誤判，請投資人自行審慎評估風險，並考量個人財務狀況後再做投資決策。
            本系統不對任何投資損失負責。
        </div>
    </div>
</div>

<script>
    let chart;
    // 自動偵測 API 基礎 URL
    // 如果從 Spring Boot (port 5001) 提供服務，使用當前 origin
    // 否則使用預設的 localhost:5001
    const API_BASE = window.location.port === '5001'
        ? window.location.origin
        : 'http://localhost:5001';

    // 常用台股列表（代號和中文名稱）
    // 初始化股票列表選項
    async function initStockList() {
        console.log('========== initStockList ==========');
        const datalist = document.getElementById('stockList');
        const input = document.getElementById('symbolInput');

        // 顯示載入中提示
        input.placeholder = "載入股票列表中...";

        try {
            console.log('正在從 API 獲取股票列表...');
            const response = await fetch(`${API_BASE}/api/stock/list`);

            if (!response.ok) {
                throw new Error(`獲取股票列表失敗: ${response.status}`);
            }

            const stocks = await response.json();
            console.log('股票列表獲取成功，共', stocks.length, '筆');

            // 全域變數儲存，供搜尋使用
            window.allStocks = stocks;

            // 清空舊選項
            datalist.innerHTML = '';

            // 建立 Fragment 以提升效能
            const fragment = document.createDocumentFragment();

            stocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = `${stock.symbol} ${stock.name}`;
                option.dataset.symbol = stock.symbol;
                fragment.appendChild(option);
            });

            datalist.appendChild(fragment);
            console.log('datalist 更新完成');

            // 恢復輸入框提示
            input.placeholder = "請輸入股票代號或名稱";

        } catch (error) {
            console.error('初始化股票列表錯誤:', error);
            input.placeholder = "股票列表載入失敗，請手動輸入代號";

            // 發生錯誤時，至少保留熱門股以供使用 (Fallback)
            const fallbackStocks = [
                { symbol: '2330', name: '台積電' },
                { symbol: '2317', name: '鴻海' },
                { symbol: '2454', name: '聯發科' }
            ];
            window.allStocks = fallbackStocks;

            // 建立 Fragment
            const fragment = document.createDocumentFragment();
            fallbackStocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = `${stock.symbol} ${stock.name}`;
                fragment.appendChild(option);
            });
            datalist.appendChild(fragment);
        }
    }

    // 將輸入轉換為股票代號
    function parseSymbolInput(input) {
        // 去除空白
        input = input.trim();
        console.log('========== parseSymbolInput ==========');
        console.log('原始輸入:', input);

        const stocks = window.allStocks || [];

        // 如果是純數字，直接返回
        if (/^\d+$/.test(input)) {
            console.log('✓ 匹配純數字:', input);
            return input;
        }

        // 嘗試從 "代號 名稱" 格式中提取代號
        const match = input.match(/^(\d+)\s/);
        if (match) {
            console.log('✓ 匹配 "代號 名稱" 格式:', match[1]);
            return match[1];
        }

        // 嘗試根據中文名稱查找
        console.log('嘗試在股票列表中查找:', input);
        if (stocks.length > 0) {
            const stock = stocks.find(s => s.name === input || s.name.includes(input));
            if (stock) {
                console.log('✓ 找到匹配:', stock.symbol, stock.name);
                return stock.symbol;
            }
        }

        // 都找不到，返回原輸入
        console.log('✗ 找不到匹配，返回原輸入:', input);
        return input;
    }

    // 初始化圖表
    function initChart() {
        const chartDom = document.getElementById('candlestickChart');
        chart = echarts.init(chartDom);
        chart.showLoading({
            text: '載入中...',
            color: '#667eea',
            textColor: '#000',
            maskColor: 'rgba(255, 255, 255, 0.8)',
            zlevel: 0
        });
    }

    // 查詢K線數據
    async function queryKLine() {
        const input = document.getElementById('symbolInput').value.trim();
        const symbol = parseSymbolInput(input);
        const queryBtn = document.getElementById('queryBtn');

        console.log('解析後的股票代號:', symbol);

        if (!symbol) {
            alert('請輸入股票代號或名稱');
            return;
        }

        queryBtn.disabled = true;
        queryBtn.textContent = '查詢中...';
        chart.showLoading();

        try {
            // 使用優化的 API：顯示 12 個月，基於 18 個月計算均線
            const apiUrl = `${API_BASE}/api/stock/${symbol}/candlestick-with-ma?displayMonths=12&maBaseMonths=18`;
            console.log('API URL:', apiUrl);
            const response = await fetch(apiUrl);

            if (!response.ok) {
                throw new Error(`查詢失敗: ${response.status}`);
            }

            const data = await response.json();

            if (!data || data.length === 0) {
                throw new Error('查無數據');
            }

            // 保存數據供調試使用
            window.latestData = data;
            console.log('已載入', data.length, '筆 K 線數據');
            console.log('前 3 筆數據範例：', data.slice(0, 3));

            renderChart(data, symbol);
            updateStockInfo(data);

            // 顯示免責聲明和資料來源
            document.getElementById('disclaimer').style.display = 'block';
            document.getElementById('dataSource').style.display = 'block';

            // 更新最後更新時間
            const now = new Date();
            const timeStr = now.getFullYear() + '-' +
                          String(now.getMonth() + 1).padStart(2, '0') + '-' +
                          String(now.getDate()).padStart(2, '0') + ' ' +
                          String(now.getHours()).padStart(2, '0') + ':' +
                          String(now.getMinutes()).padStart(2, '0');
            document.getElementById('lastUpdateTime').textContent = timeStr;

            // 查詢技術分析
            fetchTechnicalAnalysis(symbol);

        } catch (error) {
            console.error('Error:', error);
            chart.hideLoading();
            const chartDom = document.getElementById('candlestickChart');
            chartDom.innerHTML = `<div class="error">查詢失敗: ${error.message}</div>`;
        } finally {
            queryBtn.disabled = false;
            queryBtn.textContent = '查詢K線';
        }
    }

    // 查詢技術分析
    async function fetchTechnicalAnalysis(symbol) {
        try {
            const response = await fetch(`${API_BASE}/api/stock/${symbol}/analysis`);

            if (!response.ok) {
                console.warn('技術分析查詢失敗:', response.status);
                document.getElementById('analysisPanel').style.display = 'none';
                return;
            }

            const analysis = await response.json();
            displayTechnicalAnalysis(analysis);

        } catch (error) {
            console.error('技術分析錯誤:', error);
            document.getElementById('analysisPanel').style.display = 'none';
        }
    }

    // 顯示技術分析結果
    function displayTechnicalAnalysis(analysis) {
        const panel = document.getElementById('analysisPanel');
        panel.style.display = 'block';

        // 顯示訊號摘要
        const signalsSummary = document.getElementById('signalsSummary');
        signalsSummary.innerHTML = '';

        if (analysis.signals && analysis.signals.length > 0) {
            // 只顯示前 3 個最重要的訊號
            analysis.signals.slice(0, 3).forEach(signal => {
                const signalDiv = document.createElement('div');
                signalDiv.className = `signal-item ${signal.direction === '買進' ? 'buy' : 'sell'}`;

                // 強度顯示
                const strengthHtml = Array(5).fill(0).map((_, i) =>
                    `<span class="${i < signal.strength ? 'active' : ''}"></span>`
                ).join('');

                signalDiv.innerHTML = `
                <div>
                    <div class="signal-type">${signal.type}</div>
                    <div class="signal-description">${signal.description}</div>
                </div>
                <div class="signal-strength">${strengthHtml}</div>
            `;
                signalsSummary.appendChild(signalDiv);
            });
        } else {
            signalsSummary.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暫無明顯訊號</div>';
        }

        // 技術指標與分析文字顯示已移除

        // 顯示K線型態與趨勢總結
        displayPatternTrendSummary(analysis);

        // 顯示進出場時機分析
        if (analysis.entryExitTiming) {
            displayEntryExitTiming(analysis.entryExitTiming);
        }
    }

    // 顯示K線型態與趨勢總結（新增）
    function displayPatternTrendSummary(analysis) {
        const summaryPanel = document.getElementById('patternTrendSummary');
        const trendSummaryText = document.getElementById('trendSummaryText');
        const trendSummary = document.getElementById('trendSummary');
        const trendArrow = document.getElementById('trendArrow');
        const patternSummaryText = document.getElementById('patternSummaryText');
        const patternBadges = document.getElementById('patternBadges');
        const volumeSummaryText = document.getElementById('volumeSummaryText');
        const volumeSummary = document.getElementById('volumeSummary');

        let hasContent = false;

        // 1. 趨勢分析
        if (analysis.trendDescription) {
            const trend = analysis.trendDescription;
            trendSummaryText.textContent = trend;

            // 判斷趨勢方向並設定箭頭和顏色
            if (trend.includes('強勢上升') || trend.includes('多頭格局') || trend.includes('上升趨勢')) {
                trendArrow.textContent = '↗';
                trendSummary.classList.add('bullish');
                trendSummary.classList.remove('bearish', 'neutral');
            } else if (trend.includes('弱勢下降') || trend.includes('空頭格局') || trend.includes('下降趨勢')) {
                trendArrow.textContent = '↘';
                trendSummary.classList.add('bearish');
                trendSummary.classList.remove('bullish', 'neutral');
            } else if (trend.includes('盤整') || trend.includes('橫盤')) {
                trendArrow.textContent = '→';
                trendSummary.classList.add('neutral');
                trendSummary.classList.remove('bullish', 'bearish');
            } else {
                trendArrow.textContent = '•';
                trendSummary.classList.add('neutral');
                trendSummary.classList.remove('bullish', 'bearish');
            }
            hasContent = true;
        }

        // 2. K線型態
        const patterns = analysis.candlestickPatternDetails || [];
        if (patterns.length > 0) {
            // 主要型態文字
            const mainPattern = patterns[0];
            patternSummaryText.textContent = `${mainPattern.name} [${mainPattern.reliability}] - ${mainPattern.description}`;

            // 型態標籤
            patternBadges.innerHTML = '';
            patterns.slice(0, 3).forEach(pattern => {
                const badge = document.createElement('div');
                badge.className = 'pattern-badge';

                // 根據 bullish 屬性設定樣式
                if (pattern.bullish === true) {
                    badge.classList.add('bullish');
                } else if (pattern.bullish === false) {
                    badge.classList.add('bearish');
                }

                // 顯示型態名稱和可靠度
                badge.innerHTML = `<span class="pattern-name">${pattern.name}</span> <span class="pattern-reliability">[${pattern.reliability}]</span>`;

                // Tooltip 顯示詳細說明
                badge.title = pattern.description;

                patternBadges.appendChild(badge);
            });
            hasContent = true;
        } else {
            patternSummaryText.textContent = '無明顯型態';
            patternBadges.innerHTML = '';
        }

        // 3. 量價關係
        if (analysis.priceVolumeAnalysis) {
            const volumeText = analysis.priceVolumeAnalysis;
            volumeSummaryText.textContent = volumeText;

            // 判斷量價關係並設定顏色
            if (volumeText.includes('價漲量增') || volumeText.includes('多頭強勢')) {
                volumeSummary.classList.add('bullish');
                volumeSummary.classList.remove('bearish', 'neutral');
            } else if (volumeText.includes('價跌量增') || volumeText.includes('空頭出籠')) {
                volumeSummary.classList.add('bearish');
                volumeSummary.classList.remove('bullish', 'neutral');
            } else {
                volumeSummary.classList.add('neutral');
                volumeSummary.classList.remove('bullish', 'bearish');
            }
            hasContent = true;
        }

        // 顯示或隱藏總結面板
        summaryPanel.style.display = hasContent ? 'block' : 'none';
    }

    // 顯示K線型態分析（僅保留型態識別）
    function displayPatternAnalysis(analysis) {
        const patternAnalysisPanel = document.getElementById('patternAnalysis');
        const patternSection = document.getElementById('patternSection');

        // 顯示K線型態識別
        const patterns = analysis.candlestickPatternDetails || [];
        if (patterns.length > 0) {
            const patternList = document.getElementById('patternList');
            patternList.innerHTML = '';

            patterns.forEach(pattern => {
                const tag = document.createElement('div');
                tag.className = 'pattern-tag';

                // 根據 bullish 屬性設定樣式
                if (pattern.bullish === true) {
                    tag.classList.add('bullish');
                } else if (pattern.bullish === false) {
                    tag.classList.add('bearish');
                }

                // 顯示型態名稱、可靠度和說明
                tag.innerHTML = `<strong>${pattern.name}</strong> [${pattern.reliability}]<br/><small>${pattern.description}</small>`;

                patternList.appendChild(tag);
            });

            patternSection.style.display = 'block';
            patternAnalysisPanel.style.display = 'block';
        } else {
            patternSection.style.display = 'none';
            patternAnalysisPanel.style.display = 'none';
        }
    }

    // 顯示進出場時機分析
    function displayEntryExitTiming(timing) {
        const timingPanel = document.getElementById('entryExitTiming');
        const timingAction = document.getElementById('timingAction');
        const timingContent = document.getElementById('timingContent');
        const timingAnalysisDetail = document.getElementById('timingAnalysisDetail');
        const timingAnalysisText = document.getElementById('timingAnalysisText');

        // 顯示面板
        timingPanel.style.display = 'block';

        // 顯示操作建議
        timingAction.textContent = timing.action;
        timingAction.className = 'timing-action';
        if (timing.action === '進場') {
            timingAction.classList.add('entry');
        } else if (timing.action === '出場') {
            timingAction.classList.add('exit');
        } else {
            timingAction.classList.add('wait');
        }

        // 清空內容
        timingContent.innerHTML = '';

        // === 進場價格區間 ===
        if (timing.entryPrice !== null && timing.entryPrice !== undefined) {
            const entrySection = document.createElement('div');
            entrySection.className = 'price-section';

            // 計算價格區間
            const entryMin = timing.entryPriceMin !== null ? timing.entryPriceMin : timing.entryPrice;
            const entryMax = timing.entryPriceMax !== null ? timing.entryPriceMax : timing.entryPrice;
            const entryRangeText = entryMin !== entryMax
                ? `${entryMin.toFixed(2)} - ${entryMax.toFixed(2)}`
                : timing.entryPrice.toFixed(2);

            let entryHTML = `<div class="price-section-header">買入價格區間<span class="price-range-value">${entryRangeText}</span></div>`;
            entryHTML += '<div class="price-range-container">';

            // 價格區間視覺化（僅顯示範圍，不顯示具體數字）
            if (timing.entryPriceMin !== null && timing.entryPriceMax !== null) {
                entryHTML += '<div class="price-range-visual">';
                entryHTML += `<div class="price-range-bar entry-bar">`;
                entryHTML += `<span class="range-label">保守</span>`;
                entryHTML += `<span class="range-label center">建議</span>`;
                entryHTML += `<span class="range-label">積極</span>`;
                entryHTML += '</div></div>';
            }

            // 價格卡片
            entryHTML += '<div class="price-cards-row">';

            if (timing.entryPriceMin !== null && timing.entryPriceMin !== undefined) {
                entryHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">最佳買入價</div>
                        <div class="timing-price entry-price">${timing.entryPriceMin.toFixed(2)}</div>
                        <div class="timing-subtitle">保守策略・耐心等待</div>
                    </div>
                `;
            }

            entryHTML += `
                <div class="timing-card compact featured">
                    <div class="timing-card-title">建議買入價</div>
                    <div class="timing-price entry-price" style="font-size: 1.8em;">${timing.entryPrice.toFixed(2)}</div>
                    <div class="timing-subtitle">平衡風險與機會</div>
                </div>
            `;

            if (timing.entryPriceMax !== null && timing.entryPriceMax !== undefined) {
                entryHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">可接受買入價</div>
                        <div class="timing-price entry-price">${timing.entryPriceMax.toFixed(2)}</div>
                        <div class="timing-subtitle">積極策略・急於進場</div>
                    </div>
                `;
            }

            entryHTML += '</div></div>';
            entrySection.innerHTML = entryHTML;
            timingContent.appendChild(entrySection);
        }

        // === 出場價格區間 ===
        if (timing.exitPrice !== null && timing.exitPrice !== undefined) {
            const exitSection = document.createElement('div');
            exitSection.className = 'price-section';

            // 計算價格區間
            const exitMin = timing.exitPriceMin !== null ? timing.exitPriceMin : timing.exitPrice;
            const exitMax = timing.exitPriceMax !== null ? timing.exitPriceMax : timing.exitPrice;
            const exitRangeText = exitMin !== exitMax
                ? `${exitMin.toFixed(2)} - ${exitMax.toFixed(2)}`
                : timing.exitPrice.toFixed(2);

            let exitHTML = `<div class="price-section-header">賣出價格區間<span class="price-range-value">${exitRangeText}</span></div>`;
            exitHTML += '<div class="price-range-container">';

            // 價格區間視覺化（僅顯示範圍，不顯示具體數字）
            if (timing.exitPriceMin !== null && timing.exitPriceMax !== null) {
                exitHTML += '<div class="price-range-visual">';
                exitHTML += `<div class="price-range-bar exit-bar">`;
                exitHTML += `<span class="range-label">保守</span>`;
                exitHTML += `<span class="range-label center">建議</span>`;
                exitHTML += `<span class="range-label">積極</span>`;
                exitHTML += '</div></div>';
            }

            // 價格卡片
            exitHTML += '<div class="price-cards-row">';

            if (timing.exitPriceMin !== null && timing.exitPriceMin !== undefined) {
                exitHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">保守賣出價</div>
                        <div class="timing-price exit-price">${timing.exitPriceMin.toFixed(2)}</div>
                        <div class="timing-subtitle">確保獲利・提早出場</div>
                    </div>
                `;
            }

            exitHTML += `
                <div class="timing-card compact featured">
                    <div class="timing-card-title">建議賣出價</div>
                    <div class="timing-price exit-price" style="font-size: 1.8em;">${timing.exitPrice.toFixed(2)}</div>
                    <div class="timing-subtitle">平衡風險與收益</div>
                </div>
            `;

            if (timing.exitPriceMax !== null && timing.exitPriceMax !== undefined) {
                exitHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">最佳賣出價</div>
                        <div class="timing-price exit-price">${timing.exitPriceMax.toFixed(2)}</div>
                        <div class="timing-subtitle">積極策略・等待高點</div>
                    </div>
                `;
            }

            exitHTML += '</div></div>';
            exitSection.innerHTML = exitHTML;
            timingContent.appendChild(exitSection);
        }

        // === 風險控制與目標區 ===
        const hasRiskControl = timing.stopLossPrice || timing.takeProfit1 || timing.takeProfit2 || timing.riskRewardRatio || timing.positionSize;

        if (hasRiskControl) {
            const riskSection = document.createElement('div');
            riskSection.className = 'price-section';

            let riskHTML = '<div class="price-section-header">風險控制與目標</div>';
            riskHTML += '<div class="price-cards-row">';

            // 停損價
            if (timing.stopLossPrice !== null && timing.stopLossPrice !== undefined) {
                riskHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">停損價位</div>
                        <div class="timing-price stop-loss">${timing.stopLossPrice.toFixed(2)}</div>
                        <div class="timing-subtitle">跌破此價位停損</div>
                    </div>
                `;
            }

            // 第一停利價
            if (timing.takeProfit1 !== null && timing.takeProfit1 !== undefined) {
                riskHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">第一目標價</div>
                        <div class="timing-price take-profit">${timing.takeProfit1.toFixed(2)}</div>
                        <div class="timing-subtitle">建議分批出場 50%</div>
                    </div>
                `;
            }

            // 第二停利價
            if (timing.takeProfit2 !== null && timing.takeProfit2 !== undefined) {
                riskHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">第二目標價</div>
                        <div class="timing-price take-profit">${timing.takeProfit2.toFixed(2)}</div>
                        <div class="timing-subtitle">建議全部出場</div>
                    </div>
                `;
            }

            // 風險報酬比
            if (timing.riskRewardRatio) {
                riskHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">風險報酬比</div>
                        <div class="timing-price" style="color: #1a73e8;">${timing.riskRewardRatio}</div>
                        <div class="timing-subtitle">每 1 元風險的潛在報酬</div>
                    </div>
                `;
            }

            // 建議部位大小
            if (timing.positionSize !== null && timing.positionSize !== undefined) {
                const positionLabel = timing.action === '進場' ? '建議資金配置比例' : timing.action === '出場' ? '建議出場比例' : '不建議操作';
                riskHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">建議部位</div>
                        <div class="timing-price" style="color: #9334e6;">${timing.positionSize}%</div>
                        <div class="timing-subtitle">${positionLabel}</div>
                    </div>
                `;
            }

            riskHTML += '</div>';
            riskSection.innerHTML = riskHTML;
            timingContent.appendChild(riskSection);
        }

        // 顯示整合的分析與建議
        if (timing.analysisDetail) {
            timingAnalysisDetail.style.display = 'block';
            timingAnalysisText.textContent = timing.analysisDetail;
        } else {
            timingAnalysisDetail.style.display = 'none';
        }
    }

    // 渲染圖表
    function renderChart(data, symbol) {
        chart.hideLoading();

        // 準備數據
        const dates = data.map(item => item.date);
        const ohlc = data.map(item => [item.open, item.close, item.low, item.high]);
        const volumes = data.map(item => item.volume);

        // 調試：檢查影線
        const sampleData = data.slice(0, 5);
        console.log('檢查前 5 筆 K 線數據：');
        sampleData.forEach((item, idx) => {
            const upperShadow = item.high - Math.max(item.open, item.close);
            const lowerShadow = Math.min(item.open, item.close) - item.low;
            console.log(`  ${idx + 1}. ${item.date}:`, {
                開盤: item.open,
                收盤: item.close,
                最高: item.high,
                最低: item.low,
                上影線: upperShadow.toFixed(2),
                下影線: lowerShadow.toFixed(2)
            });
        });

        // SMA 均線配置（實線）
        const maConfig = [
            { name: 'MA5', color: '#FF1493', dashStyle: 'solid' },
            { name: 'MA10', color: '#00CED1', dashStyle: 'solid' },
            { name: 'MA20', color: '#FFD700', dashStyle: 'solid' },
            { name: 'MA60', color: '#9370DB', dashStyle: 'solid' }
        ];

        // EMA 均線配置（虛線）
        const emaConfig = [
            { name: 'EMA5', color: '#FF69B4', dashStyle: 'dashed' },
            { name: 'EMA10', color: '#00BFFF', dashStyle: 'dashed' },
            { name: 'EMA20', color: '#FFD700', dashStyle: 'dashed' },
            { name: 'EMA60', color: '#BA55D3', dashStyle: 'dashed' }
        ];

        // 提取均線數據（後端已計算好）
        const maData = {
            'MA5': data.map(item => item.ma5),
            'MA10': data.map(item => item.ma10),
            'MA20': data.map(item => item.ma20),
            'MA60': data.map(item => item.ma60)
        };

        // 提取 EMA 數據
        const emaData = {
            'EMA5': data.map(item => item.ema5),
            'EMA10': data.map(item => item.ema10),
            'EMA20': data.map(item => item.ema20),
            'EMA60': data.map(item => item.ema60)
        };

        // 檢測稀疏數據區域（用於視覺標記）
        const isSparseData = new Array(data.length).fill(false);
        for (let i = 1; i < data.length; i++) {
            const prevDate = new Date(data[i - 1].date);
            const currDate = new Date(data[i].date);
            const daysDiff = (currDate - prevDate) / (1000 * 60 * 60 * 24);

            if (daysDiff > 5) {
                for (let j = Math.max(0, i - 5); j <= Math.min(data.length - 1, i + 5); j++) {
                    isSparseData[j] = true;
                }
            }
        }

        // 計算顯示範圍：預設顯示全部 12 個月
        const zoomStart = 0;
        const zoomEnd = 100;

        // 找出稀疏數據區域，用於標記
        const sparseAreas = [];
        let areaStart = null;
        for (let i = 0; i < isSparseData.length; i++) {
            if (isSparseData[i] && areaStart === null) {
                areaStart = i;
            } else if (!isSparseData[i] && areaStart !== null) {
                sparseAreas.push([{ xAxis: dates[areaStart] }, { xAxis: dates[i - 1] }]);
                areaStart = null;
            }
        }
        if (areaStart !== null) {
            sparseAreas.push([{ xAxis: dates[areaStart] }, { xAxis: dates[dates.length - 1] }]);
        }

        const option = {
            title: {
                text: `${symbol} K線圖`,
                left: 'center',
                textStyle: {
                    fontSize: 20,
                    fontWeight: 600,
                    color: '#212529'
                }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
                formatter: function (params) {
                    const dataIndex = params[0].dataIndex;
                    const item = data[dataIndex];

                    let maInfo = '';
                    maConfig.forEach(config => {
                        const maValue = maData[config.name][dataIndex];
                        if (maValue !== null && maValue !== undefined) {
                            maInfo += `<span style="color: ${config.color}; font-weight: 600;">${config.name}: ${maValue.toFixed(2)}</span><br/>`;
                        }
                    });

                    let emaInfo = '';
                    emaConfig.forEach(config => {
                        const emaValue = emaData[config.name][dataIndex];
                        if (emaValue !== null && emaValue !== undefined) {
                            emaInfo += `<span style="color: ${config.color}; font-weight: 600;">${config.name}: ${emaValue.toFixed(2)}</span><br/>`;
                        }
                    });

                    return `
                    <div style="padding: 10px;">
                        <strong>${item.date}</strong><br/>
                        開盤: ${item.open.toFixed(2)}<br/>
                        最高: ${item.high.toFixed(2)}<br/>
                        最低: ${item.low.toFixed(2)}<br/>
                        收盤: ${item.close.toFixed(2)}<br/>
                        ${maInfo}
                        ${emaInfo}
                        成交量: ${item.volume.toLocaleString()} 張<br/>
                        成交額: ${item.turnover.toLocaleString()} 千元<br/>
                        漲跌: <span style="color: ${item.change >= 0 ? '#ef5350' : '#26a69a'}">${item.change >= 0 ? '+' : ''}${item.change.toFixed(2)} (${item.changePercent >= 0 ? '+' : ''}${item.changePercent.toFixed(2)}%)</span>
                    </div>
                `;
                }
            },
            legend: {
                data: ['K線', ...maConfig.map(c => c.name), ...emaConfig.map(c => c.name), '成交量'],
                top: 40,
                left: 'center'
            },
            grid: [
                {
                    left: '8%',
                    right: '8%',
                    top: '15%',
                    height: '50%'
                },
                {
                    left: '8%',
                    right: '8%',
                    top: '70%',
                    height: '15%'
                }
            ],
            xAxis: [
                {
                    type: 'category',
                    data: dates,
                    boundaryGap: true,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: {
                        formatter: function (value) {
                            return value.substring(5);
                        }
                    },
                    min: 'dataMin',
                    max: 'dataMax',
                    axisPointer: {
                        show: true
                    }
                },
                {
                    type: 'category',
                    gridIndex: 1,
                    data: dates,
                    boundaryGap: true,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: { show: false },
                    axisTick: { show: false },
                    min: 'dataMin',
                    max: 'dataMax'
                }
            ],
            yAxis: [
                {
                    scale: true,
                    splitArea: {
                        show: true
                    },
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { show: true },
                    axisTick: { show: false },
                    axisLabel: {
                        formatter: '{value}'
                    }
                },
                {
                    scale: true,
                    gridIndex: 1,
                    splitNumber: 2,
                    axisLabel: { show: false },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    splitLine: { show: false }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: [0, 1],
                    start: zoomStart,
                    end: zoomEnd
                },
                {
                    show: true,
                    xAxisIndex: [0, 1],
                    type: 'slider',
                    bottom: '5%',
                    start: zoomStart,
                    end: zoomEnd,
                    handleIcon: 'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                    handleSize: '80%',
                    handleStyle: {
                        color: '#fff',
                        shadowBlur: 3,
                        shadowColor: 'rgba(0, 0, 0, 0.6)',
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    }
                }
            ],
            series: [
                {
                    name: 'K線',
                    type: 'candlestick',
                    data: ohlc,
                    itemStyle: {
                        color: '#ef5350',        // 陽線實體顏色（紅色）
                        color0: '#26a69a',       // 陰線實體顏色（綠色）
                        borderColor: '#ef5350',  // 陽線邊框和影線顏色
                        borderColor0: '#26a69a', // 陰線邊框和影線顏色
                        borderWidth: 1           // 邊框和影線寬度（關鍵！）
                    },
                    emphasis: {
                        itemStyle: {
                            borderColor: '#000',
                            borderWidth: 2
                        }
                    },
                    markArea: sparseAreas.length > 0 ? {
                        silent: true,
                        itemStyle: {
                            color: 'rgba(255, 173, 177, 0.15)'
                        },
                        data: sparseAreas,
                        label: {
                            show: true,
                            position: 'insideTop',
                            formatter: '數據稀疏區域\n(休市期間)',
                            fontSize: 11,
                            color: '#999'
                        }
                    } : undefined
                },
                // 動態添加 SMA 均線（實線）
                ...maConfig.map(config => ({
                    name: config.name,
                    type: 'line',
                    data: maData[config.name],
                    smooth: false,
                    lineStyle: {
                        width: 2,
                        color: config.color,
                        type: 'solid'
                    },
                    showSymbol: false,
                    z: 1
                })),
                // 動態添加 EMA 均線（虛線）
                ...emaConfig.map(config => ({
                    name: config.name,
                    type: 'line',
                    data: emaData[config.name],
                    smooth: false,
                    lineStyle: {
                        width: 2,
                        color: config.color,
                        type: 'dashed'
                    },
                    showSymbol: false,
                    z: 1
                })),
                {
                    name: '成交量',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: volumes,
                    itemStyle: {
                        color: function (params) {
                            const item = data[params.dataIndex];
                            return item.close >= item.open ? '#ef5350' : '#26a69a';
                        }
                    }
                }
            ]
        };

        chart.setOption(option, true);
    }

    // 更新股票資訊
    function updateStockInfo(data) {
        const stockInfo = document.getElementById('stockInfo');
        const infoGrid = document.getElementById('infoGrid');

        const latestData = data[data.length - 1];
        const firstData = data[0];

        const periodChange = latestData.close - firstData.open;
        const periodChangePercent = (periodChange / firstData.open) * 100;

        infoGrid.innerHTML = `
        <div class="info-item stock-name-item">
            <div class="info-label">股票</div>
            <div class="info-value"><strong>${latestData.name || latestData.symbol}</strong> (${latestData.symbol})</div>
        </div>
        <div class="info-item">
            <div class="info-label">最新日期</div>
            <div class="info-value">${latestData.date}</div>
        </div>
        <div class="info-item">
            <div class="info-label">收盤價</div>
            <div class="info-value">${latestData.close.toFixed(2)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">當日漲跌</div>
            <div class="info-value ${latestData.change >= 0 ? 'positive' : 'negative'}">
                ${latestData.change >= 0 ? '+' : ''}${latestData.change.toFixed(2)} (${latestData.changePercent >= 0 ? '+' : ''}${latestData.changePercent.toFixed(2)}%)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">區間漲跌</div>
            <div class="info-value ${periodChange >= 0 ? 'positive' : 'negative'}">
                ${periodChange >= 0 ? '+' : ''}${periodChange.toFixed(2)} (${periodChangePercent >= 0 ? '+' : ''}${periodChangePercent.toFixed(2)}%)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">最高價</div>
            <div class="info-value">${latestData.high.toFixed(2)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">最低價</div>
            <div class="info-value">${latestData.low.toFixed(2)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">成交量</div>
            <div class="info-value">${latestData.volume.toLocaleString()} 張</div>
        </div>
        <div class="info-item">
            <div class="info-label">成交金額</div>
            <div class="info-value">${(latestData.turnover / 1000).toFixed(0)} 百萬</div>
        </div>
    `;

        stockInfo.classList.add('active');
    }

    // 事件監聽
    document.getElementById('queryBtn').addEventListener('click', queryKLine);

    document.getElementById('symbolInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            queryKLine();
        }
    });

    // 快速選股按鈕
    document.querySelectorAll('.quick-stock-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('symbolInput').value = btn.dataset.symbol;
            queryKLine();
        });
    });

    // 響應式調整
    window.addEventListener('resize', () => {
        if (chart) {
            chart.resize();
        }
    });

    // 初始化並自動查詢
    window.addEventListener('load', () => {
        initStockList();  // 初始化股票列表選項
        initChart();
        queryKLine();
    });
</script>
</body>

</html>