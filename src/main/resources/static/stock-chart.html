<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股K線圖查詢系統</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Microsoft JhengHei', 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #2c3e50;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 24px 28px;
            border-bottom: 3px solid #5a67d8;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .header h1 {
            font-size: 1.6em;
            margin: 0;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .controls {
            padding: 20px 28px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-bottom: 2px solid #e8eaed;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .control-row {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .control-group {
            flex: 1;
            min-width: 240px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #3c4043;
            font-size: 0.9em;
        }

        .control-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #dadce0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .control-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15), 0 2px 8px rgba(0, 0, 0, 0.08);
            transform: translateY(-1px);
        }

        .btn {
            padding: 12px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0) scale(0.98);
        }

        .btn:disabled {
            background: #dadce0;
            color: #5f6368;
            cursor: not-allowed;
            box-shadow: none;
        }

        .btn:disabled::before {
            display: none;
        }

        .stock-info {
            padding: 20px 24px;
            background: white;
            border-bottom: 1px solid #e8eaed;
            display: none;
        }

        .stock-info.active {
            display: block;
            animation: fadeInSlide 0.5s ease-out;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
        }

        .info-item {
            padding: 16px;
            background: #ffffff;
            border: 1px solid #e8eaed;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
        }

        .info-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
            border-color: #1a73e8;
        }

        .info-label {
            font-size: 0.85em;
            color: #5f6368;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1.25em;
            font-weight: 700;
            color: #1a1a1a;
        }

        .info-value.positive {
            color: #ef5350;
            animation: pulse-positive 2s ease-in-out infinite;
        }

        .info-value.negative {
            color: #26a69a;
            animation: pulse-negative 2s ease-in-out infinite;
        }

        @keyframes pulse-positive {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        @keyframes pulse-negative {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        #chartContainer {
            padding: 24px;
        }

        #candlestickChart {
            width: 100%;
            height: 540px;
        }

        .loading {
            text-align: center;
            padding: 48px;
            color: #5f6368;
            font-size: 0.95em;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% {
                content: '.';
            }
            40% {
                content: '..';
            }
            60%, 100% {
                content: '...';
            }
        }

        .error {
            background: #fce8e6;
            color: #c5221f;
            padding: 16px 20px;
            margin: 24px;
            border-radius: 6px;
            border-left: 3px solid #d93025;
            font-size: 0.9em;
        }

        .quick-stocks {
            display: flex;
            gap: 8px;
            margin-top: 14px;
            flex-wrap: wrap;
        }

        .quick-stock-btn {
            padding: 7px 14px;
            background: white;
            color: #5f6368;
            border: 1px solid #dadce0;
            border-radius: 16px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-stock-btn:hover {
            background: #f1f3f4;
            border-color: #1a73e8;
            color: #1a73e8;
        }

        /* 技術分析面板樣式 */
        .analysis-panel {
            margin: 12px 20px;
            background: white;
            border: 1px solid #e8eaed;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            animation: fadeIn 0.5s ease-out;
        }

        .analysis-panel.active {
            display: block;
        }

        .analysis-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            color: #1a1a1a;
            padding: 18px 22px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #e8eaed;
        }

        .analysis-header h3 {
            margin: 0;
            font-size: 1.2em;
            font-weight: 700;
        }

        /* 一頁式設計 - 移除折疊按鈕樣式 */
        /* .analysis-toggle {
            cursor: pointer;
            padding: 4px 10px;
            background: white;
            border: 1px solid #dadce0;
            border-radius: 4px;
            font-size: 0.85em;
            color: #5f6368;
            transition: all 0.2s;
        }

        .analysis-toggle:hover {
            background: #f1f3f4;
            border-color: #1a73e8;
            color: #1a73e8;
        } */

        .analysis-summary {
            display: grid;
            grid-template-columns: 260px 1fr;
            gap: 14px;
            padding: 14px;
        }

        .recommendation-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .recommendation-box::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse-bg 3s ease-in-out infinite;
        }

        @keyframes pulse-bg {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }

        .recommendation-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.4);
        }

        .recommendation-label {
            font-size: 0.9em;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 2px;
            position: relative;
            z-index: 1;
        }

        .recommendation-value {
            font-size: 3em;
            font-weight: 800;
            margin: 16px 0;
            letter-spacing: 2px;
            color: #ffffff;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 1;
            animation: fadeInScale 0.5s ease-out;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .recommendation-value.buy,
        .recommendation-value.sell,
        .recommendation-value.wait {
            color: #ffffff;
        }

        .confidence-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            overflow: hidden;
            margin: 16px 0;
            position: relative;
            z-index: 1;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #fff 0%, rgba(255, 255, 255, 0.8) 100%);
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 20px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            animation: shimmer 2s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        .confidence-text {
            font-size: 0.95em;
            color: rgba(255, 255, 255, 0.95);
            margin-top: 10px;
            font-weight: 600;
            position: relative;
            z-index: 1;
            letter-spacing: 1px;
        }

        .signals-summary {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .signal-item {
            background: #ffffff;
            padding: 14px 16px;
            border-radius: 12px;
            border-left: 4px solid #dadce0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .signal-item:hover {
            transform: translateX(6px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .signal-item.buy {
            border-left-color: #ef5350;
            background: linear-gradient(90deg, #fff5f5 0%, #ffffff 100%);
        }

        .signal-item.buy:hover {
            background: linear-gradient(90deg, #ffebee 0%, #ffffff 100%);
            border-left-width: 6px;
        }

        .signal-item.sell {
            border-left-color: #26a69a;
            background: linear-gradient(90deg, #f1f8f6 0%, #ffffff 100%);
        }

        .signal-item.sell:hover {
            background: linear-gradient(90deg, #e0f2f1 0%, #ffffff 100%);
            border-left-width: 6px;
        }

        .signal-type {
            font-weight: 500;
            color: #1a1a1a;
            font-size: 0.9em;
        }

        .signal-description {
            font-size: 0.85em;
            color: #5f6368;
            margin-top: 4px;
        }

        .signal-strength {
            display: flex;
            gap: 3px;
        }

        .signal-strength span {
            width: 6px;
            height: 18px;
            background: #dadce0;
            border-radius: 2px;
        }

        .signal-strength span.active {
            background: #1a73e8;
        }

        /* 訊號展開按鈕樣式 */
        .signal-toggle-btn {
            width: 100%;
            padding: 10px 16px;
            margin-top: 12px;
            background: white;
            color: #1a73e8;
            border: 2px solid #1a73e8;
            border-radius: 6px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .signal-toggle-btn:hover {
            background: #e8f0fe;
        }

        .signal-toggle-btn.expanded {
            background: #1a73e8;
            color: white;
        }

        /* analysis-detail 樣式已移除 */

        /* indicator-item 和 analysis-text 樣式已移除 */

        /* 技術指標詳細面板樣式 */
        .indicators-detail-panel {
            padding: 14px 20px;
            background: white;
            border-top: 1px solid #e8eaed;
            animation: fadeInSlide 0.8s ease-out;
        }

        .indicators-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0;
            cursor: pointer;
            padding: 8px 0;
        }

        .indicators-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #1a1a1a;
            margin: 0;
        }

        .indicators-toggle-btn {
            padding: 6px 14px;
            background: white;
            color: #1a73e8;
            border: 1px solid #1a73e8;
            border-radius: 16px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .indicators-toggle-btn:hover {
            background: #e8f0fe;
        }

        .indicators-toggle-btn.expanded {
            background: #1a73e8;
            color: white;
        }

        .indicators-content {
            padding-top: 16px;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
        }

        .indicator-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e8eaed;
            border-radius: 16px;
            padding: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }

        .indicator-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #1a73e8, #667eea);
            transform: scaleY(0);
            transform-origin: top;
            transition: transform 0.3s ease;
        }

        .indicator-card:hover::before {
            transform: scaleY(1);
        }

        .indicator-card:hover {
            border-color: #667eea;
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .indicator-header {
            font-size: 0.95em;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 14px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e8eaed;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .indicator-values {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .indicator-value-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
        }

        .indicator-value-item:hover {
            background: #f8f9fa;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .indicator-label {
            font-size: 0.85em;
            color: #5f6368;
            font-weight: 500;
        }

        .indicator-value {
            font-size: 1.05em;
            font-weight: 700;
            color: #1a73e8;
            padding: 2px 8px;
            background: #e8f0fe;
            border-radius: 6px;
        }

        /* 支撐壓力位面板樣式 - 改善可讀性 */
        .support-resistance-panel {
            padding: 24px;
            background: white;
            border-top: 1px solid #e8eaed;
            margin-bottom: 20px;
            animation: fadeInSlide 0.6s ease-out;
        }

        @keyframes fadeInSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .sr-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 14px;
            border-bottom: 3px solid #e8eaed;
        }

        .sr-title {
            font-size: 1.35em;
            font-weight: 700;
            color: #1a1a1a;
            margin: 0;
        }

        .sr-visual {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 24px;
        }

        .sr-levels {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .sr-level {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px 24px;
            border-radius: 10px;
            background: white;
            border: 2px solid #e8eaed;
            transition: all 0.3s ease;
        }

        .sr-level.resistance-2,
        .sr-level.resistance-1 {
            background: #fff5f5;
            border-left: 6px solid #d93025;
            border-color: #ffcccb;
        }

        .sr-level.support-1,
        .sr-level.support-2 {
            background: #f0fff4;
            border-left: 6px solid #0f9d58;
            border-color: #c6f6d5;
        }

        .sr-level.current {
            background: #e8f4fd;
            border: 3px solid #1a73e8;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(26, 115, 232, 0.25);
        }

        .sr-level:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        .sr-label {
            font-size: 1.05em;
            color: #3c4043;
            font-weight: 600;
        }

        .sr-level.current .sr-label {
            color: #1a73e8;
            font-size: 1.15em;
        }

        .sr-price {
            font-size: 1.4em;
            font-weight: 700;
            color: #1a1a1a;
        }

        .sr-level.resistance-1 .sr-price,
        .sr-level.resistance-2 .sr-price {
            color: #d93025;
        }

        .sr-level.support-1 .sr-price,
        .sr-level.support-2 .sr-price {
            color: #0f9d58;
        }

        .sr-price.current-price {
            font-size: 1.6em;
            color: #1a73e8;
            font-weight: 800;
        }

        /* 進出場時機分析樣式 - 改善可讀性 */
        .entry-exit-timing {
            padding: 24px;
            background: white;
            border-top: 1px solid #e8eaed;
            animation: fadeInSlide 0.7s ease-out;
        }

        .timing-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 14px;
            border-bottom: 3px solid #e8eaed;
        }

        .timing-title {
            font-size: 1.35em;
            font-weight: 700;
            color: #1a1a1a;
        }

        .timing-action {
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 700;
            font-size: 1.05em;
        }

        .timing-action.entry {
            background: #d93025;
            color: white;
            border: none;
        }

        .timing-action.exit {
            background: #0f9d58;
            color: white;
            border: none;
        }

        .timing-action.wait {
            background: #5f6368;
            color: white;
            border: none;
        }

        .timing-content {
            margin-bottom: 20px;
        }

        .timing-card {
            background: white;
            border: 3px solid #e8eaed;
            border-radius: 10px;
            padding: 20px 24px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 14px;
        }

        .timing-card:hover {
            border-color: #1a73e8;
            box-shadow: 0 4px 14px rgba(26, 115, 232, 0.2);
            transform: translateY(-2px);
        }

        .timing-card-title {
            font-size: 1em;
            color: #3c4043;
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timing-price {
            font-size: 2em;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 6px;
            line-height: 1.2;
        }

        .timing-price.entry-price {
            color: #d93025;
        }

        .timing-price.exit-price {
            color: #0f9d58;
        }

        .timing-price.stop-loss {
            color: #ea8600;
        }

        .timing-price.take-profit {
            color: #1a73e8;
        }

        .timing-subtitle {
            font-size: 0.9em;
            color: #5f6368;
            margin-top: 6px;
            line-height: 1.5;
        }

        .timing-analysis-detail {
            background: #e8f4fd;
            border: 3px solid #1a73e8;
            padding: 20px 24px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .timing-analysis-title {
            font-size: 1.15em;
            color: #1a73e8;
            margin-bottom: 16px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .timing-analysis-text {
            font-size: 1em;
            color: #1a1a1a;
            line-height: 1.8;
            white-space: pre-wrap;
        }

        /* 價格區間樣式 - 改善可讀性 */
        .price-section {
            margin-bottom: 18px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px 24px;
            border: 3px solid #e8eaed;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        .price-section-header {
            font-size: 1.15em;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 20px;
            padding-bottom: 14px;
            border-bottom: 3px solid #dadce0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-range-value {
            font-size: 1.15em;
            color: white;
            background: #1a73e8;
            padding: 8px 18px;
            border-radius: 8px;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .price-range-container {
            margin-bottom: 12px;
        }

        .price-range-visual {
            margin-bottom: 20px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 2px solid #e8eaed;
        }

        .price-range-bar {
            position: relative;
            height: 50px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .price-range-bar.entry-bar {
            background: rgba(217, 48, 37, 0.15);
            border: 3px solid #d93025;
        }

        .price-range-bar.exit-bar {
            background: rgba(15, 157, 88, 0.15);
            border: 3px solid #0f9d58;
        }

        .range-label {
            font-size: 0.85em;
            font-weight: 700;
            color: #3c4043;
        }

        .range-label.center {
            font-size: 0.95em;
            font-weight: 700;
        }

        .price-cards-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 14px;
        }

        .timing-card.compact {
            padding: 16px 20px;
            min-height: auto;
        }

        .timing-card.featured {
            background: #e8f4fd;
            border: 4px solid #1a73e8;
            box-shadow: 0 6px 20px rgba(26, 115, 232, 0.3);
            position: relative;
        }

        .timing-card.featured::before {
            content: '推薦';
            position: absolute;
            top: -12px;
            right: 20px;
            background: #1a73e8;
            color: white;
            padding: 6px 16px;
            border-radius: 8px;
            font-size: 0.8em;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(26, 115, 232, 0.4);
        }

        .timing-card.featured .timing-card-title {
            color: #1a73e8;
            font-weight: 700;
        }

        .timing-card.featured .timing-price {
            font-weight: 800;
        }

        /* K線型態與趨勢分析樣式 */
        .pattern-analysis {
            background: white;
            border: 1px solid #e8eaed;
            padding: 20px;
            margin: 20px;
            border-radius: 6px;
        }

        .pattern-section {
            margin-bottom: 20px;
        }

        .pattern-section:last-child {
            margin-bottom: 0;
        }

        .pattern-title {
            font-size: 1em;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e8eaed;
        }

        .pattern-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .pattern-tag {
            background: #f8f9fa;
            border: 1px solid #dadce0;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 0.85em;
            color: #3c4043;
        }

        .pattern-tag.bullish {
            background: #e8f5e9;
            border-color: #81c784;
            color: #2e7d32;
        }

        .pattern-tag.bearish {
            background: #ffebee;
            border-color: #e57373;
            color: #c62828;
        }

        .trend-text {
            color: #3c4043;
            line-height: 1.75;
            font-size: 0.95em;
        }

        .volume-text {
            color: #3c4043;
            line-height: 1.75;
            font-size: 0.95em;
        }

        /* 免責聲明樣式 */
        .disclaimer {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-left: 5px solid #ff9800;
            padding: 16px 20px;
            margin: 20px;
            border-radius: 8px;
            font-size: 0.9em;
            color: #856404;
            line-height: 1.6;
        }

        .disclaimer-title {
            font-weight: 700;
            font-size: 1.05em;
            margin-bottom: 8px;
            color: #ff6f00;
        }

        .disclaimer-text {
            margin: 0;
        }

        .disclaimer-text strong {
            color: #d84315;
        }

        /* 資料來源樣式 */
        .data-source {
            background: #f8f9fa;
            border-top: 1px solid #e8eaed;
            padding: 16px 24px;
            text-align: center;
            font-size: 0.85em;
            color: #5f6368;
            margin-top: 20px;
        }

        .data-source a {
            color: #1a73e8;
            text-decoration: none;
            font-weight: 500;
        }

        .data-source a:hover {
            text-decoration: underline;
        }

        /* K線型態與趨勢總結樣式 */
        .pattern-trend-summary {
            padding: 20px 24px;
            background: linear-gradient(135deg, #f5f7fa 0%, #ffffff 100%);
            border-top: 1px solid #e8eaed;
            border-bottom: 1px solid #e8eaed;
            animation: fadeIn 0.6s ease-out;
        }

        .summary-header {
            font-size: 1.15em;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 20px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
        }

        .summary-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e8eaed;
            border-radius: 16px;
            padding: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #1a73e8, #667eea);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s ease;
        }

        .summary-card:hover::before {
            transform: scaleX(1);
        }

        .summary-card:hover {
            border-color: #667eea;
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
            transform: translateY(-4px) scale(1.02);
        }

        .summary-card-header {
            font-size: 0.8em;
            color: #5f6368;
            margin-bottom: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .summary-card-content {
            font-size: 1.4em;
            font-weight: 700;
            color: #1a1a1a;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: fadeInUp 0.5s ease-out;
        }

        .summary-card-content.bullish {
            color: #d93025;
        }

        .summary-card-content.bearish {
            color: #0f9d58;
        }

        .summary-card-content.neutral {
            color: #5f6368;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .trend-arrow {
            font-size: 1.5em;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }

        .pattern-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .pattern-badge {
            background: #f1f3f4;
            border: 1px solid #dadce0;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75em;
            color: #3c4043;
            font-weight: 500;
        }

        .pattern-badge.bullish {
            background: #e8f5e9;
            border-color: #81c784;
            color: #2e7d32;
        }

        .pattern-badge.bearish {
            background: #ffebee;
            border-color: #e57373;
            color: #c62828;
        }

        /* 法人進出面板樣式 */
        .institutional-investors-panel {
            padding: 24px;
            background: white;
            border-top: 1px solid #e8eaed;
            margin-bottom: 20px;
            animation: fadeInSlide 0.6s ease-out;
        }

        .ii-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 14px;
            border-bottom: 3px solid #e8eaed;
        }

        .ii-title {
            font-size: 1.35em;
            font-weight: 700;
            color: #1a1a1a;
            margin: 0;
        }

        .ii-period-selector {
            display: flex;
            gap: 8px;
        }

        .ii-period-btn {
            padding: 6px 14px;
            background: white;
            color: #5f6368;
            border: 2px solid #dadce0;
            border-radius: 6px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ii-period-btn:hover {
            background: #f1f3f4;
            border-color: #667eea;
            color: #667eea;
        }

        .ii-period-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }

        .ii-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .ii-summary-card {
            background: white;
            border: 2px solid #e8eaed;
            border-radius: 12px;
            padding: 18px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
        }

        .ii-summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        .ii-summary-card.foreign {
            border-left: 5px solid #ff6b6b;
        }

        .ii-summary-card.trust {
            border-left: 5px solid #4ecdc4;
        }

        .ii-summary-card.dealer {
            border-left: 5px solid #ffd93d;
        }

        .ii-summary-card.total {
            border-left: 5px solid #667eea;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }

        .ii-card-label {
            font-size: 0.9em;
            color: #5f6368;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ii-card-value {
            font-size: 1.8em;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .ii-card-value.positive {
            color: #ef5350;
        }

        .ii-card-value.negative {
            color: #26a69a;
        }

        .ii-card-trend {
            font-size: 0.85em;
            color: #5f6368;
        }

        .ii-chart-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        #institutionalInvestorsChart {
            width: 100%;
            height: 400px;
        }

        .ii-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid #e8eaed;
        }

        .ii-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        .ii-table th {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            color: #3c4043;
            font-weight: 600;
            text-align: right;
            padding: 12px 16px;
            border-bottom: 2px solid #e8eaed;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ii-table th:first-child {
            text-align: left;
        }

        .ii-table td {
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid #f1f3f4;
            font-size: 0.95em;
        }

        .ii-table td:first-child {
            text-align: left;
            font-weight: 600;
            color: #1a1a1a;
        }

        .ii-table tr:hover {
            background: #f8f9fa;
        }

        .ii-value-positive {
            color: #ef5350;
            font-weight: 600;
        }

        .ii-value-negative {
            color: #26a69a;
            font-weight: 600;
        }

        /* Desktop Layout (≥1024px) */
        @media (min-width: 1024px) {
            /* Expand container for desktop */
            .container {
                max-width: 1400px;
            }

            /* Main content wrapper with grid layout */
            .main-content-wrapper {
                display: grid;
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto;
                gap: 20px;
                padding: 0 20px;
            }

            /* Analysis panel spans full width at top */
            .analysis-panel {
                grid-column: 1;
                grid-row: 1;
                display: flex !important;
                flex-direction: column;
                gap: 8px;
            }

            /* Support-Resistance panel spans full width in row 2 */
            .support-resistance-panel {
                grid-column: 1;
                grid-row: 2;
                margin: 0;
            }

            /* Chart container spans full width in row 3 */
            #chartContainer {
                grid-column: 1;
                grid-row: 3;
                margin: 0;
            }

            /* Adjust chart height for desktop */
            #candlestickChart {
                height: 600px !important;
            }
        }

        /* Tablet Layout (768px - 1023px) */
        @media (min-width: 769px) and (max-width: 1023px) {
            #candlestickChart {
                height: 480px;
            }

            .main-content-wrapper {
                padding: 0 16px;
            }
        }

        /* Mobile Layout (≤768px) */
        @media (max-width: 768px) {
            body {
                padding: 12px;
            }

            .header h1 {
                font-size: 1.3em;
            }

            .control-row {
                flex-direction: column;
            }

            .control-group {
                width: 100%;
            }

            /* Mobile content wrapper uses flexbox for reordering */
            .main-content-wrapper {
                display: flex;
                flex-direction: column;
            }

            /* Analysis panel comes first */
            .analysis-panel {
                order: 1;
            }

            /* Support-Resistance comes second */
            .support-resistance-panel {
                order: 2;
            }

            /* Chart comes last */
            #chartContainer {
                order: 3;
            }

            /* Reduce font sizes for mobile */
            .summary-header {
                font-size: 1em;
            }

            .sr-title {
                font-size: 1.1em;
            }

            /* Adjust chart height for mobile */
            #candlestickChart {
                height: 400px;
            }

            /* Compact spacing for mobile */
            .analysis-panel {
                margin: 8px 12px !important;
            }

            .pattern-trend-summary {
                padding: 12px 16px !important;
            }

            .summary-grid {
                grid-template-columns: 1fr !important;
                gap: 8px !important;
            }
        }
    </style>
</head>

<body>
<div class="container">
    <div class="header">
        <h1>台股技術分析</h1>
    </div>

    <div class="controls">
        <div class="control-row">
            <div class="control-group">
                <label for="symbolInput">股票代號或名稱</label>
                <input type="text" id="symbolInput" placeholder="例如：2330 或 台積電" value="2330" list="stockList"
                       autocomplete="off">
                <datalist id="stockList"></datalist>
            </div>
            <button class="btn" id="queryBtn">查詢K線</button>
        </div>

        <div class="quick-stocks">
            <button class="quick-stock-btn" data-symbol="2330">台積電</button>
            <button class="quick-stock-btn" data-symbol="2317">鴻海</button>
            <button class="quick-stock-btn" data-symbol="2454">聯發科</button>
            <button class="quick-stock-btn" data-symbol="2412">中華電</button>
        </div>
    </div>

    <div class="stock-info" id="stockInfo">
        <div class="info-grid" id="infoGrid">
            <!-- 動態生成股票資訊 -->
        </div>
    </div>

    <!-- Main Content Wrapper for Desktop Layout -->
    <div class="main-content-wrapper">
        <!-- 技術分析面板 -->
        <div class="analysis-panel" id="analysisPanel" style="display: none;">
            <div class="analysis-summary">
                <!-- 綜合建議卡片 (新增) -->
                <div class="recommendation-box">
                    <div class="recommendation-label">綜合建議</div>
                    <div class="recommendation-value" id="recommendationValue">-</div>
                    <div class="confidence-bar">
                        <div class="confidence-fill" id="confidenceFill" style="width: 0%;"></div>
                    </div>
                    <div class="confidence-text" id="confidenceText">信心指數: - / 100</div>
                </div>

                <div class="signals-summary" id="signalsSummary">
                    <!-- 動態生成訊號摘要 -->
                </div>
            </div>

            <!-- K線型態與趨勢總結 -->
            <div class="pattern-trend-summary" id="patternTrendSummary" style="display: none;">
                <div class="summary-header">當前K線型態與趨勢</div>
                <div class="summary-grid">
                    <!-- 趨勢卡片 -->
                    <div class="summary-card">
                        <div class="summary-card-header">趨勢方向</div>
                        <div class="summary-card-content" id="trendSummary">
                            <span class="trend-arrow" id="trendArrow">-</span>
                            <span id="trendSummaryText">-</span>
                        </div>
                    </div>

                    <!-- 型態卡片 -->
                    <div class="summary-card">
                        <div class="summary-card-header">K線型態</div>
                        <div class="summary-card-content" id="patternSummary">
                            <span id="patternSummaryText">-</span>
                        </div>
                        <div class="pattern-badges" id="patternBadges">
                            <!-- 動態生成型態標籤 -->
                        </div>
                    </div>

                    <!-- 量價關係卡片 -->
                    <div class="summary-card">
                        <div class="summary-card-header">量價配合</div>
                        <div class="summary-card-content" id="volumeSummary">
                            <span id="volumeSummaryText">-</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 技術指標詳細面板 (新增，可折疊) -->
            <div class="indicators-detail-panel" id="indicatorsDetailPanel" style="display: none;">
                <div class="indicators-header">
                    <h4 class="indicators-title">技術指標數值</h4>
                    <button class="indicators-toggle-btn" id="indicatorsToggleBtn">展開 ▼</button>
                </div>
                <div class="indicators-content" id="indicatorsContent" style="display: none;">
                    <div class="indicators-grid">
                        <!-- RSI -->
                        <div class="indicator-card">
                            <div class="indicator-header">RSI (相對強弱指標)</div>
                            <div class="indicator-values">
                                <div class="indicator-value-item">
                                    <span class="indicator-label">6日</span>
                                    <span class="indicator-value" id="rsi6">-</span>
                                </div>
                                <div class="indicator-value-item">
                                    <span class="indicator-label">12日</span>
                                    <span class="indicator-value" id="rsi12">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- KD -->
                        <div class="indicator-card">
                            <div class="indicator-header">KD (隨機指標)</div>
                            <div class="indicator-values">
                                <div class="indicator-value-item">
                                    <span class="indicator-label">K值</span>
                                    <span class="indicator-value" id="kdK">-</span>
                                </div>
                                <div class="indicator-value-item">
                                    <span class="indicator-label">D值</span>
                                    <span class="indicator-value" id="kdD">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- MACD -->
                        <div class="indicator-card">
                            <div class="indicator-header">MACD (指數平滑異同移動平均線)</div>
                            <div class="indicator-values">
                                <div class="indicator-value-item">
                                    <span class="indicator-label">DIF</span>
                                    <span class="indicator-value" id="macdDif">-</span>
                                </div>
                                <div class="indicator-value-item">
                                    <span class="indicator-label">DEA</span>
                                    <span class="indicator-value" id="macdDea">-</span>
                                </div>
                                <div class="indicator-value-item">
                                    <span class="indicator-label">柱狀圖</span>
                                    <span class="indicator-value" id="macdHistogram">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- 布林帶 -->
                        <div class="indicator-card">
                            <div class="indicator-header">布林帶 (Bollinger Bands)</div>
                            <div class="indicator-values">
                                <div class="indicator-value-item">
                                    <span class="indicator-label">上軌</span>
                                    <span class="indicator-value" id="bbandsUpper">-</span>
                                </div>
                                <div class="indicator-value-item">
                                    <span class="indicator-label">中軌</span>
                                    <span class="indicator-value" id="bbandsMiddle">-</span>
                                </div>
                                <div class="indicator-value-item">
                                    <span class="indicator-label">下軌</span>
                                    <span class="indicator-value" id="bbandsLower">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- Williams %R -->
                        <div class="indicator-card">
                            <div class="indicator-header">Williams %R</div>
                            <div class="indicator-values">
                                <div class="indicator-value-item">
                                    <span class="indicator-label">14日</span>
                                    <span class="indicator-value" id="williamsR14">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- BIAS -->
                        <div class="indicator-card">
                            <div class="indicator-header">BIAS (乖離率)</div>
                            <div class="indicator-values">
                                <div class="indicator-value-item">
                                    <span class="indicator-label">6日</span>
                                    <span class="indicator-value" id="bias6">-</span>
                                </div>
                                <div class="indicator-value-item">
                                    <span class="indicator-label">12日</span>
                                    <span class="indicator-value" id="bias12">-</span>
                                </div>
                                <div class="indicator-value-item">
                                    <span class="indicator-label">24日</span>
                                    <span class="indicator-value" id="bias24">-</span>
                                </div>
                            </div>
                        </div>

                        <!-- MA -->
                        <div class="indicator-card">
                            <div class="indicator-header">MA (移動平均線)</div>
                            <div class="indicator-values">
                                <div class="indicator-value-item">
                                    <span class="indicator-label">MA5</span>
                                    <span class="indicator-value" id="ma5">-</span>
                                </div>
                                <div class="indicator-value-item">
                                    <span class="indicator-label">MA10</span>
                                    <span class="indicator-value" id="ma10">-</span>
                                </div>
                                <div class="indicator-value-item">
                                    <span class="indicator-label">MA20</span>
                                    <span class="indicator-value" id="ma20">-</span>
                                </div>
                                <div class="indicator-value-item">
                                    <span class="indicator-label">MA60</span>
                                    <span class="indicator-value" id="ma60">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="chartContainer">
            <div id="candlestickChart"></div>
        </div>

        <!-- 支撐壓力位視覺化 -->
        <div class="support-resistance-panel" id="supportResistancePanel" style="display: none;">
            <div class="sr-header">
                <h4 class="sr-title">支撐壓力位</h4>
            </div>
            <div class="sr-content">
                <div class="sr-visual">
                    <!-- 價格刻度線 -->
                    <div class="sr-levels">
                        <div class="sr-level resistance-2" id="resistance2Level">
                            <span class="sr-label">第二壓力</span>
                            <span class="sr-price" id="resistance2Price">-</span>
                        </div>
                        <div class="sr-level resistance-1" id="resistance1Level">
                            <span class="sr-label">第一壓力</span>
                            <span class="sr-price" id="resistance1Price">-</span>
                        </div>
                        <div class="sr-level current" id="currentLevel">
                            <span class="sr-label">當前價</span>
                            <span class="sr-price current-price" id="currentPrice">-</span>
                        </div>
                        <div class="sr-level support-1" id="support1Level">
                            <span class="sr-label">第一支撐</span>
                            <span class="sr-price" id="support1Price">-</span>
                        </div>
                        <div class="sr-level support-2" id="support2Level">
                            <span class="sr-label">第二支撐</span>
                            <span class="sr-price" id="support2Price">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 法人進出面板 -->
        <div class="institutional-investors-panel" id="institutionalInvestorsPanel" style="display: none;">
            <div class="ii-header">
                <h4 class="ii-title">三大法人買賣超</h4>
                <div class="ii-period-selector">
                    <button class="ii-period-btn" data-days="10">10天</button>
                    <button class="ii-period-btn active" data-days="30">30天</button>
                    <button class="ii-period-btn" data-days="60">60天</button>
                </div>
            </div>

            <!-- 摘要卡片 -->
            <div class="ii-summary">
                <div class="ii-summary-card foreign">
                    <div class="ii-card-label">外資</div>
                    <div class="ii-card-value" id="iiLatestForeign">-</div>
                    <div class="ii-card-trend" id="iiTrendForeign">累計：-</div>
                </div>
                <div class="ii-summary-card trust">
                    <div class="ii-card-label">投信</div>
                    <div class="ii-card-value" id="iiLatestTrust">-</div>
                    <div class="ii-card-trend" id="iiTrendTrust">累計：-</div>
                </div>
                <div class="ii-summary-card dealer">
                    <div class="ii-card-label">自營商</div>
                    <div class="ii-card-value" id="iiLatestDealer">-</div>
                    <div class="ii-card-trend" id="iiTrendDealer">累計：-</div>
                </div>
                <div class="ii-summary-card total">
                    <div class="ii-card-label">三大法人合計</div>
                    <div class="ii-card-value" id="iiLatestTotal">-</div>
                    <div class="ii-card-trend" id="iiTrendTotal">累計：-</div>
                </div>
            </div>

            <!-- 趨勢圖表 -->
            <div class="ii-chart-container">
                <div id="institutionalInvestorsChart"></div>
            </div>

            <!-- 明細表格 -->
            <div class="ii-table-container">
                <table class="ii-table" id="iiTable">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>外資</th>
                            <th>投信</th>
                            <th>自營商</th>
                            <th>合計</th>
                        </tr>
                    </thead>
                    <tbody id="iiTableBody">
                        <tr>
                            <td colspan="5" style="text-align: center; color: #5f6368;">載入中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
    <!-- End of Main Content Wrapper -->

    <!-- 資料來源標示 -->
    <div class="data-source" id="dataSource" style="display: none;">
        資料來源：<a href="https://finmind.github.io/" target="_blank" rel="noopener noreferrer">FinMind
        台灣金融資料庫</a>
        ｜技術分析演算法：NexusBot 自主研發
        ｜最後更新時間：<span id="lastUpdateTime">-</span>
    </div>

    <!-- 免責聲明 -->
    <div class="disclaimer" id="disclaimer" style="display: none;">
        <div class="disclaimer-title">
            重要聲明
        </div>
        <div class="disclaimer-text">
            本技術分析結果<strong>僅供參考，不構成投資建議</strong>。股票投資有風險，過往績效不代表未來表現。
            技術指標可能產生誤判，請投資人自行審慎評估風險，並考量個人財務狀況後再做投資決策。
            本系統不對任何投資損失負責。
        </div>
    </div>
</div>

<script>
    let chart;
    // 自動偵測 API 基礎 URL
    // 如果從 Spring Boot (port 5001) 提供服務，使用當前 origin
    // 否則使用預設的 localhost:5001
    const API_BASE = window.location.port === '5001'
        ? window.location.origin
        : 'http://localhost:5001';

    // 常用台股列表（代號和中文名稱）
    // 初始化股票列表選項
    async function initStockList() {
        console.log('========== initStockList ==========');
        const datalist = document.getElementById('stockList');
        const input = document.getElementById('symbolInput');

        // 顯示載入中提示
        input.placeholder = "載入股票列表中...";

        try {
            console.log('正在從 API 獲取股票列表...');
            const response = await fetch(`${API_BASE}/api/stock/list`);

            if (!response.ok) {
                throw new Error(`獲取股票列表失敗: ${response.status}`);
            }

            const stocks = await response.json();
            console.log('股票列表獲取成功，共', stocks.length, '筆');

            // 全域變數儲存，供搜尋使用
            window.allStocks = stocks;

            // 清空舊選項
            datalist.innerHTML = '';

            // 建立 Fragment 以提升效能
            const fragment = document.createDocumentFragment();

            stocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = `${stock.symbol} ${stock.name}`;
                option.dataset.symbol = stock.symbol;
                fragment.appendChild(option);
            });

            datalist.appendChild(fragment);
            console.log('datalist 更新完成');

            // 恢復輸入框提示
            input.placeholder = "請輸入股票代號或名稱";

        } catch (error) {
            console.error('初始化股票列表錯誤:', error);
            input.placeholder = "股票列表載入失敗，請手動輸入代號";

            // 發生錯誤時，至少保留熱門股以供使用 (Fallback)
            const fallbackStocks = [
                { symbol: '2330', name: '台積電' },
                { symbol: '2317', name: '鴻海' },
                { symbol: '2454', name: '聯發科' }
            ];
            window.allStocks = fallbackStocks;

            // 建立 Fragment
            const fragment = document.createDocumentFragment();
            fallbackStocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = `${stock.symbol} ${stock.name}`;
                fragment.appendChild(option);
            });
            datalist.appendChild(fragment);
        }
    }

    // 將輸入轉換為股票代號
    function parseSymbolInput(input) {
        // 去除空白
        input = input.trim();
        console.log('========== parseSymbolInput ==========');
        console.log('原始輸入:', input);

        const stocks = window.allStocks || [];

        // 如果是純數字，直接返回
        if (/^\d+$/.test(input)) {
            console.log('✓ 匹配純數字:', input);
            return input;
        }

        // 嘗試從 "代號 名稱" 格式中提取代號
        const match = input.match(/^(\d+)\s/);
        if (match) {
            console.log('✓ 匹配 "代號 名稱" 格式:', match[1]);
            return match[1];
        }

        // 嘗試根據中文名稱查找
        console.log('嘗試在股票列表中查找:', input);
        if (stocks.length > 0) {
            const stock = stocks.find(s => s.name === input || s.name.includes(input));
            if (stock) {
                console.log('✓ 找到匹配:', stock.symbol, stock.name);
                return stock.symbol;
            }
        }

        // 都找不到，返回原輸入
        console.log('✗ 找不到匹配，返回原輸入:', input);
        return input;
    }

    // 初始化圖表
    function initChart() {
        const chartDom = document.getElementById('candlestickChart');
        chart = echarts.init(chartDom);
        chart.showLoading({
            text: '載入中...',
            color: '#667eea',
            textColor: '#000',
            maskColor: 'rgba(255, 255, 255, 0.8)',
            zlevel: 0
        });
    }

    // 查詢K線數據
    async function queryKLine() {
        const input = document.getElementById('symbolInput').value.trim();
        const symbol = parseSymbolInput(input);
        const queryBtn = document.getElementById('queryBtn');

        console.log('解析後的股票代號:', symbol);

        if (!symbol) {
            alert('請輸入股票代號或名稱');
            return;
        }

        queryBtn.disabled = true;
        queryBtn.textContent = '查詢中...';
        chart.showLoading();

        try {
            // 使用優化的 API：顯示 12 個月，基於 18 個月計算均線
            const apiUrl = `${API_BASE}/api/stock/${symbol}/candlestick-with-ma?displayMonths=12&maBaseMonths=18`;
            console.log('API URL:', apiUrl);
            const response = await fetch(apiUrl);

            if (!response.ok) {
                throw new Error(`查詢失敗: ${response.status}`);
            }

            const data = await response.json();

            if (!data || data.length === 0) {
                throw new Error('查無數據');
            }

            // 保存數據供調試使用
            window.latestData = data;
            console.log('已載入', data.length, '筆 K 線數據');
            console.log('前 3 筆數據範例：', data.slice(0, 3));

            renderChart(data, symbol);
            updateStockInfo(data);

            // 顯示免責聲明和資料來源
            document.getElementById('disclaimer').style.display = 'block';
            document.getElementById('dataSource').style.display = 'block';

            // 更新最後更新時間
            const now = new Date();
            const timeStr = now.getFullYear() + '-' +
                          String(now.getMonth() + 1).padStart(2, '0') + '-' +
                          String(now.getDate()).padStart(2, '0') + ' ' +
                          String(now.getHours()).padStart(2, '0') + ':' +
                          String(now.getMinutes()).padStart(2, '0');
            document.getElementById('lastUpdateTime').textContent = timeStr;

            // 查詢技術分析
            fetchTechnicalAnalysis(symbol);

            // 查詢法人進出數據（預設 30 天）
            fetchInstitutionalInvestors(symbol, 30);

        } catch (error) {
            console.error('Error:', error);
            chart.hideLoading();
            const chartDom = document.getElementById('candlestickChart');
            chartDom.innerHTML = `<div class="error">查詢失敗: ${error.message}</div>`;
        } finally {
            queryBtn.disabled = false;
            queryBtn.textContent = '查詢K線';
        }
    }

    // 查詢技術分析
    async function fetchTechnicalAnalysis(symbol) {
        try {
            const response = await fetch(`${API_BASE}/api/stock/${symbol}/analysis`);

            if (!response.ok) {
                console.warn('技術分析查詢失敗:', response.status);
                document.getElementById('analysisPanel').style.display = 'none';
                return;
            }

            const analysis = await response.json();
            displayTechnicalAnalysis(analysis);

        } catch (error) {
            console.error('技術分析錯誤:', error);
            document.getElementById('analysisPanel').style.display = 'none';
        }
    }

    // 顯示綜合建議和信心指數
    function displayRecommendation(analysis) {
        const recommendationValue = document.getElementById('recommendationValue');
        const confidenceFill = document.getElementById('confidenceFill');
        const confidenceText = document.getElementById('confidenceText');

        // 設定建議文字
        if (analysis.recommendation) {
            recommendationValue.textContent = analysis.recommendation;

            // 根據建議類型設定樣式
            recommendationValue.className = 'recommendation-value';
            if (analysis.recommendation === '買進' || analysis.recommendation === '強力買進') {
                recommendationValue.classList.add('buy');
            } else if (analysis.recommendation === '賣出' || analysis.recommendation === '強力賣出') {
                recommendationValue.classList.add('sell');
            } else {
                recommendationValue.classList.add('wait');
            }
        }

        // 設定信心指數
        if (analysis.confidence !== null && analysis.confidence !== undefined) {
            const confidence = analysis.confidence;
            confidenceFill.style.width = confidence + '%';
            confidenceText.textContent = `信心指數: ${confidence} / 100`;

            // 根據信心指數調整進度條顏色
            if (confidence >= 70) {
                confidenceFill.style.background = '#1a73e8';  // 藍色 - 高信心
            } else if (confidence >= 50) {
                confidenceFill.style.background = '#f9ab00';  // 黃色 - 中等信心
            } else {
                confidenceFill.style.background = '#ea8600';  // 橙色 - 低信心
            }
        }
    }

    // 顯示技術分析結果
    function displayTechnicalAnalysis(analysis) {
        const panel = document.getElementById('analysisPanel');
        panel.style.display = 'block';

        // 顯示綜合建議和信心指數
        displayRecommendation(analysis);

        // 顯示訊號摘要
        const signalsSummary = document.getElementById('signalsSummary');
        signalsSummary.innerHTML = '';

        if (analysis.signals && analysis.signals.length > 0) {
            // 按強度排序訊號（強度高的在前）
            const sortedSignals = [...analysis.signals].sort((a, b) => b.strength - a.strength);

            // 預設顯示前 5 個訊號
            const initialDisplayCount = Math.min(5, sortedSignals.length);

            sortedSignals.forEach((signal, index) => {
                const signalDiv = document.createElement('div');
                signalDiv.className = `signal-item ${signal.direction === '買進' ? 'buy' : 'sell'}`;

                // 超過 5 個訊號，後面的預設隱藏
                if (index >= initialDisplayCount) {
                    signalDiv.classList.add('signal-hidden');
                    signalDiv.style.display = 'none';
                }

                // 強度顯示
                const strengthHtml = Array(5).fill(0).map((_, i) =>
                    `<span class="${i < signal.strength ? 'active' : ''}"></span>`
                ).join('');

                signalDiv.innerHTML = `
                <div>
                    <div class="signal-type">${signal.type}</div>
                    <div class="signal-description">${signal.description}</div>
                </div>
                <div class="signal-strength">${strengthHtml}</div>
            `;
                signalsSummary.appendChild(signalDiv);
            });

            // 如果訊號超過 5 個，顯示「展開/收起」按鈕
            if (sortedSignals.length > initialDisplayCount) {
                const toggleBtn = document.createElement('button');
                toggleBtn.className = 'signal-toggle-btn';
                toggleBtn.textContent = `查看全部訊號 (共 ${sortedSignals.length} 個)`;
                toggleBtn.onclick = function() {
                    const hiddenSignals = signalsSummary.querySelectorAll('.signal-hidden');
                    const isExpanded = toggleBtn.classList.contains('expanded');

                    hiddenSignals.forEach(signal => {
                        signal.style.display = isExpanded ? 'none' : 'flex';
                    });

                    if (isExpanded) {
                        toggleBtn.textContent = `查看全部訊號 (共 ${sortedSignals.length} 個)`;
                        toggleBtn.classList.remove('expanded');
                    } else {
                        toggleBtn.textContent = '收起訊號';
                        toggleBtn.classList.add('expanded');
                    }
                };
                signalsSummary.appendChild(toggleBtn);
            }
        } else {
            signalsSummary.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">暫無明顯訊號</div>';
        }

        // 技術指標與分析文字顯示已移除

        // 顯示K線型態與趨勢總結
        displayPatternTrendSummary(analysis);

        // 顯示技術指標詳細數值
        if (analysis.indicators) {
            displayIndicators(analysis.indicators);
        }

        // 顯示支撐壓力位
        if (analysis.supportResistance) {
            displaySupportResistance(analysis.supportResistance, analysis.currentPrice);
        }

        // 顯示進出場時機分析 - 已移除
        // if (analysis.entryExitTiming) {
        //     displayEntryExitTiming(analysis.entryExitTiming);
        // }
    }

    // 顯示技術指標詳細數值
    function displayIndicators(indicators) {
        const panel = document.getElementById('indicatorsDetailPanel');
        panel.style.display = 'block';

        // 設定折疊/展開按鈕事件（只設定一次）
        const toggleBtn = document.getElementById('indicatorsToggleBtn');
        const content = document.getElementById('indicatorsContent');

        if (!toggleBtn.dataset.initialized) {
            toggleBtn.addEventListener('click', function() {
                const isExpanded = toggleBtn.classList.contains('expanded');

                if (isExpanded) {
                    content.style.display = 'none';
                    toggleBtn.textContent = '展開 ▼';
                    toggleBtn.classList.remove('expanded');
                } else {
                    content.style.display = 'block';
                    toggleBtn.textContent = '收起 ▲';
                    toggleBtn.classList.add('expanded');
                }
            });
            toggleBtn.dataset.initialized = 'true';
        }

        // 填充技術指標數值
        // RSI
        if (indicators.rsi6) document.getElementById('rsi6').textContent = indicators.rsi6.toFixed(2);
        if (indicators.rsi12) document.getElementById('rsi12').textContent = indicators.rsi12.toFixed(2);

        // KD
        if (indicators.kdK) document.getElementById('kdK').textContent = indicators.kdK.toFixed(2);
        if (indicators.kdD) document.getElementById('kdD').textContent = indicators.kdD.toFixed(2);

        // MACD
        if (indicators.macdDif) document.getElementById('macdDif').textContent = indicators.macdDif.toFixed(2);
        if (indicators.macdDea) document.getElementById('macdDea').textContent = indicators.macdDea.toFixed(2);
        if (indicators.macdHistogram) document.getElementById('macdHistogram').textContent = indicators.macdHistogram.toFixed(2);

        // 布林帶
        if (indicators.bbandsUpper) document.getElementById('bbandsUpper').textContent = indicators.bbandsUpper.toFixed(2);
        if (indicators.bbandsMiddle) document.getElementById('bbandsMiddle').textContent = indicators.bbandsMiddle.toFixed(2);
        if (indicators.bbandsLower) document.getElementById('bbandsLower').textContent = indicators.bbandsLower.toFixed(2);

        // Williams %R
        if (indicators.williamsR14) document.getElementById('williamsR14').textContent = indicators.williamsR14.toFixed(2);

        // BIAS
        if (indicators.bias6) document.getElementById('bias6').textContent = indicators.bias6.toFixed(2) + '%';
        if (indicators.bias12) document.getElementById('bias12').textContent = indicators.bias12.toFixed(2) + '%';
        if (indicators.bias24) document.getElementById('bias24').textContent = indicators.bias24.toFixed(2) + '%';

        // MA
        if (indicators.ma5) document.getElementById('ma5').textContent = indicators.ma5.toFixed(2);
        if (indicators.ma10) document.getElementById('ma10').textContent = indicators.ma10.toFixed(2);
        if (indicators.ma20) document.getElementById('ma20').textContent = indicators.ma20.toFixed(2);
        if (indicators.ma60) document.getElementById('ma60').textContent = indicators.ma60.toFixed(2);
    }

    // 顯示支撐壓力位
    function displaySupportResistance(sr, currentPrice) {
        const panel = document.getElementById('supportResistancePanel');
        panel.style.display = 'block';

        // 當前價格
        const currentPriceElement = document.getElementById('currentPrice');
        if (currentPrice) {
            currentPriceElement.textContent = currentPrice.toFixed(2);
        }

        // 第二壓力位
        const resistance2Price = document.getElementById('resistance2Price');
        if (sr.resistance2) {
            resistance2Price.textContent = sr.resistance2.toFixed(2);
        } else {
            document.getElementById('resistance2Level').style.display = 'none';
        }

        // 第一壓力位
        const resistance1Price = document.getElementById('resistance1Price');
        if (sr.resistance1) {
            resistance1Price.textContent = sr.resistance1.toFixed(2);
        } else {
            document.getElementById('resistance1Level').style.display = 'none';
        }

        // 第一支撐位
        const support1Price = document.getElementById('support1Price');
        if (sr.support1) {
            support1Price.textContent = sr.support1.toFixed(2);
        } else {
            document.getElementById('support1Level').style.display = 'none';
        }

        // 第二支撐位
        const support2Price = document.getElementById('support2Price');
        if (sr.support2) {
            support2Price.textContent = sr.support2.toFixed(2);
        } else {
            document.getElementById('support2Level').style.display = 'none';
        }
    }

    // 全域變數：當前查詢的股票代號和法人進出天數
    let currentStockSymbol = null;
    let currentIIDays = 30;

    // 查詢法人進出數據
    async function fetchInstitutionalInvestors(symbol, days = 30) {
        console.log(`========== 查詢法人進出 ==========`);
        console.log(`股票代號: ${symbol}, 天數: ${days}`);

        try {
            currentStockSymbol = symbol;
            currentIIDays = days;

            const url = `${API_BASE}/api/stock/${symbol}/institutional-investors?days=${days}`;
            console.log(`API URL: ${url}`);

            const response = await fetch(url);
            console.log(`HTTP Status: ${response.status}`);

            if (!response.ok) {
                console.warn('法人進出查詢失敗:', response.status, response.statusText);
                showInstitutionalInvestorsError(`查詢失敗 (HTTP ${response.status})`);
                return;
            }

            const data = await response.json();
            console.log(`取得法人進出資料:`, data.length, '筆');

            if (data && data.length > 0) {
                console.log('最新一天資料:', data[0]);
                displayInstitutionalInvestors(data);
            } else {
                console.warn('查無法人進出數據');
                showInstitutionalInvestorsError('查無此股票的法人進出數據');
            }

        } catch (error) {
            console.error('法人進出查詢錯誤:', error);
            showInstitutionalInvestorsError(`查詢錯誤: ${error.message}`);
        }
    }

    // 顯示法人進出錯誤訊息
    function showInstitutionalInvestorsError(message) {
        const panel = document.getElementById('institutionalInvestorsPanel');
        panel.style.display = 'block';
        panel.innerHTML = `
            <div class="ii-header">
                <h4 class="ii-title">三大法人買賣超</h4>
            </div>
            <div style="padding: 40px; text-align: center; color: #999;">
                ${message}
            </div>
        `;
    }

    // 顯示法人進出數據
    function displayInstitutionalInvestors(data) {
        console.log('========== 顯示法人進出數據 ==========');
        console.log('資料筆數:', data.length);

        const panel = document.getElementById('institutionalInvestorsPanel');

        if (!panel) {
            console.error('找不到 institutionalInvestorsPanel 元素！');
            return;
        }

        // 重置面板內容（清除可能的錯誤訊息）
        // 根據當前選擇的天數設置 active 狀態
        const activeClass10 = currentIIDays === 10 ? ' active' : '';
        const activeClass30 = currentIIDays === 30 ? ' active' : '';
        const activeClass60 = currentIIDays === 60 ? ' active' : '';

        panel.innerHTML = `
            <div class="ii-header">
                <h4 class="ii-title">三大法人買賣超</h4>
                <div class="ii-period-selector">
                    <button class="ii-period-btn${activeClass10}" data-days="10">10天</button>
                    <button class="ii-period-btn${activeClass30}" data-days="30">30天</button>
                    <button class="ii-period-btn${activeClass60}" data-days="60">60天</button>
                </div>
            </div>

            <!-- 摘要卡片 -->
            <div class="ii-summary">
                <div class="ii-summary-card foreign">
                    <div class="ii-card-label">外資</div>
                    <div class="ii-card-value" id="iiLatestForeign">-</div>
                    <div class="ii-card-trend" id="iiTrendForeign">累計：-</div>
                </div>
                <div class="ii-summary-card trust">
                    <div class="ii-card-label">投信</div>
                    <div class="ii-card-value" id="iiLatestTrust">-</div>
                    <div class="ii-card-trend" id="iiTrendTrust">累計：-</div>
                </div>
                <div class="ii-summary-card dealer">
                    <div class="ii-card-label">自營商</div>
                    <div class="ii-card-value" id="iiLatestDealer">-</div>
                    <div class="ii-card-trend" id="iiTrendDealer">累計：-</div>
                </div>
                <div class="ii-summary-card total">
                    <div class="ii-card-label">三大法人合計</div>
                    <div class="ii-card-value" id="iiLatestTotal">-</div>
                    <div class="ii-card-trend" id="iiTrendTotal">累計：-</div>
                </div>
            </div>

            <!-- 趨勢圖表 -->
            <div class="ii-chart-container">
                <div id="institutionalInvestorsChart"></div>
            </div>

            <!-- 明細表格 -->
            <div class="ii-table-container">
                <table class="ii-table" id="iiTable">
                    <thead>
                        <tr>
                            <th rowspan="2">日期</th>
                            <th colspan="3">外資</th>
                            <th colspan="3">投信</th>
                            <th colspan="3">自營商</th>
                            <th colspan="3">三大法人合計</th>
                        </tr>
                        <tr>
                            <th>買進</th>
                            <th>賣出</th>
                            <th>買賣超</th>
                            <th>買進</th>
                            <th>賣出</th>
                            <th>買賣超</th>
                            <th>買進</th>
                            <th>賣出</th>
                            <th>買賣超</th>
                            <th>買進</th>
                            <th>賣出</th>
                            <th>買賣超</th>
                        </tr>
                    </thead>
                    <tbody id="iiTableBody">
                        <tr>
                            <td colspan="13" style="text-align: center; color: #5f6368;">載入中...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        `;

        panel.style.display = 'block';
        console.log('法人進出面板已設置為顯示');

        // 最新一天的數據
        const latest = data[0];

        // 計算累計值（所有天數的總和）
        const accumulated = {
            foreign: data.reduce((sum, item) => sum + (item.foreignInvestorBuySell || 0), 0),
            trust: data.reduce((sum, item) => sum + (item.investmentTrustBuySell || 0), 0),
            dealer: data.reduce((sum, item) => sum + (item.dealerBuySell || 0), 0),
            total: data.reduce((sum, item) => sum + (item.totalBuySell || 0), 0)
        };

        // 更新外資卡片
        const latestForeign = document.getElementById('iiLatestForeign');
        latestForeign.textContent = formatNumber(latest.foreignInvestorBuySell || 0);
        latestForeign.className = 'ii-card-value ' + (latest.foreignInvestorBuySell > 0 ? 'positive' : 'negative');
        document.getElementById('iiTrendForeign').textContent = `累計：${formatNumber(accumulated.foreign)} 張`;

        // 更新投信卡片
        const latestTrust = document.getElementById('iiLatestTrust');
        latestTrust.textContent = formatNumber(latest.investmentTrustBuySell || 0);
        latestTrust.className = 'ii-card-value ' + (latest.investmentTrustBuySell > 0 ? 'positive' : 'negative');
        document.getElementById('iiTrendTrust').textContent = `累計：${formatNumber(accumulated.trust)} 張`;

        // 更新自營商卡片
        const latestDealer = document.getElementById('iiLatestDealer');
        latestDealer.textContent = formatNumber(latest.dealerBuySell || 0);
        latestDealer.className = 'ii-card-value ' + (latest.dealerBuySell > 0 ? 'positive' : 'negative');
        document.getElementById('iiTrendDealer').textContent = `累計：${formatNumber(accumulated.dealer)} 張`;

        // 更新合計卡片
        const latestTotal = document.getElementById('iiLatestTotal');
        latestTotal.textContent = formatNumber(latest.totalBuySell || 0);
        latestTotal.className = 'ii-card-value ' + (latest.totalBuySell > 0 ? 'positive' : 'negative');
        document.getElementById('iiTrendTotal').textContent = `累計：${formatNumber(accumulated.total)} 張`;

        // 渲染圖表和表格
        renderInstitutionalInvestorsChart(data);
        renderInstitutionalInvestorsTable(data);

        console.log('法人進出數據顯示完成，currentStockSymbol =', currentStockSymbol, ', currentIIDays =', currentIIDays);
    }

    // 渲染法人進出圖表
    function renderInstitutionalInvestorsChart(data) {
        const chartDom = document.getElementById('institutionalInvestorsChart');
        const myChart = echarts.init(chartDom);

        // 反轉數據（從舊到新）
        const reversedData = [...data].reverse();

        const dates = reversedData.map(item => item.date);
        const foreign = reversedData.map(item => item.foreignInvestorBuySell || 0);
        const trust = reversedData.map(item => item.investmentTrustBuySell || 0);
        const dealer = reversedData.map(item => item.dealerBuySell || 0);
        const total = reversedData.map(item => item.totalBuySell || 0);

        const option = {
            title: {
                text: '三大法人買賣超趨勢',
                left: 'center',
                textStyle: {
                    fontSize: 16,
                    fontWeight: 'bold',
                    color: '#1a1a1a'
                }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
                formatter: function(params) {
                    let result = params[0].name + '<br/>';
                    params.forEach(param => {
                        const value = param.value;
                        const color = value > 0 ? '#ef5350' : '#26a69a';
                        result += `<span style="color:${color};">${param.marker}${param.seriesName}: ${formatNumber(value)} 張</span><br/>`;
                    });
                    return result;
                }
            },
            legend: {
                data: ['外資', '投信', '自營商', '合計'],
                top: 30,
                textStyle: {
                    fontSize: 12
                }
            },
            grid: {
                left: '3%',
                right: '4%',
                bottom: '3%',
                top: 70,
                containLabel: true
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: dates,
                axisLabel: {
                    rotate: 45,
                    fontSize: 11
                }
            },
            yAxis: {
                type: 'value',
                name: '張數',
                axisLabel: {
                    formatter: function(value) {
                        return formatNumber(value);
                    }
                },
                splitLine: {
                    lineStyle: {
                        type: 'dashed',
                        color: '#e8eaed'
                    }
                }
            },
            series: [
                {
                    name: '外資',
                    type: 'bar',
                    data: foreign,
                    itemStyle: {
                        color: function(params) {
                            return params.value > 0 ? '#ef5350' : '#26a69a';
                        }
                    }
                },
                {
                    name: '投信',
                    type: 'bar',
                    data: trust,
                    itemStyle: {
                        color: function(params) {
                            return params.value > 0 ? '#ff9800' : '#4caf50';
                        }
                    }
                },
                {
                    name: '自營商',
                    type: 'bar',
                    data: dealer,
                    itemStyle: {
                        color: function(params) {
                            return params.value > 0 ? '#ffc107' : '#8bc34a';
                        }
                    }
                },
                {
                    name: '合計',
                    type: 'line',
                    data: total,
                    lineStyle: {
                        width: 3,
                        color: '#667eea'
                    },
                    itemStyle: {
                        color: '#667eea'
                    },
                    symbol: 'circle',
                    symbolSize: 6
                }
            ]
        };

        myChart.setOption(option);

        // 響應式調整
        window.addEventListener('resize', function() {
            myChart.resize();
        });
    }

    // 渲染法人進出表格
    function renderInstitutionalInvestorsTable(data) {
        const tbody = document.getElementById('iiTableBody');
        tbody.innerHTML = '';

        data.forEach(item => {
            const row = document.createElement('tr');

            // 日期
            const dateCell = document.createElement('td');
            dateCell.textContent = item.date;
            row.appendChild(dateCell);

            // 外資 - 買進
            const foreignBuyCell = document.createElement('td');
            foreignBuyCell.textContent = formatNumber(item.foreignInvestorBuy || 0);
            foreignBuyCell.style.color = '#5f6368';
            row.appendChild(foreignBuyCell);

            // 外資 - 賣出
            const foreignSellCell = document.createElement('td');
            foreignSellCell.textContent = formatNumber(item.foreignInvestorSell || 0);
            foreignSellCell.style.color = '#5f6368';
            row.appendChild(foreignSellCell);

            // 外資 - 買賣超
            const foreignNetCell = document.createElement('td');
            foreignNetCell.textContent = formatNumber(item.foreignInvestorBuySell || 0);
            foreignNetCell.className = item.foreignInvestorBuySell > 0 ? 'ii-value-positive' : 'ii-value-negative';
            row.appendChild(foreignNetCell);

            // 投信 - 買進
            const trustBuyCell = document.createElement('td');
            trustBuyCell.textContent = formatNumber(item.investmentTrustBuy || 0);
            trustBuyCell.style.color = '#5f6368';
            row.appendChild(trustBuyCell);

            // 投信 - 賣出
            const trustSellCell = document.createElement('td');
            trustSellCell.textContent = formatNumber(item.investmentTrustSell || 0);
            trustSellCell.style.color = '#5f6368';
            row.appendChild(trustSellCell);

            // 投信 - 買賣超
            const trustNetCell = document.createElement('td');
            trustNetCell.textContent = formatNumber(item.investmentTrustBuySell || 0);
            trustNetCell.className = item.investmentTrustBuySell > 0 ? 'ii-value-positive' : 'ii-value-negative';
            row.appendChild(trustNetCell);

            // 自營商 - 買進
            const dealerBuyCell = document.createElement('td');
            dealerBuyCell.textContent = formatNumber(item.dealerBuy || 0);
            dealerBuyCell.style.color = '#5f6368';
            row.appendChild(dealerBuyCell);

            // 自營商 - 賣出
            const dealerSellCell = document.createElement('td');
            dealerSellCell.textContent = formatNumber(item.dealerSell || 0);
            dealerSellCell.style.color = '#5f6368';
            row.appendChild(dealerSellCell);

            // 自營商 - 買賣超
            const dealerNetCell = document.createElement('td');
            dealerNetCell.textContent = formatNumber(item.dealerBuySell || 0);
            dealerNetCell.className = item.dealerBuySell > 0 ? 'ii-value-positive' : 'ii-value-negative';
            row.appendChild(dealerNetCell);

            // 三大法人合計 - 買進
            const totalBuyCell = document.createElement('td');
            totalBuyCell.textContent = formatNumber(item.totalBuy || 0);
            totalBuyCell.style.color = '#5f6368';
            row.appendChild(totalBuyCell);

            // 三大法人合計 - 賣出
            const totalSellCell = document.createElement('td');
            totalSellCell.textContent = formatNumber(item.totalSell || 0);
            totalSellCell.style.color = '#5f6368';
            row.appendChild(totalSellCell);

            // 三大法人合計 - 買賣超
            const totalNetCell = document.createElement('td');
            totalNetCell.textContent = formatNumber(item.totalBuySell || 0);
            totalNetCell.className = item.totalBuySell > 0 ? 'ii-value-positive' : 'ii-value-negative';
            row.appendChild(totalNetCell);

            tbody.appendChild(row);
        });
    }

    // 格式化數字（加千分位）
    function formatNumber(num) {
        if (num === null || num === undefined) return '-';
        const formatted = Math.abs(num).toLocaleString();
        return num < 0 ? `-${formatted}` : formatted;
    }

    // 顯示K線型態與趨勢總結（新增）
    function displayPatternTrendSummary(analysis) {
        const summaryPanel = document.getElementById('patternTrendSummary');
        const trendSummaryText = document.getElementById('trendSummaryText');
        const trendSummary = document.getElementById('trendSummary');
        const trendArrow = document.getElementById('trendArrow');
        const patternSummaryText = document.getElementById('patternSummaryText');
        const patternBadges = document.getElementById('patternBadges');
        const volumeSummaryText = document.getElementById('volumeSummaryText');
        const volumeSummary = document.getElementById('volumeSummary');

        let hasContent = false;

        // 1. 趨勢分析
        if (analysis.trendDescription) {
            const trend = analysis.trendDescription;
            trendSummaryText.textContent = trend;

            // 判斷趨勢方向並設定箭頭和顏色
            if (trend.includes('強勢上升') || trend.includes('多頭格局') || trend.includes('上升趨勢')) {
                trendArrow.textContent = '↗';
                trendSummary.classList.add('bullish');
                trendSummary.classList.remove('bearish', 'neutral');
            } else if (trend.includes('弱勢下降') || trend.includes('空頭格局') || trend.includes('下降趨勢')) {
                trendArrow.textContent = '↘';
                trendSummary.classList.add('bearish');
                trendSummary.classList.remove('bullish', 'neutral');
            } else if (trend.includes('盤整') || trend.includes('橫盤')) {
                trendArrow.textContent = '→';
                trendSummary.classList.add('neutral');
                trendSummary.classList.remove('bullish', 'bearish');
            } else {
                trendArrow.textContent = '•';
                trendSummary.classList.add('neutral');
                trendSummary.classList.remove('bullish', 'bearish');
            }
            hasContent = true;
        }

        // 2. K線型態
        const patterns = analysis.candlestickPatternDetails || [];
        if (patterns.length > 0) {
            // 主要型態文字
            const mainPattern = patterns[0];
            patternSummaryText.textContent = `${mainPattern.name} [${mainPattern.reliability}] - ${mainPattern.description}`;

            // 型態標籤
            patternBadges.innerHTML = '';
            patterns.slice(0, 3).forEach(pattern => {
                const badge = document.createElement('div');
                badge.className = 'pattern-badge';

                // 根據 bullish 屬性設定樣式
                if (pattern.bullish === true) {
                    badge.classList.add('bullish');
                } else if (pattern.bullish === false) {
                    badge.classList.add('bearish');
                }

                // 顯示型態名稱和可靠度
                badge.innerHTML = `<span class="pattern-name">${pattern.name}</span> <span class="pattern-reliability">[${pattern.reliability}]</span>`;

                // Tooltip 顯示詳細說明
                badge.title = pattern.description;

                patternBadges.appendChild(badge);
            });
            hasContent = true;
        } else {
            patternSummaryText.textContent = '無明顯型態';
            patternBadges.innerHTML = '';
        }

        // 3. 量價關係
        if (analysis.priceVolumeAnalysis) {
            const volumeText = analysis.priceVolumeAnalysis;
            volumeSummaryText.textContent = volumeText;

            // 判斷量價關係並設定顏色
            if (volumeText.includes('價漲量增') || volumeText.includes('多頭強勢')) {
                volumeSummary.classList.add('bullish');
                volumeSummary.classList.remove('bearish', 'neutral');
            } else if (volumeText.includes('價跌量增') || volumeText.includes('空頭出籠')) {
                volumeSummary.classList.add('bearish');
                volumeSummary.classList.remove('bullish', 'neutral');
            } else {
                volumeSummary.classList.add('neutral');
                volumeSummary.classList.remove('bullish', 'bearish');
            }
            hasContent = true;
        }

        // 顯示或隱藏總結面板
        summaryPanel.style.display = hasContent ? 'block' : 'none';
    }

    // 顯示K線型態分析（僅保留型態識別）
    function displayPatternAnalysis(analysis) {
        const patternAnalysisPanel = document.getElementById('patternAnalysis');
        const patternSection = document.getElementById('patternSection');

        // 顯示K線型態識別
        const patterns = analysis.candlestickPatternDetails || [];
        if (patterns.length > 0) {
            const patternList = document.getElementById('patternList');
            patternList.innerHTML = '';

            patterns.forEach(pattern => {
                const tag = document.createElement('div');
                tag.className = 'pattern-tag';

                // 根據 bullish 屬性設定樣式
                if (pattern.bullish === true) {
                    tag.classList.add('bullish');
                } else if (pattern.bullish === false) {
                    tag.classList.add('bearish');
                }

                // 顯示型態名稱、可靠度和說明
                tag.innerHTML = `<strong>${pattern.name}</strong> [${pattern.reliability}]<br/><small>${pattern.description}</small>`;

                patternList.appendChild(tag);
            });

            patternSection.style.display = 'block';
            patternAnalysisPanel.style.display = 'block';
        } else {
            patternSection.style.display = 'none';
            patternAnalysisPanel.style.display = 'none';
        }
    }

    // 顯示進出場時機分析 - 已移除此功能
    /*
    function displayEntryExitTiming(timing) {
        const timingPanel = document.getElementById('entryExitTiming');
        const timingAction = document.getElementById('timingAction');
        const timingContent = document.getElementById('timingContent');
        const timingAnalysisDetail = document.getElementById('timingAnalysisDetail');
        const timingAnalysisText = document.getElementById('timingAnalysisText');

        // 顯示面板
        timingPanel.style.display = 'block';

        // 顯示操作建議
        timingAction.textContent = timing.action;
        timingAction.className = 'timing-action';
        if (timing.action === '進場') {
            timingAction.classList.add('entry');
        } else if (timing.action === '出場') {
            timingAction.classList.add('exit');
        } else {
            timingAction.classList.add('wait');
        }

        // 清空內容
        timingContent.innerHTML = '';

        // === 進場價格區間 ===
        if (timing.entryPrice !== null && timing.entryPrice !== undefined) {
            const entrySection = document.createElement('div');
            entrySection.className = 'price-section';

            // 計算價格區間
            const entryMin = timing.entryPriceMin !== null ? timing.entryPriceMin : timing.entryPrice;
            const entryMax = timing.entryPriceMax !== null ? timing.entryPriceMax : timing.entryPrice;
            const entryRangeText = entryMin !== entryMax
                ? `${entryMin.toFixed(2)} - ${entryMax.toFixed(2)}`
                : timing.entryPrice.toFixed(2);

            let entryHTML = `<div class="price-section-header">買入價格區間<span class="price-range-value">${entryRangeText}</span></div>`;
            entryHTML += '<div class="price-range-container">';

            // 價格區間視覺化（僅顯示範圍，不顯示具體數字）
            if (timing.entryPriceMin !== null && timing.entryPriceMax !== null) {
                entryHTML += '<div class="price-range-visual">';
                entryHTML += `<div class="price-range-bar entry-bar">`;
                entryHTML += `<span class="range-label">保守</span>`;
                entryHTML += `<span class="range-label center">建議</span>`;
                entryHTML += `<span class="range-label">積極</span>`;
                entryHTML += '</div></div>';
            }

            // 價格卡片
            entryHTML += '<div class="price-cards-row">';

            if (timing.entryPriceMin !== null && timing.entryPriceMin !== undefined) {
                entryHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">最佳買入價</div>
                        <div class="timing-price entry-price">${timing.entryPriceMin.toFixed(2)}</div>
                        <div class="timing-subtitle">保守策略・耐心等待</div>
                    </div>
                `;
            }

            entryHTML += `
                <div class="timing-card compact featured">
                    <div class="timing-card-title">建議買入價</div>
                    <div class="timing-price entry-price" style="font-size: 1.8em;">${timing.entryPrice.toFixed(2)}</div>
                    <div class="timing-subtitle">平衡風險與機會</div>
                </div>
            `;

            if (timing.entryPriceMax !== null && timing.entryPriceMax !== undefined) {
                entryHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">可接受買入價</div>
                        <div class="timing-price entry-price">${timing.entryPriceMax.toFixed(2)}</div>
                        <div class="timing-subtitle">積極策略・急於進場</div>
                    </div>
                `;
            }

            entryHTML += '</div></div>';
            entrySection.innerHTML = entryHTML;
            timingContent.appendChild(entrySection);
        }

        // === 出場價格區間 ===
        if (timing.exitPrice !== null && timing.exitPrice !== undefined) {
            const exitSection = document.createElement('div');
            exitSection.className = 'price-section';

            // 計算價格區間
            const exitMin = timing.exitPriceMin !== null ? timing.exitPriceMin : timing.exitPrice;
            const exitMax = timing.exitPriceMax !== null ? timing.exitPriceMax : timing.exitPrice;
            const exitRangeText = exitMin !== exitMax
                ? `${exitMin.toFixed(2)} - ${exitMax.toFixed(2)}`
                : timing.exitPrice.toFixed(2);

            let exitHTML = `<div class="price-section-header">賣出價格區間<span class="price-range-value">${exitRangeText}</span></div>`;
            exitHTML += '<div class="price-range-container">';

            // 價格區間視覺化（僅顯示範圍，不顯示具體數字）
            if (timing.exitPriceMin !== null && timing.exitPriceMax !== null) {
                exitHTML += '<div class="price-range-visual">';
                exitHTML += `<div class="price-range-bar exit-bar">`;
                exitHTML += `<span class="range-label">保守</span>`;
                exitHTML += `<span class="range-label center">建議</span>`;
                exitHTML += `<span class="range-label">積極</span>`;
                exitHTML += '</div></div>';
            }

            // 價格卡片
            exitHTML += '<div class="price-cards-row">';

            if (timing.exitPriceMin !== null && timing.exitPriceMin !== undefined) {
                exitHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">保守賣出價</div>
                        <div class="timing-price exit-price">${timing.exitPriceMin.toFixed(2)}</div>
                        <div class="timing-subtitle">確保獲利・提早出場</div>
                    </div>
                `;
            }

            exitHTML += `
                <div class="timing-card compact featured">
                    <div class="timing-card-title">建議賣出價</div>
                    <div class="timing-price exit-price" style="font-size: 1.8em;">${timing.exitPrice.toFixed(2)}</div>
                    <div class="timing-subtitle">平衡風險與收益</div>
                </div>
            `;

            if (timing.exitPriceMax !== null && timing.exitPriceMax !== undefined) {
                exitHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">最佳賣出價</div>
                        <div class="timing-price exit-price">${timing.exitPriceMax.toFixed(2)}</div>
                        <div class="timing-subtitle">積極策略・等待高點</div>
                    </div>
                `;
            }

            exitHTML += '</div></div>';
            exitSection.innerHTML = exitHTML;
            timingContent.appendChild(exitSection);
        }

        // === 風險控制與目標區 ===
        const hasRiskControl = timing.stopLossPrice || timing.takeProfit1 || timing.takeProfit2 || timing.riskRewardRatio || timing.positionSize;

        if (hasRiskControl) {
            const riskSection = document.createElement('div');
            riskSection.className = 'price-section';

            let riskHTML = '<div class="price-section-header">風險控制與目標</div>';
            riskHTML += '<div class="price-cards-row">';

            // 停損價
            if (timing.stopLossPrice !== null && timing.stopLossPrice !== undefined) {
                riskHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">停損價位</div>
                        <div class="timing-price stop-loss">${timing.stopLossPrice.toFixed(2)}</div>
                        <div class="timing-subtitle">跌破此價位停損</div>
                    </div>
                `;
            }

            // 第一停利價
            if (timing.takeProfit1 !== null && timing.takeProfit1 !== undefined) {
                riskHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">第一目標價</div>
                        <div class="timing-price take-profit">${timing.takeProfit1.toFixed(2)}</div>
                        <div class="timing-subtitle">建議分批出場 50%</div>
                    </div>
                `;
            }

            // 第二停利價
            if (timing.takeProfit2 !== null && timing.takeProfit2 !== undefined) {
                riskHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">第二目標價</div>
                        <div class="timing-price take-profit">${timing.takeProfit2.toFixed(2)}</div>
                        <div class="timing-subtitle">建議全部出場</div>
                    </div>
                `;
            }

            // 風險報酬比
            if (timing.riskRewardRatio) {
                riskHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">風險報酬比</div>
                        <div class="timing-price" style="color: #1a73e8;">${timing.riskRewardRatio}</div>
                        <div class="timing-subtitle">每 1 元風險的潛在報酬</div>
                    </div>
                `;
            }

            // 建議部位大小
            if (timing.positionSize !== null && timing.positionSize !== undefined) {
                const positionLabel = timing.action === '進場' ? '建議資金配置比例' : timing.action === '出場' ? '建議出場比例' : '不建議操作';
                riskHTML += `
                    <div class="timing-card compact">
                        <div class="timing-card-title">建議部位</div>
                        <div class="timing-price" style="color: #9334e6;">${timing.positionSize}%</div>
                        <div class="timing-subtitle">${positionLabel}</div>
                    </div>
                `;
            }

            riskHTML += '</div>';
            riskSection.innerHTML = riskHTML;
            timingContent.appendChild(riskSection);
        }

        // 顯示整合的分析與建議
        if (timing.analysisDetail) {
            timingAnalysisDetail.style.display = 'block';
            timingAnalysisText.textContent = timing.analysisDetail;
        } else {
            timingAnalysisDetail.style.display = 'none';
        }
    }
    */

    // 渲染圖表
    function renderChart(data, symbol) {
        chart.hideLoading();

        // 準備數據
        const dates = data.map(item => item.date);
        const ohlc = data.map(item => [item.open, item.close, item.low, item.high]);
        const volumes = data.map(item => item.volume);

        // 調試：檢查影線
        const sampleData = data.slice(0, 5);
        console.log('檢查前 5 筆 K 線數據：');
        sampleData.forEach((item, idx) => {
            const upperShadow = item.high - Math.max(item.open, item.close);
            const lowerShadow = Math.min(item.open, item.close) - item.low;
            console.log(`  ${idx + 1}. ${item.date}:`, {
                開盤: item.open,
                收盤: item.close,
                最高: item.high,
                最低: item.low,
                上影線: upperShadow.toFixed(2),
                下影線: lowerShadow.toFixed(2)
            });
        });

        // SMA 均線配置（實線）
        const maConfig = [
            { name: 'MA5', color: '#FF1493', dashStyle: 'solid' },
            { name: 'MA10', color: '#00CED1', dashStyle: 'solid' },
            { name: 'MA20', color: '#FFD700', dashStyle: 'solid' },
            { name: 'MA60', color: '#9370DB', dashStyle: 'solid' }
        ];

        // EMA 均線配置（虛線）
        const emaConfig = [
            { name: 'EMA5', color: '#FF69B4', dashStyle: 'dashed' },
            { name: 'EMA10', color: '#00BFFF', dashStyle: 'dashed' },
            { name: 'EMA20', color: '#FFD700', dashStyle: 'dashed' },
            { name: 'EMA60', color: '#BA55D3', dashStyle: 'dashed' }
        ];

        // 提取均線數據（後端已計算好）
        const maData = {
            'MA5': data.map(item => item.ma5),
            'MA10': data.map(item => item.ma10),
            'MA20': data.map(item => item.ma20),
            'MA60': data.map(item => item.ma60)
        };

        // 提取 EMA 數據
        const emaData = {
            'EMA5': data.map(item => item.ema5),
            'EMA10': data.map(item => item.ema10),
            'EMA20': data.map(item => item.ema20),
            'EMA60': data.map(item => item.ema60)
        };

        // 檢測稀疏數據區域（用於視覺標記）
        const isSparseData = new Array(data.length).fill(false);
        for (let i = 1; i < data.length; i++) {
            const prevDate = new Date(data[i - 1].date);
            const currDate = new Date(data[i].date);
            const daysDiff = (currDate - prevDate) / (1000 * 60 * 60 * 24);

            if (daysDiff > 5) {
                for (let j = Math.max(0, i - 5); j <= Math.min(data.length - 1, i + 5); j++) {
                    isSparseData[j] = true;
                }
            }
        }

        // 計算顯示範圍：預設顯示全部 12 個月
        const zoomStart = 0;
        const zoomEnd = 100;

        // 找出稀疏數據區域，用於標記
        const sparseAreas = [];
        let areaStart = null;
        for (let i = 0; i < isSparseData.length; i++) {
            if (isSparseData[i] && areaStart === null) {
                areaStart = i;
            } else if (!isSparseData[i] && areaStart !== null) {
                sparseAreas.push([{ xAxis: dates[areaStart] }, { xAxis: dates[i - 1] }]);
                areaStart = null;
            }
        }
        if (areaStart !== null) {
            sparseAreas.push([{ xAxis: dates[areaStart] }, { xAxis: dates[dates.length - 1] }]);
        }

        const option = {
            title: {
                text: `${symbol} K線圖`,
                left: 'center',
                textStyle: {
                    fontSize: 20,
                    fontWeight: 600,
                    color: '#212529'
                }
            },
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'cross'
                },
                formatter: function (params) {
                    const dataIndex = params[0].dataIndex;
                    const item = data[dataIndex];

                    let maInfo = '';
                    maConfig.forEach(config => {
                        const maValue = maData[config.name][dataIndex];
                        if (maValue !== null && maValue !== undefined) {
                            maInfo += `<span style="color: ${config.color}; font-weight: 600;">${config.name}: ${maValue.toFixed(2)}</span><br/>`;
                        }
                    });

                    let emaInfo = '';
                    emaConfig.forEach(config => {
                        const emaValue = emaData[config.name][dataIndex];
                        if (emaValue !== null && emaValue !== undefined) {
                            emaInfo += `<span style="color: ${config.color}; font-weight: 600;">${config.name}: ${emaValue.toFixed(2)}</span><br/>`;
                        }
                    });

                    return `
                    <div style="padding: 10px;">
                        <strong>${item.date}</strong><br/>
                        開盤: ${item.open.toFixed(2)}<br/>
                        最高: ${item.high.toFixed(2)}<br/>
                        最低: ${item.low.toFixed(2)}<br/>
                        收盤: ${item.close.toFixed(2)}<br/>
                        ${maInfo}
                        ${emaInfo}
                        成交量: ${item.volume.toLocaleString()} 張<br/>
                        成交額: ${item.turnover.toLocaleString()} 千元<br/>
                        漲跌: <span style="color: ${item.change >= 0 ? '#ef5350' : '#26a69a'}">${item.change >= 0 ? '+' : ''}${item.change.toFixed(2)} (${item.changePercent >= 0 ? '+' : ''}${item.changePercent.toFixed(2)}%)</span>
                    </div>
                `;
                }
            },
            legend: {
                data: ['K線', ...maConfig.map(c => c.name), ...emaConfig.map(c => c.name), '成交量'],
                top: 40,
                left: 'center'
            },
            grid: [
                {
                    left: '8%',
                    right: '8%',
                    top: '15%',
                    height: '50%'
                },
                {
                    left: '8%',
                    right: '8%',
                    top: '70%',
                    height: '15%'
                }
            ],
            xAxis: [
                {
                    type: 'category',
                    data: dates,
                    boundaryGap: true,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: {
                        formatter: function (value) {
                            return value.substring(5);
                        }
                    },
                    min: 'dataMin',
                    max: 'dataMax',
                    axisPointer: {
                        show: true
                    }
                },
                {
                    type: 'category',
                    gridIndex: 1,
                    data: dates,
                    boundaryGap: true,
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    axisLabel: { show: false },
                    axisTick: { show: false },
                    min: 'dataMin',
                    max: 'dataMax'
                }
            ],
            yAxis: [
                {
                    scale: true,
                    splitArea: {
                        show: true
                    },
                    axisLine: { lineStyle: { color: '#8392A5' } },
                    splitLine: { show: true },
                    axisTick: { show: false },
                    axisLabel: {
                        formatter: '{value}'
                    }
                },
                {
                    scale: true,
                    gridIndex: 1,
                    splitNumber: 2,
                    axisLabel: { show: false },
                    axisLine: { show: false },
                    axisTick: { show: false },
                    splitLine: { show: false }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: [0, 1],
                    start: zoomStart,
                    end: zoomEnd
                },
                {
                    show: true,
                    xAxisIndex: [0, 1],
                    type: 'slider',
                    bottom: '5%',
                    start: zoomStart,
                    end: zoomEnd,
                    handleIcon: 'path://M10.7,11.9v-1.3H9.3v1.3c-4.9,0.3-8.8,4.4-8.8,9.4c0,5,3.9,9.1,8.8,9.4v1.3h1.3v-1.3c4.9-0.3,8.8-4.4,8.8-9.4C19.5,16.3,15.6,12.2,10.7,11.9z M13.3,24.4H6.7V23h6.6V24.4z M13.3,19.6H6.7v-1.4h6.6V19.6z',
                    handleSize: '80%',
                    handleStyle: {
                        color: '#fff',
                        shadowBlur: 3,
                        shadowColor: 'rgba(0, 0, 0, 0.6)',
                        shadowOffsetX: 2,
                        shadowOffsetY: 2
                    }
                }
            ],
            series: [
                {
                    name: 'K線',
                    type: 'candlestick',
                    data: ohlc,
                    itemStyle: {
                        color: '#ef5350',        // 陽線實體顏色（紅色）
                        color0: '#26a69a',       // 陰線實體顏色（綠色）
                        borderColor: '#ef5350',  // 陽線邊框和影線顏色
                        borderColor0: '#26a69a', // 陰線邊框和影線顏色
                        borderWidth: 1           // 邊框和影線寬度（關鍵！）
                    },
                    emphasis: {
                        itemStyle: {
                            borderColor: '#000',
                            borderWidth: 2
                        }
                    },
                    markArea: sparseAreas.length > 0 ? {
                        silent: true,
                        itemStyle: {
                            color: 'rgba(255, 173, 177, 0.15)'
                        },
                        data: sparseAreas,
                        label: {
                            show: true,
                            position: 'insideTop',
                            formatter: '數據稀疏區域\n(休市期間)',
                            fontSize: 11,
                            color: '#999'
                        }
                    } : undefined
                },
                // 動態添加 SMA 均線（實線）
                ...maConfig.map(config => ({
                    name: config.name,
                    type: 'line',
                    data: maData[config.name],
                    smooth: false,
                    lineStyle: {
                        width: 2,
                        color: config.color,
                        type: 'solid'
                    },
                    showSymbol: false,
                    z: 1
                })),
                // 動態添加 EMA 均線（虛線）
                ...emaConfig.map(config => ({
                    name: config.name,
                    type: 'line',
                    data: emaData[config.name],
                    smooth: false,
                    lineStyle: {
                        width: 2,
                        color: config.color,
                        type: 'dashed'
                    },
                    showSymbol: false,
                    z: 1
                })),
                {
                    name: '成交量',
                    type: 'bar',
                    xAxisIndex: 1,
                    yAxisIndex: 1,
                    data: volumes,
                    itemStyle: {
                        color: function (params) {
                            const item = data[params.dataIndex];
                            return item.close >= item.open ? '#ef5350' : '#26a69a';
                        }
                    }
                }
            ]
        };

        chart.setOption(option, true);
    }

    // 更新股票資訊
    function updateStockInfo(data) {
        const stockInfo = document.getElementById('stockInfo');
        const infoGrid = document.getElementById('infoGrid');

        const latestData = data[data.length - 1];
        const firstData = data[0];

        const periodChange = latestData.close - firstData.open;
        const periodChangePercent = (periodChange / firstData.open) * 100;

        infoGrid.innerHTML = `
        <div class="info-item stock-name-item">
            <div class="info-label">股票</div>
            <div class="info-value"><strong>${latestData.name || latestData.symbol}</strong> (${latestData.symbol})</div>
        </div>
        <div class="info-item">
            <div class="info-label">最新日期</div>
            <div class="info-value">${latestData.date}</div>
        </div>
        <div class="info-item">
            <div class="info-label">收盤價</div>
            <div class="info-value">${latestData.close.toFixed(2)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">當日漲跌</div>
            <div class="info-value ${latestData.change >= 0 ? 'positive' : 'negative'}">
                ${latestData.change >= 0 ? '+' : ''}${latestData.change.toFixed(2)} (${latestData.changePercent >= 0 ? '+' : ''}${latestData.changePercent.toFixed(2)}%)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">區間漲跌</div>
            <div class="info-value ${periodChange >= 0 ? 'positive' : 'negative'}">
                ${periodChange >= 0 ? '+' : ''}${periodChange.toFixed(2)} (${periodChangePercent >= 0 ? '+' : ''}${periodChangePercent.toFixed(2)}%)
            </div>
        </div>
        <div class="info-item">
            <div class="info-label">最高價</div>
            <div class="info-value">${latestData.high.toFixed(2)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">最低價</div>
            <div class="info-value">${latestData.low.toFixed(2)}</div>
        </div>
        <div class="info-item">
            <div class="info-label">成交量</div>
            <div class="info-value">${latestData.volume.toLocaleString()} 張</div>
        </div>
        <div class="info-item">
            <div class="info-label">成交金額</div>
            <div class="info-value">${(latestData.turnover / 1000).toFixed(0)} 百萬</div>
        </div>
    `;

        stockInfo.classList.add('active');
    }

    // 事件監聽
    document.getElementById('queryBtn').addEventListener('click', queryKLine);

    document.getElementById('symbolInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            queryKLine();
        }
    });

    // 快速選股按鈕
    document.querySelectorAll('.quick-stock-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.getElementById('symbolInput').value = btn.dataset.symbol;
            queryKLine();
        });
    });

    // 響應式調整
    window.addEventListener('resize', () => {
        if (chart) {
            chart.resize();
        }
    });

    // 使用事件委派處理期間選擇器按鈕點擊（綁定到 document，避免 DOM 重建問題）
    document.addEventListener('click', function(event) {
        // 檢查點擊的是否為期間選擇按鈕
        if (event.target.classList.contains('ii-period-btn')) {
            event.preventDefault();

            const button = event.target;
            const days = parseInt(button.getAttribute('data-days'));

            console.log(`========== 期間選擇器被點擊 ==========`);
            console.log(`選擇天數: ${days}`);
            console.log(`當前股票: ${currentStockSymbol}`);
            console.log(`當前天數: ${currentIIDays}`);

            // 移除所有 active 狀態
            document.querySelectorAll('.ii-period-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // 設置當前按鈕為 active
            button.classList.add('active');

            if (currentStockSymbol) {
                console.log(`準備查詢 ${currentStockSymbol} 的 ${days} 天法人進出資料`);
                fetchInstitutionalInvestors(currentStockSymbol, days);
            } else {
                console.warn('currentStockSymbol 為 null，無法查詢');
            }
        }
    });

    // 初始化並自動查詢
    window.addEventListener('load', () => {
        initStockList();  // 初始化股票列表選項
        initChart();
        queryKLine();
    });
</script>
</body>

</html>