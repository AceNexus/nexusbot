<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>即時成交明細監控</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes pulse-green { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-red { animation: pulse-red 1s ease-in-out infinite; }
        .animate-pulse-green { animation: pulse-green 1s ease-in-out infinite; }
        .tick-row-enter { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;

    // 顏色常數
    const COLORS = {
        BUY: '#dc2626',      // 外盤 - 紅色
        SELL: '#16a34a',     // 內盤 - 綠色
        NEUTRAL: '#9ca3af',  // 中性 - 灰色
        BIG_TRADE: '#fef3c7' // 大單提示 - 淡黃
    };

    // 格式化數字
    const formatNumber = (num) => {
        if (num === null || num === undefined) return '-';
        return num.toLocaleString('zh-TW');
    };

    // 格式化價格
    const formatPrice = (price) => {
        if (price === null || price === undefined) return '-';
        return parseFloat(price).toFixed(2);
    };

    // 格式化時間
    const formatTime = (timeStr) => {
        if (!timeStr) return '-';
        try {
            const date = new Date(timeStr);
            return date.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        } catch {
            return timeStr;
        }
    };

    // 連線狀態指示器
    const ConnectionStatus = ({ connected, fugleReady, subscribed, maxSubscriptions }) => (
        <div className="flex items-center gap-4 text-sm">
            <div className="flex items-center gap-2">
                <span className={`w-3 h-3 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}`}></span>
                <span className="text-gray-600">{connected ? 'WebSocket 已連線' : 'WebSocket 未連線'}</span>
            </div>
            <div className="flex items-center gap-2">
                <span className={`w-3 h-3 rounded-full ${fugleReady ? 'bg-green-500' : 'bg-yellow-500 animate-pulse'}`}></span>
                <span className="text-gray-600">{fugleReady ? 'Fugle 就緒' : 'Fugle 連線中...'}</span>
            </div>
            <div className="text-gray-600">
                訂閱: {subscribed}/{maxSubscriptions}
            </div>
        </div>
    );

    // 股票搜尋元件
    const StockSearch = ({ onSelect, disabled }) => {
        const [query, setQuery] = useState('');
        const [results, setResults] = useState([]);
        const [loading, setLoading] = useState(false);
        const [showDropdown, setShowDropdown] = useState(false);
        const inputRef = useRef(null);

        useEffect(() => {
            if (query.length < 1) {
                setResults([]);
                return;
            }

            const timer = setTimeout(async () => {
                setLoading(true);
                try {
                    const res = await fetch('/api/stock/list');
                    const stocks = await res.json();
                    const filtered = stocks.filter(s =>
                        s.symbol.includes(query) || s.name.includes(query)
                    ).slice(0, 10);
                    setResults(filtered);
                    setShowDropdown(true);
                } catch (e) {
                    console.error('搜尋失敗:', e);
                } finally {
                    setLoading(false);
                }
            }, 300);

            return () => clearTimeout(timer);
        }, [query]);

        const handleSelect = (stock) => {
            onSelect(stock);
            setQuery('');
            setResults([]);
            setShowDropdown(false);
        };

        return (
            <div className="relative">
                <div className="flex gap-2">
                    <input
                        ref={inputRef}
                        type="text"
                        value={query}
                        onChange={(e) => setQuery(e.target.value)}
                        onFocus={() => results.length > 0 && setShowDropdown(true)}
                        placeholder="輸入股票代號或名稱..."
                        className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                        disabled={disabled}
                    />
                </div>
                {showDropdown && results.length > 0 && (
                    <div className="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                        {results.map(stock => (
                            <div
                                key={stock.symbol}
                                onClick={() => handleSelect(stock)}
                                className="px-4 py-2 hover:bg-blue-50 cursor-pointer flex justify-between items-center"
                            >
                                <span className="font-medium">{stock.symbol}</span>
                                <span className="text-gray-600">{stock.name}</span>
                                <span className="text-xs text-gray-400">{stock.market}</span>
                            </div>
                        ))}
                    </div>
                )}
            </div>
        );
    };

    // 監控中的股票標籤
    const StockTag = ({ symbol, name, onRemove, isActive, onClick }) => (
        <div
            onClick={onClick}
            className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-full cursor-pointer transition-all ${
                isActive ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'
            }`}
        >
            <span className="font-medium">{symbol}</span>
            <span className="text-sm opacity-80">{name}</span>
            <button
                onClick={(e) => { e.stopPropagation(); onRemove(); }}
                className="ml-1 w-5 h-5 flex items-center justify-center rounded-full hover:bg-black/20"
            >
                &times;
            </button>
        </div>
    );

    // 內外盤統計
    const TickStatsPanel = ({ stats }) => {
        if (!stats || !stats.symbol) {
            return (
                <div className="bg-white rounded-lg p-4 shadow">
                    <div className="text-gray-500 text-center py-8">
                        請選擇股票開始監控
                    </div>
                </div>
            );
        }

        const buyRatio = stats.buyRatio || 50;
        const sellRatio = 100 - buyRatio;

        return (
            <div className="bg-white rounded-lg p-4 shadow">
                <h3 className="text-lg font-semibold mb-4 text-gray-800">內外盤統計</h3>

                {/* 比例條 */}
                <div className="mb-4">
                    <div className="flex h-6 rounded-full overflow-hidden bg-gray-200">
                        <div
                            className="transition-all duration-500"
                            style={{ width: `${buyRatio}%`, backgroundColor: COLORS.BUY }}
                        ></div>
                        <div
                            className="transition-all duration-500"
                            style={{ width: `${sellRatio}%`, backgroundColor: COLORS.SELL }}
                        ></div>
                    </div>
                    <div className="flex justify-between mt-1 text-sm">
                        <span style={{ color: COLORS.BUY }}>外盤 {buyRatio.toFixed(1)}%</span>
                        <span style={{ color: COLORS.SELL }}>內盤 {sellRatio.toFixed(1)}%</span>
                    </div>
                </div>

                {/* 統計數據 */}
                <div className="grid grid-cols-2 gap-4 text-sm">
                    <div className="bg-gray-50 rounded p-3">
                        <div className="text-gray-500">現價</div>
                        <div className="text-xl font-bold text-gray-800">
                            {formatPrice(stats.lastPrice)}
                        </div>
                    </div>
                    <div className="bg-gray-50 rounded p-3">
                        <div className="text-gray-500">均價</div>
                        <div className="text-xl font-bold text-gray-800">
                            {formatPrice(stats.avgPrice)}
                        </div>
                    </div>
                    <div className="bg-gray-50 rounded p-3">
                        <div className="text-gray-500">總量</div>
                        <div className="text-lg font-semibold text-gray-800">
                            {formatNumber(stats.totalVolumeLots || Math.floor((stats.totalVolume || 0) / 1000))} 張
                        </div>
                    </div>
                    <div className="bg-gray-50 rounded p-3">
                        <div className="text-gray-500">筆數</div>
                        <div className="text-lg font-semibold text-gray-800">
                            {formatNumber(stats.totalTicks)}
                        </div>
                    </div>
                    <div className="bg-gray-50 rounded p-3" style={{ borderLeft: `3px solid ${COLORS.BUY}` }}>
                        <div className="text-gray-500">外盤量</div>
                        <div className="font-semibold" style={{ color: COLORS.BUY }}>
                            {formatNumber(stats.buyVolumeLots || Math.floor((stats.buyVolume || 0) / 1000))} 張
                        </div>
                    </div>
                    <div className="bg-gray-50 rounded p-3" style={{ borderLeft: `3px solid ${COLORS.SELL}` }}>
                        <div className="text-gray-500">內盤量</div>
                        <div className="font-semibold" style={{ color: COLORS.SELL }}>
                            {formatNumber(stats.sellVolumeLots || Math.floor((stats.sellVolume || 0) / 1000))} 張
                        </div>
                    </div>
                </div>

                {/* 高低價 */}
                <div className="mt-4 pt-4 border-t border-gray-200">
                    <div className="flex justify-between text-sm">
                        <span className="text-gray-500">最高: <span className="text-red-600 font-medium">{formatPrice(stats.highPrice)}</span></span>
                        <span className="text-gray-500">最低: <span className="text-green-600 font-medium">{formatPrice(stats.lowPrice)}</span></span>
                    </div>
                </div>
            </div>
        );
    };

    // 成交明細列表
    const TickList = ({ ticks, symbol }) => {
        const listRef = useRef(null);
        const [autoScroll, setAutoScroll] = useState(true);

        useEffect(() => {
            if (autoScroll && listRef.current) {
                listRef.current.scrollTop = 0;
            }
        }, [ticks, autoScroll]);

        const getTickColor = (tickType) => {
            if (tickType === 'BUY') return COLORS.BUY;
            if (tickType === 'SELL') return COLORS.SELL;
            return COLORS.NEUTRAL;
        };

        const getTickLabel = (tickType) => {
            if (tickType === 'BUY') return '外盤';
            if (tickType === 'SELL') return '內盤';
            return '中性';
        };

        if (!symbol) {
            return (
                <div className="bg-white rounded-lg p-4 shadow h-full">
                    <div className="text-gray-500 text-center py-8">
                        請選擇股票開始監控
                    </div>
                </div>
            );
        }

        return (
            <div className="bg-white rounded-lg shadow h-full flex flex-col">
                <div className="p-4 border-b border-gray-200 flex justify-between items-center">
                    <h3 className="text-lg font-semibold text-gray-800">成交明細 (即時滾動)</h3>
                    <label className="flex items-center gap-2 text-sm text-gray-600">
                        <input
                            type="checkbox"
                            checked={autoScroll}
                            onChange={(e) => setAutoScroll(e.target.checked)}
                            className="w-4 h-4"
                        />
                        自動捲動
                    </label>
                </div>

                <div className="grid grid-cols-4 gap-2 px-4 py-2 bg-gray-50 text-sm font-medium text-gray-600 border-b">
                    <div>時間</div>
                    <div className="text-right">價格</div>
                    <div className="text-right">張數</div>
                    <div className="text-center">內/外</div>
                </div>

                <div
                    ref={listRef}
                    className="flex-1 overflow-y-auto scrollbar-hide"
                    style={{ maxHeight: '400px' }}
                >
                    {ticks.length === 0 ? (
                        <div className="text-gray-500 text-center py-8">
                            等待即時成交數據...
                        </div>
                    ) : (
                        ticks.slice().reverse().map((tick, idx) => {
                            const lots = tick.volumeLots || Math.floor((tick.volume || 0) / 1000);
                            const isBigTrade = lots >= 100;
                            return (
                                <div
                                    key={`${tick.serial || idx}-${tick.time}`}
                                    className={`grid grid-cols-4 gap-2 px-4 py-2 border-b border-gray-100 text-sm tick-row-enter ${
                                        isBigTrade ? 'bg-yellow-50' : ''
                                    }`}
                                >
                                    <div className="text-gray-600">{formatTime(tick.time)}</div>
                                    <div className="text-right font-medium">{formatPrice(tick.price)}</div>
                                    <div className={`text-right font-medium ${isBigTrade ? 'text-orange-600' : ''}`}>
                                        {formatNumber(lots)}
                                    </div>
                                    <div className="text-center">
                                        <span
                                            className="inline-block px-2 py-0.5 rounded text-white text-xs"
                                            style={{ backgroundColor: getTickColor(tick.tickType) }}
                                        >
                                            {getTickLabel(tick.tickType)}
                                        </span>
                                    </div>
                                </div>
                            );
                        })
                    )}
                </div>
            </div>
        );
    };

    // 大單警示面板
    const BigTradePanel = ({ bigTrades }) => (
        <div className="bg-white rounded-lg shadow">
            <div className="p-4 border-b border-gray-200">
                <h3 className="text-lg font-semibold text-gray-800">大單警示 (&ge;100張)</h3>
            </div>
            <div className="max-h-48 overflow-y-auto scrollbar-hide">
                {bigTrades.length === 0 ? (
                    <div className="text-gray-500 text-center py-4 text-sm">
                        暫無大單成交
                    </div>
                ) : (
                    bigTrades.slice().reverse().map((trade, idx) => {
                        const lots = trade.lots || trade.volumeLots || Math.floor((trade.volume || 0) / 1000);
                        const isBuy = trade.tickType === 'BUY';
                        // 使用淡紅/淡綠背景，強化視覺
                        const bgColor = isBuy ? '#fef2f2' : '#f0fdf4'; 
                        const textColor = isBuy ? 'text-red-600' : 'text-green-600';
                        const label = isBuy ? '外盤買進' : '內盤賣出';

                        return (
                            <div
                                key={`big-${idx}-${trade.time}`}
                                className="px-4 py-3 border-b border-gray-100 flex items-center gap-4 text-sm transition-colors duration-300"
                                style={{ backgroundColor: bgColor }}
                            >
                                <span className="text-gray-600 w-20">{formatTime(trade.time)}</span>
                                <span className="font-bold w-16">{trade.symbol}</span>
                                
                                <span className={`px-2 py-0.5 rounded text-white text-xs font-bold ${isBuy ? 'bg-red-500' : 'bg-green-500'}`}>
                                    {label}
                                </span>
                                
                                <span className={`font-bold flex-1 text-right ${textColor}`}>
                                    {formatNumber(lots)} 張
                                </span>
                                
                                <span className="text-gray-800 font-medium w-24 text-right">
                                    @ {formatPrice(trade.price)}
                                </span>
                            </div>
                        );
                    })
                )}
            </div>
        </div>
    );

    // 主應用
    const App = () => {
        const [connected, setConnected] = useState(false);
        const [stompClient, setStompClient] = useState(null);
        const [monitoredStocks, setMonitoredStocks] = useState([]);
        const [activeSymbol, setActiveSymbol] = useState(null);
        const [ticksMap, setTicksMap] = useState({});
        const [statsMap, setStatsMap] = useState({});
        const [bigTrades, setBigTrades] = useState([]);
        const [subscribed, setSubscribed] = useState(0);
        const [maxSubscriptions, setMaxSubscriptions] = useState(5);
        const [fugleReady, setFugleReady] = useState(false);
        const [errorMsg, setErrorMsg] = useState(null);
        const subscriptionsRef = useRef({});

        // 建立 WebSocket 連線
        useEffect(() => {
            const socket = new SockJS('/ws');
            const client = Stomp.over(socket);
            client.debug = null; // 關閉 debug 輸出

            client.connect({}, () => {
                console.log('WebSocket 連線成功');
                setConnected(true);
                setStompClient(client);

                // 訂閱大單頻道
                client.subscribe('/topic/big-trades', (message) => {
                    const data = JSON.parse(message.body);
                    if (data.type === 'BIG_TRADE') {
                        setBigTrades(prev => [...prev.slice(-99), { ...data.data, symbol: data.symbol, lots: data.lots }]);
                    }
                });

                // 訂閱全局狀態頻道 (接收同步、訂閱/取消訂閱通知)
                client.subscribe('/topic/tick-status', (message) => {
                    const data = JSON.parse(message.body);
                    if (data.subscribed !== undefined) setSubscribed(data.subscribed);
                    if (data.maxSubscriptions !== undefined) setMaxSubscriptions(data.maxSubscriptions);
                    if (data.fugleReady !== undefined) setFugleReady(data.fugleReady);

                    if (data.type === 'SYNC' && data.symbols) {
                        // 收到同步訊息，載入現有監控的股票
                        console.log('同步監控列表:', data.symbols);
                        data.symbols.forEach(symbol => {
                            // 訂閱該股票的 WebSocket 頻道
                            if (!subscriptionsRef.current[symbol]) {
                                subscribeToSymbolChannel(client, symbol);
                            }
                        });
                        // 直接從 SYNC 回應載入統計數據（避免時序問題）
                        if (data.symbolStats) {
                            Object.entries(data.symbolStats).forEach(([symbol, stats]) => {
                                setStatsMap(prev => ({ ...prev, [symbol]: stats }));
                            });
                        }
                    } else if (data.type === 'SUBSCRIBE_RESULT') {
                        const symbol = data.symbol;
                        if (data.result === 'FUGLE') {
                            // 訂閱成功，同步訂閱該股票頻道
                            if (!subscriptionsRef.current[symbol]) {
                                subscribeToSymbolChannel(client, symbol);
                            }
                            setErrorMsg(null);
                        } else {
                            // 訂閱失敗，移除前端已加入的股票標籤
                            console.error('訂閱失敗:', symbol, data.error || data.result);
                            if (subscriptionsRef.current[symbol]) {
                                subscriptionsRef.current[symbol].unsubscribe();
                                delete subscriptionsRef.current[symbol];
                            }
                            setMonitoredStocks(prev => {
                                const remaining = prev.filter(s => s.symbol !== symbol);
                                setActiveSymbol(prevActive =>
                                    prevActive === symbol
                                        ? (remaining.length > 0 ? remaining[0].symbol : null)
                                        : prevActive
                                );
                                return remaining;
                            });
                            setTicksMap(prev => { const next = {...prev}; delete next[symbol]; return next; });
                            setStatsMap(prev => { const next = {...prev}; delete next[symbol]; return next; });
                            setErrorMsg(data.error || '訂閱失敗: ' + data.result);
                            setTimeout(() => setErrorMsg(null), 5000);
                        }
                    } else if (data.type === 'UNSUBSCRIBE_RESULT') {
                        // 股票被移除，同步取消訂閱
                        const symbol = data.symbol;
                        if (subscriptionsRef.current[symbol]) {
                            subscriptionsRef.current[symbol].unsubscribe();
                            delete subscriptionsRef.current[symbol];
                            // 移除本地狀態
                            setMonitoredStocks(prev => {
                                const remaining = prev.filter(s => s.symbol !== symbol);
                                // 如果被移除的是當前選中的，切換到第一個
                                setActiveSymbol(prevActive =>
                                    prevActive === symbol
                                        ? (remaining.length > 0 ? remaining[0].symbol : null)
                                        : prevActive
                                );
                                return remaining;
                            });
                            setTicksMap(prev => { const next = {...prev}; delete next[symbol]; return next; });
                            setStatsMap(prev => { const next = {...prev}; delete next[symbol]; return next; });
                        }
                    }
                });

                // 請求同步目前監控狀態
                client.send('/app/tick/sync', {}, '{}');

            }, (error) => {
                console.error('WebSocket 連線失敗:', error);
                setConnected(false);
            });

            return () => {
                if (client && client.connected) {
                    client.disconnect();
                }
            };
        }, []);

        // 股票名稱快取
        const stockNameCache = useRef({});

        // 從 API 取得股票名稱 (有快取)
        const fetchStockName = async (symbol) => {
            if (stockNameCache.current[symbol]) {
                return stockNameCache.current[symbol];
            }
            try {
                const res = await fetch('/api/stock/list');
                const stocks = await res.json();
                // 快取所有股票名稱
                stocks.forEach(s => { stockNameCache.current[s.symbol] = s.name; });
                return stockNameCache.current[symbol] || symbol;
            } catch (e) {
                return symbol;
            }
        };

        // 訂閱股票的 WebSocket 頻道 (內部使用)
        const subscribeToSymbolChannel = async (client, symbol) => {
            if (subscriptionsRef.current[symbol]) return;

            const subscription = client.subscribe(`/topic/ticks/${symbol}`, (message) => {
                const data = JSON.parse(message.body);

                if (data.type === 'TICK') {
                    setTicksMap(prev => ({
                        ...prev,
                        [symbol]: [...(prev[symbol] || []).slice(-199), data.data]
                    }));
                    updateStats(symbol, data.data);
                } else if (data.type === 'STATS') {
                    setStatsMap(prev => ({ ...prev, [symbol]: data.data }));
                } else if (data.type === 'BIG_TRADE') {
                    setBigTrades(prev => [...prev.slice(-99), { ...data.data, symbol: data.symbol, lots: data.lots }]);
                } else if (data.type === 'SUBSCRIBE_RESULT' || data.type === 'UNSUBSCRIBE_RESULT') {
                    // 這些訊息由 /topic/tick-status 處理，此處忽略
                }
            });

            subscriptionsRef.current[symbol] = subscription;

            // 立即設定為當前選中 (不等待 API)
            setActiveSymbol(prev => prev || symbol);

            // 從 API 取得股票名稱並加入本地監控列表
            const name = await fetchStockName(symbol);
            setMonitoredStocks(prev => {
                if (prev.find(s => s.symbol === symbol)) return prev;
                return [...prev, { symbol, name }];
            });
        };

        // 訂閱股票 (用戶主動點擊)
        const subscribeStock = useCallback((symbol) => {
            if (!stompClient || !stompClient.connected) return;
            if (subscriptionsRef.current[symbol]) return;

            subscribeToSymbolChannel(stompClient, symbol);

            // 發送訂閱請求到後端 (會廣播給所有人)
            stompClient.send(`/app/tick/subscribe/${symbol}`, {}, '{}');
        }, [stompClient]);

        // 取消訂閱股票 (用戶主動點擊)
        const unsubscribeStock = useCallback((symbol) => {
            if (!stompClient || !stompClient.connected) return;

            // 發送取消訂閱請求到後端 (會廣播給所有人，包括自己)
            // 本地清理會在收到 UNSUBSCRIBE_RESULT 時進行
            stompClient.send(`/app/tick/unsubscribe/${symbol}`, {}, '{}');
        }, [stompClient]);

        // 更新即時統計
        const updateStats = (symbol, tick) => {
            setStatsMap(prev => {
                const stats = prev[symbol] || {
                    symbol,
                    totalTicks: 0,
                    totalVolume: 0,
                    buyVolume: 0,
                    sellVolume: 0,
                    buyRatio: 50,
                    avgPrice: 0,
                    totalAmount: 0 // 新增：總成交金額
                };

                // 如果是從後端同步來的 stats，可能沒有 totalAmount，需反推
                if (stats.totalAmount === undefined && stats.avgPrice && stats.totalVolume) {
                    stats.totalAmount = stats.avgPrice * stats.totalVolume;
                }

                const tickVolume = tick.volume || 0;
                const tickPrice = tick.price || 0;
                const tradeAmount = tickPrice * tickVolume;

                const newTotalVolume = (stats.totalVolume || 0) + tickVolume;
                const newTotalAmount = (stats.totalAmount || 0) + tradeAmount;
                
                const newBuyVolume = (stats.buyVolume || 0) + (tick.tickType === 'BUY' ? tickVolume : 0);
                const newSellVolume = (stats.sellVolume || 0) + (tick.tickType === 'SELL' ? tickVolume : 0);
                const totalBuySell = newBuyVolume + newSellVolume;

                const newAvgPrice = newTotalVolume > 0 ? newTotalAmount / newTotalVolume : 0;

                return {
                    ...prev,
                    [symbol]: {
                        ...stats,
                        totalTicks: (stats.totalTicks || 0) + 1,
                        totalVolume: newTotalVolume,
                        totalAmount: newTotalAmount,
                        buyVolume: newBuyVolume,
                        sellVolume: newSellVolume,
                        buyRatio: totalBuySell > 0 ? (newBuyVolume / totalBuySell) * 100 : 50,
                        avgPrice: newAvgPrice,
                        lastPrice: tick.price,
                        highPrice: stats.highPrice ? Math.max(parseFloat(stats.highPrice), parseFloat(tick.price)) : tick.price,
                        lowPrice: stats.lowPrice ? Math.min(parseFloat(stats.lowPrice), parseFloat(tick.price)) : tick.price
                    }
                };
            });
        };

        // 新增股票 (全局共享)
        const handleAddStock = (stock) => {
            if (monitoredStocks.find(s => s.symbol === stock.symbol)) {
                setActiveSymbol(stock.symbol);
                return;
            }

            if (subscribed >= maxSubscriptions) {
                alert(`已達訂閱上限 (${maxSubscriptions} 檔)`);
                return;
            }

            // 先加入本地 (帶有完整股票資訊)
            setMonitoredStocks(prev => [...prev, stock]);
            setActiveSymbol(stock.symbol);
            // 發送訂閱請求，會廣播給所有人
            subscribeStock(stock.symbol);
        };

        // 移除股票 (全局共享)
        const handleRemoveStock = (symbol) => {
            // 只發送取消訂閱請求，清理工作由全局狀態處理器完成
            unsubscribeStock(symbol);

            // 切換顯示的股票
            if (activeSymbol === symbol) {
                const remaining = monitoredStocks.filter(s => s.symbol !== symbol);
                setActiveSymbol(remaining.length > 0 ? remaining[0].symbol : null);
            }
        };

        const currentTicks = activeSymbol ? (ticksMap[activeSymbol] || []) : [];
        const currentStats = activeSymbol ? (statsMap[activeSymbol] || null) : null;

        return (
            <div className="min-h-screen bg-gray-100">
                {/* Header */}
                <header className="bg-white shadow-sm">
                    <div className="max-w-7xl mx-auto px-4 py-4">
                        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <h1 className="text-2xl font-bold text-gray-800">即時成交明細監控</h1>
                            <ConnectionStatus
                                connected={connected}
                                fugleReady={fugleReady}
                                subscribed={subscribed}
                                maxSubscriptions={maxSubscriptions}
                            />
                        </div>
                    </div>
                </header>

                {/* Main Content */}
                <main className="max-w-7xl mx-auto px-4 py-6">
                    {/* 搜尋與標籤 */}
                    <div className="bg-white rounded-lg shadow p-4 mb-6">
                        <div className="mb-4">
                            <StockSearch
                                onSelect={handleAddStock}
                                disabled={!connected || subscribed >= maxSubscriptions}
                            />
                        </div>

                        {monitoredStocks.length > 0 && (
                            <div className="flex flex-wrap gap-2">
                                {monitoredStocks.map(stock => (
                                    <StockTag
                                        key={stock.symbol}
                                        symbol={stock.symbol}
                                        name={stock.name}
                                        isActive={activeSymbol === stock.symbol}
                                        onClick={() => setActiveSymbol(stock.symbol)}
                                        onRemove={() => handleRemoveStock(stock.symbol)}
                                    />
                                ))}
                            </div>
                        )}

                        {!connected && (
                            <div className="mt-4 p-3 bg-red-50 text-red-600 rounded-lg text-sm">
                                WebSocket 未連線，請重新整理頁面
                            </div>
                        )}
                        {connected && !fugleReady && (
                            <div className="mt-4 p-3 bg-yellow-50 text-yellow-700 rounded-lg text-sm">
                                Fugle 即時數據源連線中，訂閱的股票將在連線完成後自動生效...
                            </div>
                        )}
                        {errorMsg && (
                            <div className="mt-4 p-3 bg-red-50 text-red-600 rounded-lg text-sm">
                                {errorMsg}
                            </div>
                        )}
                    </div>

                    {/* 主要面板 */}
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                        {/* 內外盤統計 */}
                        <div className="lg:col-span-1">
                            <TickStatsPanel stats={currentStats} />
                        </div>

                        {/* 成交明細 */}
                        <div className="lg:col-span-2">
                            <TickList ticks={currentTicks} symbol={activeSymbol} />
                        </div>
                    </div>

                    {/* 大單警示 */}
                    <BigTradePanel bigTrades={bigTrades} />
                </main>

                {/* Footer */}
                <footer className="bg-white border-t border-gray-200 mt-8">
                    <div className="max-w-7xl mx-auto px-4 py-4 text-center text-sm text-gray-500">
                        <p>即時數據來源：Fugle API | 免費版限制：最多訂閱 5 檔</p>
                        <p className="mt-1">需設定 FUGLE_API_KEY 環境變數</p>
                    </div>
                </footer>
            </div>
        );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
