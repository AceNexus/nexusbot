<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股籌碼區間統計 (NexusBot)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        .text-up { color: #dc2626; }
        .text-down { color: #16a34a; }
        .bg-up-light { background-color: rgba(220, 38, 38, 0.05); }
        .bg-down-light { background-color: rgba(22, 163, 74, 0.05); }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen p-4 md:p-8">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const App = () => {
            const [symbol, setSymbol] = useState("2330");
            const [startDate, setStartDate] = useState(() => {
                const d = new Date();
                d.setDate(d.getDate() - 30);
                return d.toISOString().split('T')[0];
            });
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [data, setData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);

            const fetchData = async () => {
                setLoading(true);
                setError(null);
                try {
                    const res = await fetch(`/api/stock/${symbol}/institutional-investors/range?startDate=${startDate}&endDate=${endDate}`);
                    if (!res.ok) throw new Error("查詢失敗");
                    const result = await res.json();
                    setData(result);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const getColorClass = (val) => {
                if (!val || val === 0) return "text-gray-500";
                return val > 0 ? "text-up" : "text-down";
            };

            const formatNum = (val) => {
                if (val === undefined || val === null) return "--";
                return (val > 0 ? "+" : "") + val.toLocaleString();
            };

            return (
                <div className="max-w-4xl mx-auto space-y-6">
                    <header className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                        <h1 className="text-2xl font-bold text-slate-800 mb-6">籌碼區間累計統計</h1>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div>
                                <label className="block text-sm font-medium text-slate-500 mb-1">股票代號或名稱</label>
                                <input 
                                    type="text" 
                                    className="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={symbol}
                                    placeholder="例如：2330 或 台積電"
                                    onChange={e => setSymbol(e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-500 mb-1">開始日期</label>
                                <input 
                                    type="date" 
                                    className="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={startDate}
                                    onChange={e => setStartDate(e.target.value)}
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-500 mb-1">結束日期</label>
                                <input 
                                    type="date" 
                                    className="w-full px-4 py-2 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"
                                    value={endDate}
                                    onChange={e => setEndDate(e.target.value)}
                                />
                            </div>
                            <button 
                                onClick={fetchData}
                                disabled={loading}
                                className="bg-blue-600 text-white px-6 py-2 rounded-xl font-medium hover:bg-blue-700 transition-colors disabled:bg-blue-300"
                            >
                                {loading ? "查詢中..." : "開始統計"}
                            </button>
                        </div>
                    </header>

                    {error && (
                        <div className="bg-red-50 text-red-600 p-4 rounded-xl border border-red-100">
                            {error}
                        </div>
                    )}

                    {data && data.summary && (
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            {[
                                { label: "外資累計", value: data.summary.foreign },
                                { label: "投信累計", value: data.summary.trust },
                                { label: "自營累計", value: data.summary.dealer },
                                { label: "三大法人合計", value: data.summary.total, highlight: true }
                            ].map((item, idx) => (
                                <div key={idx} className={`bg-white p-5 rounded-2xl shadow-sm border ${item.highlight ? 'border-blue-200 bg-blue-50/30' : 'border-slate-100'}`}>
                                    <div className="text-sm text-slate-500 mb-1">{item.label}</div>
                                    <div className={`text-xl font-bold font-mono ${getColorClass(item.value)}`}>
                                        {formatNum(item.value)} <span className="text-xs font-normal text-slate-400 ml-1">張</span>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {data && data.daily && (
                        <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                            <div className="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                                <h2 className="font-bold text-slate-700">每日明細 ({data.summary.name})</h2>
                                <span className="text-xs text-slate-400">共 {data.daily.length} 個交易日</span>
                            </div>
                            <div className="overflow-x-auto custom-scrollbar">
                                <table className="w-full text-sm">
                                    <thead className="bg-slate-50 text-slate-500 text-left">
                                        <tr>
                                            <th className="px-6 py-3 font-medium">日期</th>
                                            <th className="px-6 py-3 font-medium text-right">外資</th>
                                            <th className="px-6 py-3 font-medium text-right">投信</th>
                                            <th className="px-6 py-3 font-medium text-right">自營</th>
                                            <th className="px-6 py-3 font-medium text-right bg-slate-100/50">合計</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y divide-slate-100">
                                        {data.daily.map((day, idx) => (
                                            <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                                <td className="px-6 py-3 font-mono text-slate-600">{day.date}</td>
                                                <td className={`px-6 py-3 text-right font-mono ${getColorClass(day.foreignInvestorBuySell)}`}>
                                                    {formatNum(day.foreignInvestorBuySell)}
                                                </td>
                                                <td className={`px-6 py-3 text-right font-mono ${getColorClass(day.investmentTrustBuySell)}`}>
                                                    {formatNum(day.investmentTrustBuySell)}
                                                </td>
                                                <td className={`px-6 py-3 text-right font-mono ${getColorClass(day.dealerBuySell)}`}>
                                                    {formatNum(day.dealerBuySell)}
                                                </td>
                                                <td className={`px-6 py-3 text-right font-mono font-bold bg-slate-50/30 ${getColorClass(day.totalBuySell)}`}>
                                                    {formatNum(day.totalBuySell)}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
